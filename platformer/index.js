!function webpackUniversalModuleDefinition(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.appLibrary=e():t.appLibrary=e()}(this,(function(){return(()=>{"use strict";var t={d:(e,i)=>{for(var o in i)t.o(i,o)&&!t.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:i[o]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{KeyboardState:()=>C});class Vector{constructor(t=0,e=0){this.x=t,this.y=e}setFromElements(t,e){return this.x=t,this.y=e,this}setFromVector(t){return this.x=t.x,this.y=t.y,this}add(t){return this.x+=t.x,this.y+=t.y,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this}mulNumber(t){return this.x*=t,this.y*=t,this}applyMatrix(t){const{x:e,y:i}=this;return this.x=e*t[0]+i*t[2]+t[4],this.y=e*t[1]+i*t[3]+t[5],this}}class System{constructor(t){this.core=t}}var i,o,s,__classPrivateFieldGet=function(t,e,i,o){if("a"===i&&!o)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!o:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?o:"a"===i?o.call(t):o?o.value:e.get(t)};class AnimationSystem extends System{constructor(){super(...arguments),i.add(this),this.animations=new Map}update(){for(const t of this.core.getComponentStorage("animator"))!1!==t.enabled&&__classPrivateFieldGet(this,i,"m",s).call(this,t)}async loadAnimation(t){const e=await fetch(t);if(!1===e.ok)throw new Error(e.status.toString());const s=await e.json(),n=[];for(const t of s.frames)n.push(__classPrivateFieldGet(this,i,"m",o).call(this,t));const r=await Promise.all(n),a={name:s.name,duration:s.duration,frames:r};return this.animations.set(a.name,a),a}setAnimation(t,e,i=!0){const o=this.animations.get(e);if(void 0===o)throw new Error("Animation not found");t.animation=o,i&&(t.start=this.core.time)}}i=new WeakSet,o=async function _AnimationSystem_loadImage(t){return new Promise(((e,i)=>{const o=new Image;o.addEventListener("load",(()=>e(o))),o.addEventListener("error",(t=>i(t))),o.src=t}))},s=function _AnimationSystem_calculateAnimation(t){const e=(this.core.time-t.start)*t.scale,i=Math.floor(e/t.animation.duration%1*t.animation.frames.length);t.mesh.img=t.animation.frames[i]};class Camera{constructor(){this.x=0,this.y=0,this.zoom=1,this.width=1,this.height=1}worldToScreenPosition(t,e){const i=this.zoom*this.height*.5;return e.x=.5*this.width+(t.x-this.x)*i,e.y=.5*this.height-(t.y-this.y)*i,e}worldToScreenSize(t,e){const i=this.zoom*this.height*.5;return e.x=t.x*i,e.y=t.y*i,e}worldToScreenSizeNumber(t){return t*this.zoom*this.height*.5}}var n,r,a,h,c,d,physics_system_classPrivateFieldGet=function(t,e,i,o){if("a"===i&&!o)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!o:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?o:"a"===i?o.call(t):o?o.value:e.get(t)};!function(t){t.AABB="aabb",t.CIRCLE="circle"}(c||(c={})),function(t){t[t.ENVIRONMENT=0]="ENVIRONMENT",t[t.COLLIDER=1]="COLLIDER",t[t.RIGID=2]="RIGID"}(d||(d={}));class PhysicsSystem extends System{constructor(){super(...arguments),n.add(this),this.collisions=[],this.gravity=new Vector(0,0)}update(){const t=this.core.dt;this.collisions.length=0;const e=this.core.getComponentStorage("phy");for(const t of e)t.hits.length=0;for(const e of this.core.entities)0!==e.invMass&&(e.velocity.addScaledVector(e.force,e.invMass*t),e.velocity.addScaledVector(this.gravity,t)),e.position.addScaledVector(e.velocity,t),e.force.setFromElements(0,0);for(let t=0;t<e.length;t++)for(let i=t+1;i<e.length;i++){const o=e[t],s=e[i];if(o.conf===d.ENVIRONMENT&&s.conf===d.ENVIRONMENT)continue;if(o.owner===s.owner)continue;switch(o.type+s.type){case"aabbaabb":physics_system_classPrivateFieldGet(this,n,"m",r).call(this,o,s);break;case"aabbcircle":physics_system_classPrivateFieldGet(this,n,"m",a).call(this,o,s);break;case"circleaabb":physics_system_classPrivateFieldGet(this,n,"m",a).call(this,s,o);break;case"circlecircle":physics_system_classPrivateFieldGet(this,n,"m",h).call(this,o,s);break;default:throw new Error("Unknown ShapePair")}}const i=new Vector,o=new Vector;for(const t of this.collisions){const{shape1:e,shape2:s,depth:n,normal:r}=t;i.x=s.owner.velocity.x-e.owner.velocity.x,i.y=s.owner.velocity.y-e.owner.velocity.y;const a=i.x*r.x+i.y*r.y;if(a>0)continue;let h=-(1+Math.min(e.reduction,s.reduction))*a;h/=e.owner.invMass+s.owner.invMass,o.x=h*r.x,o.y=h*r.y,e.conf===d.RIGID&&s.conf!==d.COLLIDER&&(e.owner.velocity.addScaledVector(o,-e.owner.invMass),e.owner.position.addScaledVector(r,.2*-n)),s.conf===d.RIGID&&e.conf!==d.COLLIDER&&(s.owner.velocity.addScaledVector(o,s.owner.invMass),s.owner.position.addScaledVector(r,.2*n))}}}n=new WeakSet,r=function _PhysicsSystem_AABBToAABB(t,e){},a=function _PhysicsSystem_AABBToCircle(t,e){let i=e.owner.position.x+e.offset.x-(t.owner.position.x+t.offset.x),o=e.owner.position.y+e.offset.y-(t.owner.position.y+t.offset.y),s=Math.min(Math.abs(i),t.half.x)*Math.sign(i),n=Math.min(Math.abs(o),t.half.y)*Math.sign(o);const r=Math.abs(i)-t.half.x,a=Math.abs(o)-t.half.y;r<0&&a<0&&(r>a?i=t.half.x*Math.sign(i):o=t.half.y*Math.sign(o));const h=i-s,c=o-n,d=Math.max(Math.sqrt(h*h+c*c),1e-5),l=e.radius-d;if(l<0)return;const m=h/d,y=c/d;r<0&&a<0&&(s=i,n=o),t.hits.push(e),e.hits.push(t),this.collisions.push({shape1:t,shape2:e,depth:l,normal:new Vector(m,y),point1:new Vector(s+t.owner.position.x+t.offset.x,n+t.owner.position.y+t.offset.y),point2:new Vector(-m*e.radius+e.owner.position.x+e.offset.x,-y*e.radius+e.owner.position.y+e.offset.y)})},h=function _PhysicsSystem_circleToCircle(t,e){const i=e.owner.position.x+e.offset.x-(t.owner.position.x+t.offset.x),o=e.owner.position.y+e.offset.y-(t.owner.position.y+t.offset.y),s=Math.max(Math.sqrt(i*i+o*o),1e-5),n=t.radius+e.radius-s;if(n<0)return;const r=i/s,a=o/s;t.hits.push(e),e.hits.push(t),this.collisions.push({shape1:t,shape2:e,depth:n,normal:new Vector(r,a),point1:new Vector(r*t.radius+t.owner.position.x+t.offset.x,a*t.radius+t.owner.position.y+t.offset.y),point2:new Vector(-r*e.radius+e.owner.position.x+e.offset.x,-a*e.radius+e.owner.position.y+e.offset.y)})};var l,m,y,w,f,p,u,g,draw_system_classPrivateFieldGet=function(t,e,i,o){if("a"===i&&!o)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!o:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?o:"a"===i?o.call(t):o?o.value:e.get(t)};const S=new Vector,x={[d.ENVIRONMENT]:{fill:"#00ff0007",stroke:"#00ff00"},[d.COLLIDER]:{fill:"#ffaf0007",stroke:"#ffaf00"},[d.RIGID]:{fill:"#ff000007",stroke:"#ff0000"}};function sort(t,e){return t.zIndex-e.zIndex}class DrawSystem extends System{constructor(t){super(t),l.add(this),this.camera=new Camera,m.set(this,[]),this.updateQueue=!1,this.zoom=1,this.position=new Vector,this.width=1,this.height=1,this.clearColor="#333333",this.drawAABB=!1,this.drawCircle=!1;const e=document.createElement("canvas");document.body.appendChild(e),e.style.width="100%",e.style.height="100%";const i=e.getContext("2d");if(null===i)throw new Error("Error");this.ctx=i,this.canvas=e}update(){draw_system_classPrivateFieldGet(this,l,"m",y).call(this),draw_system_classPrivateFieldGet(this,l,"m",w).call(this);const t=this.ctx;if(t.fillStyle=this.clearColor,t.fillRect(0,0,this.width,this.height),this.updateQueue){draw_system_classPrivateFieldGet(this,m,"f").length=0;for(const t of this.core.getComponentStorage("mesh"))t.visibility&&draw_system_classPrivateFieldGet(this,m,"f").push(t);draw_system_classPrivateFieldGet(this,m,"f").sort(sort)}for(const t of draw_system_classPrivateFieldGet(this,m,"f"))draw_system_classPrivateFieldGet(this,l,"m",g).call(this,t);for(const t of this.core.getComponentStorage("phy"))switch(t.type){case c.AABB:this.drawAABB&&draw_system_classPrivateFieldGet(this,l,"m",p).call(this,t);break;case c.CIRCLE:this.drawCircle&&draw_system_classPrivateFieldGet(this,l,"m",u).call(this,t);break;default:throw new Error("Unknown ShapeType")}if(!1!==this.drawAABB&&!1!==this.drawCircle)for(const t of this.core.physicsSystem.collisions)draw_system_classPrivateFieldGet(this,l,"m",f).call(this,t.point1.x,t.point1.y),draw_system_classPrivateFieldGet(this,l,"m",f).call(this,t.point2.x,t.point2.y)}getImage(t){const e=new Image;return e.src=t,e}}m=new WeakMap,l=new WeakSet,y=function _DrawSystem_updateSize(){this.width=document.body.clientWidth,this.height=document.body.clientHeight,this.canvas.width=this.width,this.canvas.height=this.height},w=function _DrawSystem_updateCamera(){this.camera.width=this.width,this.camera.height=this.height,this.camera.x=this.position.x,this.camera.y=this.position.y,this.camera.zoom=this.zoom},f=function _DrawSystem_drawPoint(t,e,i="#ffffff"){const{ctx:o,camera:s}=this;S.setFromElements(t,e);const{x:n,y:r}=s.worldToScreenPosition(S,S);o.strokeStyle=i,o.strokeRect(n-.5,r-.5,2,2)},p=function _DrawSystem_darwAABB(t){const{ctx:e,camera:i}=this;S.setFromVector(t.owner.position).add(t.offset);const{x:o,y:s}=i.worldToScreenPosition(S,S),{x:n,y:r}=i.worldToScreenSize(t.half,S);e.strokeStyle=x[t.conf].stroke,e.fillStyle=x[t.conf].fill,e.fillRect(o-n,s-r,2*n,2*r),e.strokeRect(o-n,s-r,2*n,2*r),e.strokeRect(o-.5,s-.5,2,2),e.font="16px serif",e.fillStyle=x[t.conf].stroke,e.fillText(t.owner.name+" : "+t.name,o-n+8,s-r+16)},u=function _DrawSystem_darwCircle(t){const{ctx:e,camera:i}=this;S.setFromVector(t.owner.position).add(t.offset);const{x:o,y:s}=i.worldToScreenPosition(S,S),n=i.worldToScreenSizeNumber(t.radius);e.strokeStyle=x[t.conf].stroke,e.fillStyle=x[t.conf].fill,e.beginPath(),e.arc(o,s,n,0,2*Math.PI),e.fill(),e.stroke(),e.strokeRect(o-.5,s-.5,2,2)},g=function _DrawSystem_darwImage(t){const{ctx:e,camera:i}=this,{x:o,y:s}=i.worldToScreenPosition(t.position,S),{x:n,y:r}=i.worldToScreenSize(t.size,S);t.flip?(e.save(),e.translate(this.width+(t.position.x-i.x)*i.zoom*this.height,0),e.scale(-1,1),e.drawImage(t.img,o-.5*n,s-.5*r,n,r),e.restore()):e.drawImage(t.img,o-.5*n,s-.5*r,n,r)};var b,v,E,C,__classPrivateFieldSet=function(t,e,i,o,s){if("m"===o)throw new TypeError("Private method is not writable");if("a"===o&&!s)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof e?t!==e||!s:!e.has(t))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===o?s.call(t,i):s?s.value=i:e.set(t,i),i},core_classPrivateFieldGet=function(t,e,i,o){if("a"===i&&!o)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof e?t!==e||!o:!e.has(t))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?o:"a"===i?o.call(t):o?o.value:e.get(t)};v=new WeakMap,b=new WeakSet,E=function _Core_addComponent(t,e){let i=this.components.get(e.storage);return void 0===i&&(i=[],this.components.set(e.storage,i)),i.push(e),t.components.add(e),e};class Player{constructor(t,e){this.direction=!0,this.hitTime=0,this.respawn=new Vector,this.onDamage=()=>{},this.entity=t.createEntity("player",new Vector,1),this.mesh=t.addMeshComponent(this.entity,"./res/player.png",this.entity.position,new Vector(3,3),1),this.hitMesh=t.addMeshComponent(this.entity,"./res/player_hit.png",this.entity.position,new Vector(4,4),2),this.animator=t.addAnimatorComponent(this.entity,"player-idle",this.mesh),this.rigidBody=t.addPhyCircleComponent("player",this.entity,new Vector,.75,d.RIGID),this.hitCollider=t.addPhyCircleComponent("player_hit",this.entity,new Vector(1.2,0),.6,d.COLLIDER),this.groundCollider=t.addPhyCircleComponent("player",this.entity,new Vector(0,-.45),.6,d.COLLIDER),this.rigidBody.reduction=.1,this.hitMesh.visibility=!1,this.respawn.setFromVector(e),this.entity.position.setFromVector(e)}update(t,e){t.animationSystem.setAnimation(this.animator,"player-idle",!1),e&C.LEFT&&(this.entity.velocity.x-=120*t.dt,this.mesh.flip=!0,this.hitMesh.flip=!0,this.hitCollider.offset.x=-1.2,t.animationSystem.setAnimation(this.animator,"player-run",!1)),e&C.RIGHT&&(this.entity.velocity.x+=120*t.dt,this.mesh.flip=!1,this.hitMesh.flip=!1,this.hitCollider.offset.x=1.2,t.animationSystem.setAnimation(this.animator,"player-run",!1));let i=!1,o=!1;for(const t of this.groundCollider.hits)"trap"===t.owner.name&&(i=!0),"ground"===t.owner.name&&(o=!0);e&C.UP&&o&&(this.entity.velocity.y+=600*t.dt),e&C.DOWN&&(this.entity.velocity.y-=20*t.dt),this.entity.velocity.x*=.8,i&&(this.entity.position.setFromVector(this.respawn),this.entity.velocity.setFromElements(0,0),this.entity.force.setFromElements(0,0)),e&C.HIT&&(this.hitTime=t.time,this.hitMesh.visibility=!0,t.drawSystem.updateQueue=!0,"walker"===this.hitCollider.hits[0]?.owner.name&&this.onDamage(this.hitCollider.hits[0].owner)),t.time-this.hitTime>=.1&&(this.hitMesh.visibility=!1,t.drawSystem.updateQueue=!0)}}class Walker{constructor(t,e,i){this.direction=!0,this.stopTime=0,this.health=30,this.entity=t.createEntity("walker",new Vector(e,i),1),this.mesh=t.addMeshComponent(this.entity,"./res/walker.png",this.entity.position,new Vector(2,2),.5),this.animator=t.addAnimatorComponent(this.entity,"walker-walk",this.mesh),this.rigidBody=t.addPhyCircleComponent("body",this.entity,new Vector,.5,d.RIGID),this.rigidBody.reduction=.5,this.oldXPosition=e}update(t){0!==this.health&&(Math.abs(this.oldXPosition-this.entity.position.x)/t.dt<.5&&(this.direction=!this.direction),this.oldXPosition=this.entity.position.x,0!==this.stopTime?(this.entity.velocity.x=0,this.stopTime=Math.max(0,this.stopTime-t.dt),this.animator.enabled=!1):(this.entity.velocity.x=this.direction?-2:2,this.mesh.flip=this.direction,this.animator.enabled=!0))}damage(t){this.stopTime=3,this.entity.velocity.setFromElements(0,5),this.health=Math.max(0,this.health-t),0===this.health&&(this.rigidBody.conf=d.COLLIDER,this.entity.velocity.setFromElements(0,0),this.entity.invMass=0,this.mesh.position.y-=.4,this.mesh.size.y=.9,this.animator.enabled=!1)}}!function(t){t[t.LEFT=1]="LEFT",t[t.RIGHT=2]="RIGHT",t[t.UP=4]="UP",t[t.DOWN=8]="DOWN",t[t.HIT=16]="HIT"}(C||(C={}));const k=new class Core{constructor(){b.add(this),this.entities=new Set,this.components=new Map,v.set(this,void 0),this.time=0,this.dt=0,this.onUpdate=()=>{},__classPrivateFieldSet(this,v,performance.now(),"f"),this.time=.001*core_classPrivateFieldGet(this,v,"f"),this.drawSystem=new DrawSystem(this),this.physicsSystem=new PhysicsSystem(this),this.animationSystem=new AnimationSystem(this);const loop=t=>{this.dt=.001*(t-core_classPrivateFieldGet(this,v,"f")),__classPrivateFieldSet(this,v,t,"f"),this.time+=this.dt,this.onUpdate(),this.physicsSystem.update(),this.animationSystem.update(),this.drawSystem.update(),requestAnimationFrame(loop)};requestAnimationFrame(loop)}createEntity(t,e,i=0,o=[]){const s={name:t,tags:new Set(o),force:new Vector,invMass:i,velocity:new Vector,position:e,components:new Set};return this.entities.add(s),s}deleteEntity(t){for(const e of t.components){const t=this.components.get(e.storage);if(void 0===t)throw new Error("Storage not exist");const i=t.indexOf(e);t[i]=t[t.length-1],t.length--}t.components.clear(),this.entities.delete(t)}getComponentStorage(t){return this.components.get(t)??[]}deleteComponent(t){t.owner.components.delete(t);const e=this.components.get(t.storage);if(void 0===e)throw new Error("Storage not exist");const i=e.indexOf(t);e[i]=e[e.length-1],e.length--}addMeshComponent(t,e,i,o,s=0){return core_classPrivateFieldGet(this,b,"m",E).call(this,t,{storage:"mesh",type:"mesh",owner:t,img:this.drawSystem.getImage(e),size:o,position:i,visibility:!0,flip:!1,zIndex:s})}addPhyAABBComponent(t,e,i,o,s=d.ENVIRONMENT){return core_classPrivateFieldGet(this,b,"m",E).call(this,e,{storage:"phy",type:"aabb",name:t,owner:e,conf:s,reduction:1,offset:i,half:o,hits:[]})}addPhyCircleComponent(t,e,i,o,s=d.ENVIRONMENT){return core_classPrivateFieldGet(this,b,"m",E).call(this,e,{storage:"phy",type:"circle",name:t,owner:e,conf:s,reduction:1,offset:i,radius:o,hits:[]})}addAnimatorComponent(t,e,i){const o=this.animationSystem.animations.get(e);if(void 0===o)throw new Error("Animation not found");return core_classPrivateFieldGet(this,b,"m",E).call(this,t,{storage:"animator",type:"animator",owner:t,animation:o,enabled:!0,start:0,scale:1,mesh:i})}};let T=0;window.core=k,k.physicsSystem.gravity.setFromElements(0,-40),k.drawSystem.zoom=.13,k.drawSystem.clearColor="#8e7f6e";const A=new URLSearchParams(window.location.search).get("lvl")??"junk_pit",M=[];return async function loadLevel(t){const e=await fetch(t);if(!1===e.ok)throw new Error(e.status.toString());const i=await e.json(),o=new Map;await k.animationSystem.loadAnimation("./res/walker-walk.anim.json"),await k.animationSystem.loadAnimation("./res/player-idle.anim.json"),await k.animationSystem.loadAnimation("./res/player-run.anim.json");const s=k.createEntity("background",new Vector);for(const t of i.bgs){const{url:e,x:i,y:o,w:n,h:r}=t;k.addMeshComponent(s,e,new Vector(i,o),new Vector(n,r))}k.drawSystem.updateQueue=!0;for(const t of i.nodes){const{name:e,cx:i,cy:s}=t;o.set(e,k.createEntity(e,new Vector(i,s)))}for(const t of i.aabbs){const{name:e,node:i,ox:s,oy:n,sx:r,sy:a,conf:h}=t,c=o.get(i);if(void 0===c)throw new Error("Unknown node");k.addPhyAABBComponent(e,c,new Vector(s,n),new Vector(.5*r,.5*a),h)}for(const t of i.circles){const{name:e,node:i,ox:s,oy:n,r,conf:a}=t,h=o.get(i);if(void 0===h)throw new Error("Unknown node");k.addPhyCircleComponent(e,h,new Vector(s,n),r,a)}for(const t of i.walkers)M.push(new Walker(k,t.x,t.y));return new Vector(i.respawn.x,i.respawn.y)}(`./res/${A}.lvl.json`).then((t=>{const e=new Player(k,t);e.onDamage=t=>{for(const e of M)if(e.entity===t)return void e.damage(10)},k.onUpdate=()=>{e.update(k,T),T&=~C.HIT;for(const t of M)t.update(k);k.drawSystem.position.setFromVector(e.entity.position)}})),document.body.addEventListener("keydown",(t=>{switch(t.code){case"KeyA":case"ArrowLeft":T|=C.LEFT;break;case"KeyD":case"ArrowRight":T|=C.RIGHT;break;case"Space":case"ArrowUp":T|=C.UP;break;case"ArrowDown":T|=C.DOWN;break;case"Enter":T|=C.HIT}})),document.body.addEventListener("keyup",(t=>{switch(t.code){case"KeyA":case"ArrowLeft":T&=~C.LEFT;break;case"KeyD":case"ArrowRight":T&=~C.RIGHT;break;case"Space":case"ArrowUp":T&=~C.UP;break;case"ArrowDown":T&=~C.DOWN;break;case"Numpad0":k.drawSystem.zoom=.13===k.drawSystem.zoom?.05:.13;break;case"Numpad1":k.drawSystem.zoom=.02;break;case"KeyC":k.drawSystem.drawAABB=!k.drawSystem.drawAABB,k.drawSystem.drawCircle=!k.drawSystem.drawCircle}})),document.body.addEventListener("click",(t=>{const e=(t.clientX/k.drawSystem.height*2-k.drawSystem.width/k.drawSystem.height)/k.drawSystem.zoom+k.drawSystem.camera.x,i=(1-t.clientY/k.drawSystem.height*2)/k.drawSystem.zoom+k.drawSystem.camera.y,o=new Walker(k,e,i);o.animator.start=k.time,M.push(o)})),e})()}));