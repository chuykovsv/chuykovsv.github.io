!function(t){var e={};function s(i){if(e[i])return e[i].exports;var r=e[i]={i:i,l:!1,exports:{}};return t[i].call(r.exports,r,r.exports,s),r.l=!0,r.exports}s.m=t,s.c=e,s.d=function(t,e,i){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)s.d(i,r,function(e){return t[e]}.bind(null,r));return i},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="D:\\$WEB\\prototype\\dist",s(s.s=0)}([function(t,e,s){"use strict";s.r(e);const i=Symbol("gl"),r=Symbol("ext"),n=Symbol("dom"),o=Symbol("gldom"),h=Symbol("uidom"),a=Symbol("raf"),l=Symbol("res"),m=Symbol("tags"),c=Symbol("comp"),u=Symbol("loop"),d=Symbol("event"),p=Symbol("state"),g=Symbol("owner"),y=Symbol("child"),w=Symbol("depth"),f=Symbol("entity"),_=Symbol("system"),x=Symbol("transform"),E=Symbol.for("name"),b=Symbol("new"),C=Symbol("del"),S=Symbol("modify"),L=Symbol("loader"),z=1<<31,v=1<<30,T=1<<29,A=1<<28;let R=null;const M=new Set;class V{constructor(t){this.core=t}load(t){return fetch(t).then(t=>t.text().then(t=>JSON.parse(t)))}parse(t){return Promise.resolve(t)}conf(t){return Promise.resolve(t)}}class U{constructor(t,e){this[p]=z,this[g]=t,e&&(this[p]|=v|T)}get owner(){return this[g]}get enable(){return!!(this[p]&v)}get disable(){return!(this[p]&v)}get hasEnable(){return!(!(this[p]&~v)||this[p]&~T)}get hasDisable(){return!(this[p]&~v||!(this[p]&~T))}get hasNeedsUpdate(){return!!(this[p]&~A)}set needsUpdate(t){t?this[p]|=A:this[p]&=~A}}class K{constructor(t,e){this[p]=z,this[g]=t,this[E]=null,this[m]=new Set,this[c]=new Map,this[y]=new Set,this[w]=t?t[w]+1:0,this[x]=null,e&&(this[p]|=v|T),null!==t&&t[y].add(this)}get owner(){return this[g]}get enable(){return!!(this[p]&v)}get child(){return this[y]}get depth(){return this[w]}get name(){return this[E]}set name(t){this[E]=t}addTag(t){this[m].add(t)}delTag(t){this[m].delete(t)}hasTag(t){return this[m].has(t)}getComp(t){return void 0===(R=this[c].get(t))&&(R=M),R}getCompOne(t){return void 0!==(R=this[c].get(t))&&([R]=R),void 0!==R?R:null}}let N=null;const P=Symbol.for("name");class O extends U{constructor(t,e,s){super(t,e),this.iid=-1,this.geometry=s.geometry,this.material=s.material,this.skeleton=void 0!==s.skeleton?s.skeleton:null}}O[P]="Mesh";let k=0,I=0,F=0,W=0,D=0,B=0,G=0,H=0,X=0,Y=0;const j=new Float32Array(16);class q extends Float32Array{constructor(){super(16),this[0]=1,this[5]=1,this[10]=1,this[15]=1}copy(t){for(Y=0;Y<16;Y++)this[Y]=t[Y];return this}identity(){for(Y=0;Y<16;Y++)this[Y]=Y%5==0?1:0;return this}perspective(t,e,s,i){return this.identity(),this[15]=0,this[14]=-2*i*s/(i-s),this[11]=1,this[10]=(i+s)/(i-s),this[5]=1/Math.tan(.5*t),this[0]=this[5]/e,this}orbit(t,e,s,i){const r=Math.cos(e),n=Math.sin(e),o=Math.cos(t),h=Math.sin(t);return this.identity(),this[0]=r,this[4]=0,this[8]=n,this[1]=n*h,this[5]=o,this[9]=-r*h,this[2]=-n*o,this[6]=h,this[10]=r*o,this[12]=s*(this[2]*this[0]+this[6]*this[4]+this[10]*this[8]),this[13]=s*(this[2]*this[1]+this[6]*this[5]+this[10]*this[9]),this[14]=s*(this[2]*this[2]+this[6]*this[6]+this[10]*this[10]),this[12]-=i.x*this[0]+i.y*this[4]+i.z*this[8],this[13]-=i.x*this[1]+i.y*this[5]+i.z*this[9],this[14]-=i.x*this[2]+i.y*this[6]+i.z*this[10],this}mul(t){for(j[0]=this[0]*t[0]+this[1]*t[4]+this[2]*t[8]+this[3]*t[12],j[1]=this[0]*t[1]+this[1]*t[5]+this[2]*t[9]+this[3]*t[13],j[2]=this[0]*t[2]+this[1]*t[6]+this[2]*t[10]+this[3]*t[14],j[3]=this[0]*t[3]+this[1]*t[7]+this[2]*t[11]+this[3]*t[15],j[4]=this[4]*t[0]+this[5]*t[4]+this[6]*t[8]+this[7]*t[12],j[5]=this[4]*t[1]+this[5]*t[5]+this[6]*t[9]+this[7]*t[13],j[6]=this[4]*t[2]+this[5]*t[6]+this[6]*t[10]+this[7]*t[14],j[7]=this[4]*t[3]+this[5]*t[7]+this[6]*t[11]+this[7]*t[15],j[8]=this[8]*t[0]+this[9]*t[4]+this[10]*t[8]+this[11]*t[12],j[9]=this[8]*t[1]+this[9]*t[5]+this[10]*t[9]+this[11]*t[13],j[10]=this[8]*t[2]+this[9]*t[6]+this[10]*t[10]+this[11]*t[14],j[11]=this[8]*t[3]+this[9]*t[7]+this[10]*t[11]+this[11]*t[15],j[12]=this[12]*t[0]+this[13]*t[4]+this[14]*t[8]+this[15]*t[12],j[13]=this[12]*t[1]+this[13]*t[5]+this[14]*t[9]+this[15]*t[13],j[14]=this[12]*t[2]+this[13]*t[6]+this[14]*t[10]+this[15]*t[14],j[15]=this[12]*t[3]+this[13]*t[7]+this[14]*t[11]+this[15]*t[15],Y=0;Y<16;Y++)this[Y]=j[Y];return this}premul(t){for(j[0]=t[0]*this[0]+t[1]*this[4]+t[2]*this[8]+t[3]*this[12],j[1]=t[0]*this[1]+t[1]*this[5]+t[2]*this[9]+t[3]*this[13],j[2]=t[0]*this[2]+t[1]*this[6]+t[2]*this[10]+t[3]*this[14],j[3]=t[0]*this[3]+t[1]*this[7]+t[2]*this[11]+t[3]*this[15],j[4]=t[4]*this[0]+t[5]*this[4]+t[6]*this[8]+t[7]*this[12],j[5]=t[4]*this[1]+t[5]*this[5]+t[6]*this[9]+t[7]*this[13],j[6]=t[4]*this[2]+t[5]*this[6]+t[6]*this[10]+t[7]*this[14],j[7]=t[4]*this[3]+t[5]*this[7]+t[6]*this[11]+t[7]*this[15],j[8]=t[8]*this[0]+t[9]*this[4]+t[10]*this[8]+t[11]*this[12],j[9]=t[8]*this[1]+t[9]*this[5]+t[10]*this[9]+t[11]*this[13],j[10]=t[8]*this[2]+t[9]*this[6]+t[10]*this[10]+t[11]*this[14],j[11]=t[8]*this[3]+t[9]*this[7]+t[10]*this[11]+t[11]*this[15],j[12]=t[12]*this[0]+t[13]*this[4]+t[14]*this[8]+t[15]*this[12],j[13]=t[12]*this[1]+t[13]*this[5]+t[14]*this[9]+t[15]*this[13],j[14]=t[12]*this[2]+t[13]*this[6]+t[14]*this[10]+t[15]*this[14],j[15]=t[12]*this[3]+t[13]*this[7]+t[14]*this[11]+t[15]*this[15],Y=0;Y<16;Y++)this[Y]=j[Y];return this}fromTRS(t,e,s){return this[3]=0,this[7]=0,this[11]=0,this[15]=1,k=2*e.x*e.x,I=2*e.y*e.y,F=2*e.z*e.z,W=2*e.x*e.y,D=2*e.x*e.z,B=2*e.x*e.w,G=2*e.y*e.z,H=2*e.y*e.w,X=2*e.z*e.w,this[0]=s.x*(1-I-F),this[1]=s.x*(W+X),this[2]=s.x*(D-H),this[4]=s.y*(W-X),this[5]=s.y*(1-k-F),this[6]=s.y*(G+B),this[8]=s.z*(D+H),this[9]=s.z*(G-B),this[10]=s.z*(1-k-I),this[12]=t.x,this[13]=t.y,this[14]=t.z,this}fromTRSC(t,e,s){return this[3]=0,this[7]=0,this[11]=0,this[15]=1,k=2*e.x*e.x,I=2*e.y*e.y,F=2*e.z*e.z,W=2*-e.x*-e.y,D=2*-e.x*-e.z,B=2*-e.x*-e.w,G=2*-e.y*-e.z,H=2*-e.y*-e.w,X=2*-e.z*-e.w,this[0]=(1-I-F)/s.x,this[1]=(W+X)/s.x,this[2]=(D-H)/s.x,this[4]=(W-X)/s.y,this[5]=(1-k-F)/s.y,this[6]=(G+B)/s.y,this[8]=(D+H)/s.z,this[9]=(G-B)/s.z,this[10]=(1-k-I)/s.z,this[12]=-t.x*this[0]-t.y*this[4]-t.z*this[8],this[13]=-t.x*this[1]-t.y*this[5]-t.z*this[9],this[14]=-t.x*this[2]-t.y*this[6]-t.z*this[10],this}}const J=Symbol.for("name");class Q extends U{constructor(t,e,s){super(t,e),this.aspect=s.aspect||1,this.fov=s.fov||.7,this.near=s.near||1,this.far=s.far||1e3,this.pmat=new q,this.wmat=new q}}Q[J]="Camera";let Z=0,$=0,tt=0,et=0,st=0;class it{constructor(t=0,e=0,s=0){this.x=t,this.y=e,this.z=s}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}set(t,e,s){return this.x=t,this.y=e,this.z=s,this}normalize(){return Z=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z),this.x/=Z,this.y/=Z,this.z/=Z,this}abs(){return this.x=Math.abs(this.x),this.y=Math.abs(this.y),this.z=Math.abs(this.z),this}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this}mins(t){return this.x=Math.min(this.x,t),this.y=Math.min(this.y,t),this.z=Math.min(this.z,t),this}maxs(t){return this.x=Math.max(this.x,t),this.y=Math.max(this.y,t),this.z=Math.max(this.z,t),this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}addScaledVec(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this}applyQuat(t){return $=t.w*this.x+t.y*this.z-t.z*this.y,tt=t.w*this.y+t.z*this.x-t.x*this.z,et=t.w*this.z+t.x*this.y-t.y*this.x,st=-t.x*this.x-t.y*this.y-t.z*this.z,this.x=$*t.w-st*t.x-tt*t.z+et*t.y,this.y=tt*t.w-st*t.y-et*t.x+$*t.z,this.z=et*t.w-st*t.z-$*t.y+tt*t.x,this}mulNumber(t){return this.x*=t,this.y*=t,this.z*=t,this}get length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}}const rt=Symbol.for("name");class nt extends U{constructor(t,e,s){super(t,e),this.speed=void 0!==s.speed?s.speed:0,this.linear=void 0===s.linear||s.linear,this.direction=new it(0,0,-1),void 0!==s.direction&&this.direction.copy(s.direction)}}nt[rt]="Movement";const ot=Symbol.for("name");class ht extends U{constructor(t,e,s){super(t,e),this.axis=new it,this.angle=s.angle||0,s.axis&&this.axis.copy(s.axis)}}ht[ot]="Rotation";const at=Symbol.for("name");class lt extends U{constructor(t,e,s){super(t,e),this.pos=new it,this.next=null,this.inner=[],this.mask=void 0!==s.mask?s.mask:4294967295,this.offset=new it,void 0!==s.offset&&this.offset.copy(s.offset),this.size=new it,void 0!==s.size&&this.size.copy(s.size)}}lt[at]="ATrigger";const mt=Symbol.for("name");class ct extends U{constructor(t,e,s){super(t,e),this.pos=new it,this.next=null,this.inner=[],this.mask=void 0!==s.mask?s.mask:4294967295,this.offset=new it,void 0!==s.offset&&this.offset.copy(s.offset),this.radius=void 0!==s.radius?s.radius:0}}ct[mt]="STrigger";class ut extends U{constructor(t,e,s){super(t,e),this.skeleton=void 0!==s.skeleton?s.skeleton:null,this.animation=void 0!==s.animation?s.animation:null,this.loop=!0,this.stop=!1,this.time=0,this.key=new it}}ut[Symbol.for("name")]="Animator";let dt=null;class pt{constructor(t=0,e=0,s=0,i=1){this.x=t,this.y=e,this.z=s,this.w=i}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this}set(t,e,s,i){return this.x=t,this.y=e,this.z=s,this.w=i,this}mul(t){const e=this.x,s=this.y,i=this.z,r=this.w;return this.x=r*t.x+e*t.w+s*t.z-i*t.y,this.y=r*t.y-e*t.z+s*t.w+i*t.x,this.z=r*t.z+e*t.y-s*t.x+i*t.w,this.w=r*t.w-e*t.x-s*t.y-i*t.z,this}premul(t){const e=this.x,s=this.y,i=this.z,r=this.w;return this.x=t.w*e+t.x*r+t.y*i-t.z*s,this.y=t.w*s-t.x*i+t.y*r+t.z*e,this.z=t.w*i+t.x*s-t.y*e+t.z*r,this.w=t.w*r-t.x*e-t.y*s-t.z*i,this}fromAxisAngle(t,e){return dt=Math.sin(.5*e),this.x=t.x*dt,this.y=t.y*dt,this.z=t.z*dt,this.w=Math.cos(.5*e),this}}const gt=Symbol.for("name");class yt extends U{constructor(t,e,s){super(t,e),this.position=new it,this.orientation=new pt,this.scale=new it(1,1,1),s.scale&&this.scale.copy(s.scale),s.position&&this.position.copy(s.position),s.orientation&&this.orientation.copy(s.orientation),this.lmat=new q,this.wmat=new q}worldPosition(t){return t.x=this.wmat[12],t.y=this.wmat[13],t.z=this.wmat[14],t}}yt[gt]="Transform";const wt=Symbol.for("name");class ft extends U{constructor(t,e,s){super(t,e),this.polar=s.polar||0,this.azimuthal=s.azimuthal||0,this.distance=s.distance||0,this.forward=new it,this.speed=s.speed||.004,this.nupd=!0,this.afrozen=s.afrozen||!1,this.pfrozen=s.pfrozen||!1,this.dfrozen=s.dfrozen||!1}}ft[wt]="OrbitControl";const _t=Symbol.for("name");const xt=Symbol.for("name");let Et=null,bt=null;const Ct=Symbol.for("name");const St=Symbol("k1"),Lt=Symbol("in"),zt=Symbol("it1"),vt=Symbol("it2");let Tt=null;class At{constructor(){this[Lt]=new Map,this[zt]=null,this[vt]=null}start(){this[zt]=null,this[vt]=null}next(t){for(this[zt]||(this[zt]=this[Lt][Symbol.iterator]());;){if(!this[vt]){if((Tt=this[zt].next()).done)return this[zt]=null,this[vt]=null,null;this[St]=Tt.value[0],this[vt]=Tt.value[1][Symbol.iterator]()}if(!(Tt=this[vt].next()).done)return t.k1=this[St],t.k2=Tt.value[0],t.value=Tt.value[1],t;this[vt]=null}}set(t,e,s){this[Lt].has(t)?Tt=this[Lt].get(t):(Tt=new Map,this[Lt].set(t,Tt)),Tt.set(e,s)}get(t,e){if(Tt=this[Lt].get(t))return Tt.get(e)}has(t,e){return!!(Tt=this[Lt].get(t))&&Tt.has(e)}delete(t,e){return!!(Tt=this[Lt].get(t))&&Tt.delete(e)}}const Rt=64;class Mt{constructor(t,e,s,i,r){this.mat=e,this.geo=s,this.ibo=i,this.offset=r*Rt,this.size=0,this.vao=t.ext.vao.createVertexArrayOES();const n=t.gl,o=this.mat.shader;n.bindBuffer(n.ARRAY_BUFFER,this.geo.vbo);for(const t in this.attribute)void 0!==o.attribute[t]&&(n.enableVertexAttribArray(o.attribute[t]),n.vertexAttribPointer(o.attribute[t],this.attribute[t].size,this.attribute[t].type,!1,this.attribute[t].stride,this.attribute[t].offset));n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,this.geo.ebo)}add(){if(this.size++,this.size>Rt)throw new Error("BATCH_SIZE ERROR");return this.offset+this.size-1}draw(t){t.ext.vao.bindVertexArrayOES(this.vao),t.ext.inst.drawElementsInstancedANGLE(t.gl.TRIANGLES,this.geo.length,t.gl.UNSIGNED_SHORT,0,this.size)}}const Vt=Symbol.for("name");let Ut=null,Kt=null,Nt=null,Pt=null,Ot=null;const kt=Symbol.for("name");let It=null;const Ft=new pt;const Wt=Symbol.for("name");let Dt=null;const Bt=Symbol.for("name");let Gt=null,Ht=null,Xt=null;const Yt=Symbol.for("name");let jt=null,qt=null;const Jt=Symbol.for("name"),Qt=new it;function Zt(t,e){return Qt.copy(t.pos).sub(e.pos),Qt.length-t.radius-e.radius<=0}function $t(t,e){return Qt.copy(e.pos).sub(t.pos).abs().sub(t.size).maxs(0),Qt.length-e.radius<=0}function te(t,e){return Qt.copy(e.pos).sub(t.pos).abs().sub(t.size).sub(e.size),Qt.x<=0&&Qt.y<=0&&Qt.z<=0}class ee{constructor(t,e,s,i,r,n){this.child=null,this.inner=!1,this.xl=t,this.yl=e,this.xh=s,this.yh=i,this.c1=null,this.c2=null,this.bs=null,this.es=null,this.ba=null,this.ea=null,this.tx=.5*(t+s),this.ty=.5*(e+i),r<n&&(this.child=new Array(4),this.child[0]=new ee(t,e,this.tx,this.ty,r+1,n),this.child[1]=new ee(this.tx,e,s,this.ty,r+1,n),this.child[2]=new ee(t,this.ty,this.tx,i,r+1,n),this.child[3]=new ee(this.tx,this.ty,s,i,r+1,n))}clear(){this.bs=null,this.es=null,this.ba=null,this.ea=null,this.child&&this.inner&&(this.child[0].clear(),this.child[1].clear(),this.child[2].clear(),this.child[3].clear()),this.inner=!1}adds(t,e,s,i){this.tx=.5*(this.xl+this.xh),this.ty=.5*(this.yl+this.yh),this.child?e+i<this.tx&&s+i<this.ty?(this.inner=!0,this.child[0].adds(t,e,s,i)):e-i>this.tx&&s+i<this.ty?(this.inner=!0,this.child[1].adds(t,e,s,i)):e+i<this.tx&&s-i>this.ty?(this.inner=!0,this.child[2].adds(t,e,s,i)):e-i>this.tx&&s-i>this.ty?(this.inner=!0,this.child[3].adds(t,e,s,i)):(null===this.es?this.bs=t:this.es.next=t,this.es=t,t.next=null):(null===this.es?this.bs=t:this.es.next=t,this.es=t,t.next=null)}adda(t,e,s,i){this.tx=.5*(this.xl+this.xh),this.ty=.5*(this.yl+this.yh),this.child?e+i.x<this.tx&&s+i.z<this.ty?(this.inner=!0,this.child[0].adda(t,e,s,i)):e-i.x>this.tx&&s+i.z<this.ty?(this.inner=!0,this.child[1].adda(t,e,s,i)):e+i.x<this.tx&&s-i.z>this.ty?(this.inner=!0,this.child[2].adda(t,e,s,i)):e-i.x>this.tx&&s-i.z>this.ty?(this.inner=!0,this.child[3].adda(t,e,s,i)):(null===this.ea?this.ba=t:this.ea.next=t,this.ea=t,t.next=null):(null===this.ea?this.ba=t:this.ea.next=t,this.ea=t,t.next=null)}test(){for(this.c1=this.bs;null!==this.c1;this.c1=this.c1.next){for(this.c2=this.c1.next;null!==this.c2;this.c2=this.c2.next)Zt(this.c1,this.c2)&&(this.c1.inner.push(this.c2),this.c2.inner.push(this.c1));for(this.c2=this.ba;null!==this.c2;this.c2=this.c2.next)$t(this.c2,this.c1)&&(this.c1.inner.push(this.c2),this.c2.inner.push(this.c1));this.inner&&this.child&&(this.child[0].tests(this.c1),this.child[1].tests(this.c1),this.child[2].tests(this.c1),this.child[3].tests(this.c1))}for(this.c1=this.ba;null!==this.c1;this.c1=this.c1.next){for(this.c2=this.c1.next;null!==this.c2;this.c2=this.c2.next)te(this.c1,this.c2)&&(this.c1.inner.push(this.c2),this.c2.inner.push(this.c1));this.inner&&this.child&&(this.child[0].testa(this.c1),this.child[1].testa(this.c1),this.child[2].testa(this.c1),this.child[3].testa(this.c1))}this.inner&&this.child&&(this.child[0].test(),this.child[1].test(),this.child[2].test(),this.child[3].test())}tests(t){for(this.c1=this.bs;null!==this.c1;this.c1=this.c1.next)Zt(this.c1,t)&&(this.c1.inner.push(t),t.inner.push(this.c1));for(this.c1=this.ba;null!==this.c1;this.c1=this.c1.next)$t(this.c1,t)&&(this.c1.inner.push(t),t.inner.push(this.c1));this.inner&&this.child&&(this.child[0].tests(t),this.child[1].tests(t),this.child[2].tests(t),this.child[3].tests(t))}testa(t){for(this.c1=this.ba;null!==this.c1;this.c1=this.c1.next)te(this.c1,t)&&(this.c1.inner.push(t),t.inner.push(this.c1));for(this.c1=this.bs;null!==this.c1;this.c1=this.c1.next)$t(t,this.c1)&&(this.c1.inner.push(t),t.inner.push(this.c1));this.inner&&this.child&&(this.child[0].testa(t),this.child[1].testa(t),this.child[2].testa(t),this.child[3].testa(t))}}const se=0,ie=700,re=1024,ne=5;function oe(t,e,s,i){e[s]=t.newEntity(null,!0),t.newComp(yt,e[s],!0,{position:i}).position.y=6,t.newComp(O,e[s],!0,{geometry:"SPHERE_GOLD",material:"gold_mat"}),t.newComp(O,e[s],!0,{geometry:"SPHERE_SILVER",material:"silver_mat"}),t.newComp(O,e[s],!0,{geometry:"SPHERE_LIGHT",material:"light_mat"}),t.newComp(nt,e[s],!0,{direction:{x:-1,y:0,z:0},speed:20*Math.random()*i.x/Math.abs(i.x)}),t.newComp(ct,e[s],!0,{radius:1})}function he(t,e,s,i){e[s]=t.newEntity(null,!0),t.newComp(yt,e[s],!0,{position:i}),t.newComp(O,e[s],!0,{geometry:"PILLAR1_GOLD",material:"gold_mat"}),t.newComp(O,e[s],!0,{geometry:"PILLAR1_SILVER",material:"silver_mat"}),t.newComp(O,e[s],!0,{geometry:"PILLAR1_WALL_W",material:"wall_w_mat"}),t.newComp(O,e[s],!0,{geometry:"PILLAR1_WALL_WG",material:"wall_wg_mat"}),t.newComp(nt,e[s],!0,{direction:{x:0,y:0,z:1},speed:0}),t.newComp(lt,e[s],!0,{size:{x:4,y:8,z:4}})}function ae(t,e,s,i){e[s]=t.newEntity(null,!0),t.newComp(yt,e[s],!0,{position:i}),t.newComp(O,e[s],!0,{geometry:"PILLAR2_SILVER",material:"silver_mat"}),t.newComp(O,e[s],!0,{geometry:"PILLAR2_WALL_W",material:"wall_w_mat"}),t.newComp(O,e[s],!0,{geometry:"PILLAR2_WALL_WG",material:"wall_wg_mat"}),t.newComp(nt,e[s],!0,{direction:{x:0,y:0,z:1},speed:0}),t.newComp(lt,e[s],!0,{size:{x:4,y:8,z:4}})}function le(t,e,s,i){e[s]=t.newEntity(null,!0),t.newComp(yt,e[s],!0,{position:i}),t.newComp(O,e[s],!0,{geometry:"PILLAR3_SILVER",material:"silver_mat"}),t.newComp(O,e[s],!0,{geometry:"PILLAR3_WALL_W",material:"wall_w_mat"}),t.newComp(nt,e[s],!0,{direction:{x:0,y:0,z:1},speed:0}),t.newComp(lt,e[s],!0,{size:{x:4,y:8,z:4}})}function me(t,e,s,i){e[s]=t.newEntity(null,!0),t.newComp(yt,e[s],!0,{position:i}),t.newComp(O,e[s],!0,{geometry:"PILLAR4_GOLD",material:"gold_mat"}),t.newComp(O,e[s],!0,{geometry:"PILLAR4_SILVER",material:"silver_mat"}),t.newComp(O,e[s],!0,{geometry:"PILLAR4_WALL_W",material:"wall_w_mat"}),t.newComp(O,e[s],!0,{geometry:"PILLAR4_WALL_WG",material:"wall_wg_mat"}),t.newComp(nt,e[s],!0,{direction:{x:0,y:0,z:1},speed:0}),t.newComp(lt,e[s],!0,{size:{x:4,y:8,z:4}})}function ce(t,e,s,i){e[s]=t.newEntity(null,!0),t.newComp(yt,e[s],!0,{position:i}),t.newComp(O,e[s],!0,{geometry:"PILLAR5_GOLD",material:"gold_mat"}),t.newComp(O,e[s],!0,{geometry:"PILLAR5_SILVER",material:"silver_mat"}),t.newComp(O,e[s],!0,{geometry:"PILLAR5_WALL_W",material:"wall_w_mat"}),t.newComp(O,e[s],!0,{geometry:"PILLAR5_WALL_WG",material:"wall_wg_mat"}),t.newComp(nt,e[s],!0,{direction:{x:0,y:0,z:1},speed:0}),t.newComp(lt,e[s],!0,{size:{x:4,y:8,z:4}})}function ue(t,e,s,i){e[s]=t.newEntity(null,!0),t.newComp(yt,e[s],!0,{position:i}),t.newComp(O,e[s],!0,{geometry:"COLUMN1_GOLD",material:"gold_mat"}),t.newComp(O,e[s],!0,{geometry:"COLUMN1_WALL_S",material:"wall_s_mat"}),t.newComp(O,e[s],!0,{geometry:"COLUMN1_WALL_W",material:"wall_w_mat"}),t.newComp(O,e[s],!0,{geometry:"COLUMN1_WALL_WG",material:"wall_wg_mat"}),t.newComp(nt,e[s],!0,{direction:{x:0,y:0,z:1},speed:0}),t.newComp(lt,e[s],!0,{size:{x:7,y:8,z:7}})}function de(t,e,s,i){e[s]=t.newEntity(null,!0),t.newComp(yt,e[s],!0,{position:i}),t.newComp(O,e[s],!0,{geometry:"COLUMN2_GOLD",material:"gold_mat"}),t.newComp(O,e[s],!0,{geometry:"COLUMN2_SILVER",material:"silver_mat"}),t.newComp(O,e[s],!0,{geometry:"COLUMN2_WALL_S",material:"wall_s_mat"}),t.newComp(O,e[s],!0,{geometry:"COLUMN2_WALL_W",material:"wall_w_mat"}),t.newComp(O,e[s],!0,{geometry:"COLUMN2_WALL_WG",material:"wall_wg_mat"}),t.newComp(nt,e[s],!0,{direction:{x:0,y:0,z:1},speed:0}),t.newComp(lt,e[s],!0,{size:{x:7,y:8,z:7}})}function pe(t,e,s,i){e[s]=t.newEntity(null,!0),t.newComp(yt,e[s],!0,{position:i}),t.newComp(O,e[s],!0,{geometry:"COLUMN3_GOLD",material:"gold_mat"}),t.newComp(O,e[s],!0,{geometry:"COLUMN3_SILVER",material:"silver_mat"}),t.newComp(O,e[s],!0,{geometry:"COLUMN3_WALL_S",material:"wall_s_mat"}),t.newComp(O,e[s],!0,{geometry:"COLUMN3_WALL_W",material:"wall_w_mat"}),t.newComp(O,e[s],!0,{geometry:"COLUMN3_WALL_WG",material:"wall_wg_mat"}),t.newComp(nt,e[s],!0,{direction:{x:0,y:0,z:1},speed:0}),t.newComp(lt,e[s],!0,{size:{x:7,y:8,z:7}})}function ge(t,e,s,i){e[s]=t.newEntity(null,!0),t.newComp(yt,e[s],!0,{position:i}),t.newComp(O,e[s],!0,{geometry:"TUNNEL1_GOLD",material:"gold_mat"}),t.newComp(O,e[s],!0,{geometry:"TUNNEL1_WALL_S",material:"wall_s_mat"}),t.newComp(O,e[s],!0,{geometry:"TUNNEL1_WALL_WG",material:"wall_wg_mat"}),t.newComp(nt,e[s],!0,{direction:{x:0,y:0,z:1},speed:0}),t.newComp(lt,e[s],!0,{size:{x:8,y:8,z:67}})}function ye(t,e,s,i){e[s]=t.newEntity(null,!0),t.newComp(yt,e[s],!0,{position:i}),t.newComp(O,e[s],!0,{geometry:"TUNNEL2_GOLD",material:"gold_mat"}),t.newComp(O,e[s],!0,{geometry:"TUNNEL2_WALL_S",material:"wall_s_mat"}),t.newComp(O,e[s],!0,{geometry:"TUNNEL2_WALL_W",material:"wall_w_mat"}),t.newComp(O,e[s],!0,{geometry:"TUNNEL2_WALL_WG",material:"wall_wg_mat"}),t.newComp(nt,e[s],!0,{direction:{x:0,y:0,z:1},speed:0}),t.newComp(lt,e[s],!0,{size:{x:8,y:8,z:67}})}function we(t,e,s,i){const r=i.x;i.x=0,e[s]=t.newEntity(null,!0),t.newComp(yt,e[s],!0,{position:i}),t.newComp(O,e[s],!0,{geometry:"GATE_GOLD",material:"gold_mat"}),t.newComp(O,e[s],!0,{geometry:"GATE_LIGHT",material:"light_mat"}),t.newComp(O,e[s],!0,{geometry:"GATE_WALL_S",material:"wall_s_mat"}),t.newComp(O,e[s],!0,{geometry:"GATE_WALL_SG",material:"wall_sg_mat"}),t.newComp(O,e[s],!0,{geometry:"GATE_WALL_W",material:"wall_w_mat"}),t.newComp(O,e[s],!0,{geometry:"GATE_WALL_WG",material:"wall_wg_mat"}),t.newComp(nt,e[s],!0,{direction:{x:0,y:0,z:1},speed:0}),t.newComp(lt,e[s],!0,{size:{x:20,y:20,z:20},offset:{x:220,y:0,z:0}}),t.newComp(lt,e[s],!0,{size:{x:20,y:20,z:20},offset:{x:-220,y:0,z:0}}),i.x=r,i.y=5,i.z=0;let n=t.newEntity(e[s],!0);t.newComp(yt,n,!0,{position:i}),t.newComp(O,n,!0,{geometry:"PYRAMID_GOLD",material:"gold_mat"}),t.newComp(O,n,!0,{geometry:"PYRAMID_SILVER",material:"silver_mat"}),t.newComp(nt,n,!0,{direction:{x:1,y:0,z:0},speed:r<0?30:-30}),t.newComp(ct,n,!0,{radius:10}),i.x+=28,n=t.newEntity(e[s],!0),t.newComp(yt,n,!0,{position:i,scale:{x:.7,y:.7,z:.7}}),t.newComp(O,n,!0,{geometry:"PYRAMID_GOLD",material:"gold_mat"}),t.newComp(O,n,!0,{geometry:"PYRAMID_SILVER",material:"silver_mat"}),t.newComp(nt,n,!0,{direction:{x:1,y:0,z:0},speed:r<0?30:-30}),t.newComp(ct,n,!0,{radius:7}),i.x-=56,n=t.newEntity(e[s],!0),t.newComp(yt,n,!0,{position:i,scale:{x:.7,y:.7,z:.7}}),t.newComp(O,n,!0,{geometry:"PYRAMID_GOLD",material:"gold_mat"}),t.newComp(O,n,!0,{geometry:"PYRAMID_SILVER",material:"silver_mat"}),t.newComp(nt,n,!0,{direction:{x:1,y:0,z:0},speed:r<0?30:-30}),t.newComp(ct,n,!0,{radius:7})}const fe=Symbol.for("name");let _e=0,xe=0,Ee=null;const be=new it(0,0,1),Ce=128,Se=.5,Le=.25,ze=new it(0,0,0);class ve{constructor(t=0,e=0){this.x=t,this.y=e}}class Te{constructor(t=0,e=0,s=0,i=0){this.x=t,this.y=e,this.z=s,this.w=i}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this}}class Ae{constructor(t=null,e=0){this.texture=t,this.layer=e}copy(t){this.texture=t.texture,this.layer=t.layer}}class Re{constructor(){this.program=null,this.uniform={},this.attribute={}}use(t){t.gl.useProgram(this.program)}setUniform(t,e,s){switch(s.constructor){case Number:t.gl.uniform2f(this.uniform[e],s);break;case ve:t.gl.uniform2f(this.uniform[e],s.x,s.y);break;case it:t.gl.uniform3f(this.uniform[e],s.x,s.y,s.z);break;case Te:case pt:t.gl.uniform4f(this.uniform[e],s.x,s.y,s.z,s.w);break;case Ae:t.gl.uniform1i(this.uniform[e],s.layer),s.texture.use(t,s.layer);break;case q:t.gl.uniformMatrix4fv(this.uniform[e],!1,s);break;default:throw new Error("Type of value not found")}}}const Me=Symbol.for("name");class Ve extends V{parse(t){if("string"!=typeof t.name||""===t.name)throw new Error("Shader not named");const e=this.core.gl,s=e.createShader(e.VERTEX_SHADER),i=e.createShader(e.FRAGMENT_SHADER),r=new Re;if(r.program=e.createProgram(),e.shaderSource(s,t.vs),e.compileShader(s),e.shaderSource(i,t.fs),e.compileShader(i),!e.getShaderParameter(s,e.COMPILE_STATUS))throw new Error(e.getShaderInfoLog(s));if(!e.getShaderParameter(i,e.COMPILE_STATUS))throw new Error(e.getShaderInfoLog(i));if(e.attachShader(r.program,s),e.attachShader(r.program,i),e.linkProgram(r.program),!e.getProgramParameter(r.program,e.LINK_STATUS))throw new Error(e.getProgramInfoLog(r.program));e.deleteShader(s),e.deleteShader(i);for(let t=0;t<e.getProgramParameter(r.program,e.ACTIVE_UNIFORMS);t++){const s=e.getActiveUniform(r.program,t).name;s.includes("gl_")||(r.uniform[s]=e.getUniformLocation(r.program,s))}for(let t=0;t<e.getProgramParameter(r.program,e.ACTIVE_ATTRIBUTES);t++){const s=e.getActiveAttrib(r.program,t).name;s.includes("gl_")||(r.attribute[s]=e.getAttribLocation(r.program,s))}return this.core.addRes("shader",t.name,r),Promise.resolve(r)}}Ve.prototype[Me]="RawShaderLoader";let Ue=null;class Ke{constructor(){this.shader=null,this.depthtest=!0,this.depthwrite=!0,this.cullFace=0,this.blend=0,this.uniform={},this.batch=!1}use(t){switch(Ue=t.gl,this.shader.use(t),this.depthtest?Ue.enable(Ue.DEPTH_TEST):Ue.disable(Ue.DEPTH_TEST),Ue.depthMask(this.depthwrite),this.cullFace){case 0:Ue.disable(Ue.CULL_FACE);break;case 1:Ue.enable(Ue.CULL_FACE),Ue.cullFace(Ue.BACK);break;case 2:Ue.enable(Ue.CULL_FACE),Ue.cullFace(Ue.FRONT);break;case 3:Ue.enable(Ue.CULL_FACE),Ue.cullFace(Ue.FRONT_AND_BACK);break;default:Ue.disable(Ue.CULL_FACE)}switch(this.blend){case 0:Ue.disable(Ue.BLEND);break;case 1:Ue.enable(Ue.BLEND);break;default:Ue.disable(Ue.BLEND)}for(const e in this.uniform)this.shader.setUniform(t,e,this.uniform[e])}}const Ne=Symbol.for("name");class Pe extends V{parse(t){if("string"!=typeof t.name||""===t.name)throw new Error("Material not named");const e=new Ke;e.shader=t.shader,e.depthtest=void 0===t.depthtest||t.depthtest,e.depthwrite=void 0===t.depthwrite||t.depthwrite,e.cullFace=void 0!==t.cullFace?t.cullFace:0,e.blend=void 0!==t.blend?t.blend:0,e.batch=void 0!==t.batch&&t.batch;for(const s in t.uniform)switch(t.uniform[s].type){case"Float":e.uniform[s]=t.uniform[s].value;break;case"Vec2":e.uniform[s]=new ve,e.uniform[s].copy(t.uniform[s].value);break;case"Vec3":e.uniform[s]=new it,e.uniform[s].copy(t.uniform[s].value);break;case"Vec4":e.uniform[s]=new Te,e.uniform[s].copy(t.uniform[s].value);break;case"Texture":e.uniform[s]=new Ae,e.uniform[s].copy(t.uniform[s].value);break;default:throw new Error("Uniform type not found")}return this.core.addRes("material",t.name,e),Promise.resolve(e)}conf(t){t.shader=this.core.getRes("shader",t.shader);for(const e in t.uniform)t.uniform[e]instanceof Ae&&(t.uniform[e].texture=this.core.getRes("texture",t.uniform[e].texture));return Promise.resolve(t)}}Pe.prototype[Ne]="MaterialLoader";const Oe=Symbol.for("name");class ke extends V{load(t){return new Promise((e,s)=>{const i=new Image,r=t.substring(t.lastIndexOf("/")+1,t.lastIndexOf("."));i.onload=(()=>{e(i),this.core.addRes("image",r,i)}),i.onerror=(()=>{s(i)}),i.src=t})}}ke.prototype[Oe]="ImageLoader";let Ie=null;class Fe{constructor(){this.image=null,this.tex=null,this.type=3553}use(t,e){(Ie=t.gl).activeTexture(Ie.TEXTURE0+e),Ie.bindTexture(this.type,this.tex)}}const We=Symbol.for("name");class De extends V{parse(t){if("string"!=typeof t.name||""===t.name)throw new Error("Texture not named");const e=this.core.gl,s=new Fe;return s.image=t.image,s.type=e.TEXTURE_2D,s.tex=e.createTexture(),this.core.addRes("texture",t.name,s),Promise.resolve(s)}conf(t){const e=this.core.gl;return t.image=this.core.getRes("image",t.image),e.bindTexture(e.TEXTURE_2D,t.tex),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t.image),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR_MIPMAP_LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT),e.generateMipmap(e.TEXTURE_2D),e.bindTexture(e.TEXTURE_2D,null),Promise.resolve(t)}}De.prototype[We]="Texture2DLoader";let Be=null;class Ge{constructor(){this.attribute={},this.length=0,this.vbo=null,this.ebo=null}use(t,e){(Be=t.gl).bindBuffer(Be.ARRAY_BUFFER,this.vbo);for(const t in this.attribute)void 0!==e.attribute[t]&&(Be.enableVertexAttribArray(e.attribute[t]),Be.vertexAttribPointer(e.attribute[t],this.attribute[t].size,this.attribute[t].type,!1,this.attribute[t].stride,this.attribute[t].offset));Be.bindBuffer(Be.ELEMENT_ARRAY_BUFFER,this.ebo),Be.drawElements(Be.TRIANGLES,this.length,Be.UNSIGNED_SHORT,0);for(const t in this.attribute)void 0!==e.attribute[t]&&Be.disableVertexAttribArray(e.attribute[t])}}const He=Symbol.for("name");class Xe extends V{parse(t){if("string"!=typeof t.name||""===t.name)throw new Error("Geometry not named");const e=this.core.gl,s=new Ge;for(const e in t.attribute)s.attribute[e]=t.attribute[e];return s.vbo=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,s.vbo),e.bufferData(e.ARRAY_BUFFER,new Float32Array(t.vbo),e.STATIC_DRAW),s.ebo=e.createBuffer(),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,s.ebo),e.bufferData(e.ELEMENT_ARRAY_BUFFER,new Uint16Array(t.ebo),e.STATIC_DRAW),s.length=t.ebo.length,this.core.addRes("geometry",t.name,s),Promise.resolve(s)}}Xe.prototype[He]="GeometryLoader";const Ye=Symbol.for("name");class je extends V{parse(t){const e=[],s=[];for(const i of t.res){const t=this.core.getLoader(i.loader);s.push(t),"string"==typeof i.conf?e.push(t.load(i.conf).then(e=>t.parse(e))):e.push(t.parse(i.conf))}return Promise.all(e).then(t=>{const e=[];for(let i=0;i<t.length;i++)e.push(s[i].conf(t[i]));return Promise.all(e)}).then(()=>{const e=[];let s=null;for(const i of t.ent){s=void 0!==i.owner&&null!==i.owner?e[i.owner]:null;const t=this.core.newEntity(s,i.enable||!0);if(e.push(t),i.name&&(t.name=i.name),i.tags)for(const e of i.tags)t.addTag(e);if(i.comp)for(const e of i.comp){const s=this.core.getCompClassByName(e.type);void 0===e.enable&&(e.enable=!0),this.core.newComp(s,t,e.enable,e.conf)}}})}}je.prototype[Ye]="SceneLoader";const qe=new class{constructor(t,e){if(this[n]=document.getElementById(t),this[o]=document.getElementById("app-gl"),this[h]=document.getElementById("app-ui"),this[c]=new Map,this[f]={useEntity:new Set,delEntity:new Set},this[L]=new Map,this[_]=new Map,this[d]=new Map,this[l]=new Map,this[i]=this[o].getContext("webgl",e),null===this[i])throw new Error("Get 3d context is failed");if(this[r]={sd:this[i].getExtension("OES_standard_derivatives"),vao:this[i].getExtension("OES_vertex_array_object"),inst:this[i].getExtension("ANGLE_instanced_arrays")},null===this[r].tf)throw new Error("Extension OES_texture_float not supported");if(null===this[r].sd)throw new Error("Extension OES_standard_derivatives not supported");if(null===this[r].tfa)throw new Error("Extension EXT_texture_filter_anisotropic not supported");if(null===this[r].vao)throw new Error("Extension OES_vertex_array_object not supported");if(null===this[r].inst)throw new Error("Extension ANGLE_instanced_arrays not supported");for(const t in this[r].tfa)this[i][t]=this[r].tfa[t];this[p]=!1,this[S]=!1,this[a]=0,this[u]=(()=>{performance.mark("frs"),this.fireEvent("onStartFrame"),this.fireEvent("onUpdate"),this.fireEvent("onTransform"),this.fireEvent("onPHYUpdate"),this.fireEvent("onLateUpdate"),this.fireEvent("onRender"),this[S]&&(this[b](),this.fireEvent("onModify"),this[C](),this[S]=!1),this[a]=requestAnimationFrame(this[u]),performance.mark("fre"),performance.measure("frame","frs","fre"),performance.clearMarks(),performance.clearMeasures()})}start(){this[a]=requestAnimationFrame(this[u]),this[p]=!0,this.fireEvent("onStart")}stop(){cancelAnimationFrame(this[a]),this[a]=0,this[p]=!1}addRes(t,e,s){this[l].has(t)||this[l].set(t,{});const i=this[l].get(t);if(void 0!==i[e])throw new Error("Resource with this name already used");i[e]=s}getRes(t,e){if(!this[l].has(t))throw new Error("Resource type not found");if(void 0===(N=this[l].get(t)[e]))throw new Error("Resource not found");return N}loadRes(t,e){if(!this[L].has(t))throw new Error("Loader not found");const s=this[L].get(t);return s.load(e).then(t=>s.parse(t).then(t=>s.conf(t)))}parseRes(t,e){if(!this[L].has(t))throw new Error("Loader not found");const s=this[L].get(t);return s.parse(e).then(t=>s.conf(t))}regLoader(t){if(void 0===t[E])throw new Error("Loader not named");if(this[L].has(t))throw new Error("Loader already used");this[L].set(t[E],t)}getLoader(t){if(!this[L].has(t))throw new Error("Loader not found");return this[L].get(t)}regSystem(t){if(void 0===t[E])throw new Error("System not named");if(this[_].has(t[E]))throw new Error("System already used");this[_].set(t[E],t)}getSystem(t){return this[_].get(t)}regEvent(t,e){this[d].has(t)||this[d].set(t,[]),this[d].get(t).push(e)}fireEvent(t){const e=this[d].get(t);if(void 0!==e)for(const s of e)s[t](this)}newEntity(t,e){const s=new K(t,e);return this[f].useEntity.add(s),this[S]=!0,s}delEntity(t){this[f].delEntity.add(t),this[S]=!0}enableEntity(t,e){e?t[p]|=T:t[p]&=~T;for(const s of t[c])this.enableComp(s,e);for(const s of t[y])this.enableEntity(s,e)}getEntity(){return this[f].useEntity}getEntitiesByName(t,e=[]){e.length=0;for(const s of this[f].useEntity)s[E]===t&&e.push(s);return e}newComp(t,e,s,i){const r=this[c].get(t);if(void 0===r)throw new Error("Component class not registered");const n=new t(e,s,i);return r.newComp.add(n),this[S]=!0,n}delComp(t){this[c].get(t.constructor).delComp.add(t),this[S]=!0}enableComp(t,e){e?t[p]|=T:t[p]&=~T,this[c].get(t.constructor).modComp.add(t),this[S]=!0}getComp(t){return this[c].get(t).useComp}getNewComp(t){return this[c].get(t).newComp}getDelComp(t){return this[c].get(t).delComp}getModComp(t){return this[c].get(t).modComp}regComp(t){if(void 0===t[E])throw new Error("Component class not named");if(this[c].has(t))throw new Error("Component class already used");this[c].set(t,{newComp:new Set,useComp:new Set,delComp:new Set,modComp:new Set})}getCompClassByName(t){for(const e of this[c].keys())if(e[E]===t)return e;throw new Error("Component class not found")}get gl(){return this[i]}get ext(){return this[r]}get dom(){return this[n]}get gldom(){return this[o]}get uidom(){return this[h]}[b](){for(const t of this[c].values())for(const e of t.newComp)t.useComp.add(e),e.owner[c].has(e.constructor)||e.owner[c].set(e.constructor,new Set),e.owner[c].get(e.constructor).add(e);for(const t of this[f].delEntity){for(const e of t[c].keys())for(const s of t[c].get(e))this.delComp(s);for(const e of t[y])this.delEntity(e)}}[C](){for(const t of this[f].delEntity)this[f].useEntity.delete(t);this[f].delEntity.clear();for(const t of this[c].values()){for(const e of t.modComp)e[p]&e[g][p]&T?e[p]|=v:e[p]&=~v,e[p]&=~A;for(const e of t.delComp)t.useComp.delete(e),e[g][c].get(e.constructor).delete(e);t.newComp.clear(),t.delComp.clear(),t.modComp.clear()}}}("app",{alpha:!1});qe.regLoader(new Ve(qe)),qe.regLoader(new Pe(qe)),qe.regLoader(new ke(qe)),qe.regLoader(new De(qe)),qe.regLoader(new Xe(qe)),qe.regLoader(new je(qe)),qe.regComp(O),qe.regComp(Q),qe.regComp(nt),qe.regComp(ht),qe.regComp(lt),qe.regComp(ct),qe.regComp(ut),qe.regComp(yt),qe.regComp(ft),qe.regSystem(new class{constructor(t){this[_t]="Time",t.regEvent("onStartFrame",this),this._time=performance.now(),this._currentTime=0,this._deltaTime=0,this._timeScale=1}onStartFrame(){this._deltaTime=Math.max(performance.now()-this._time,1e-5)*this._timeScale*.001,this._time=performance.now(),this._currentTime+=this._deltaTime}get time(){return this._currentTime}get deltaTime(){return this._deltaTime}get timeScale(){return this._timeScale}set timeScale(t){this._timeScale=t}}(qe)),qe.regSystem(new class{constructor(t){this[xt]="Input",t.regEvent("onStartFrame",this),this._up=new Uint32Array(8),this._down=new Uint32Array(8),this._state=new Uint32Array(8),this._pos={x:0,y:0},this._dpos={x:0,y:0},this._aup=new Uint32Array(8),this._adown=new Uint32Array(8),this._astate=new Uint32Array(8),this._apos={x:0,y:0},this._awheel=0,this._pwheel=0,this._dposflag=!0;const e=t.dom;e.setAttribute("tabindex",1),e.addEventListener("keyup",t=>{this.kUp(t)}),e.addEventListener("keydown",t=>{this.kDown(t)}),e.addEventListener("mouseup",t=>{this.mUp(t)}),e.addEventListener("mousedown",t=>{this.mDown(t)}),e.addEventListener("mousemove",t=>{this.mMove(t)}),e.addEventListener("mousewheel",t=>{this.mWheel(t)}),e.addEventListener("touchend",t=>{this.tEnd(t)}),e.addEventListener("touchstart",t=>{this.tStart(t)}),e.addEventListener("touchmove",t=>{this.tMove(t)}),e.addEventListener("contextmenu",t=>{t.preventDefault()})}onStartFrame(){for(let t=0;t<8;t++)this._up[t]=this._aup[t],this._down[t]=this._adown[t],this._state[t]=this._astate[t],this._aup[t]=0,this._adown[t]=0;this._dpos.x=this._dposflag?this._apos.x-this._pos.x:0,this._dpos.y=this._dposflag?this._apos.y-this._pos.y:0,this._pos.x=this._apos.x,this._pos.y=this._apos.y,this._pwheel=this._awheel,this._awheel=0,this._dposflag=!0}asyncDown(t){Et=1<<t%32,bt=Math.floor(t/32),this._adown[bt]|=Et&~this._astate[bt],this._astate[bt]|=Et}asyncUp(t){Et=1<<t%32,bt=Math.floor(t/32),this._aup[bt]|=Et,this._astate[bt]&=~Et}kUp(t){this.asyncUp(t.keyCode)}kDown(t){this.asyncDown(t.keyCode),116!==t.keyCode&&t.preventDefault()}mUp(t){switch(t.button){case 0:t.keyCode=1;break;case 1:t.keyCode=4;break;case 2:t.keyCode=2;break;default:t.keyCode=0}this.asyncUp(t.keyCode)}mDown(t){switch(t.button){case 0:t.keyCode=1;break;case 1:t.keyCode=4;break;case 2:t.keyCode=2;break;default:t.keyCode=0}this.asyncDown(t.keyCode)}mMove(t){this._apos.x=t.clientX,this._apos.y=t.clientY}mWheel(t){this._awheel+=t.wheelDelta/120}tStart(t){this._apos.x=t.changedTouches[0].clientX,this._apos.y=t.changedTouches[0].clientY,this.asyncDown(1),this._dposflag=!1,t.preventDefault()}tEnd(t){this._apos.x=t.changedTouches[0].clientX,this._apos.y=t.changedTouches[0].clientY,this.asyncUp(1)}tMove(t){this._apos.x=t.changedTouches[0].clientX,this._apos.y=t.changedTouches[0].clientY}keyUp(t){return this._up[Math.floor(t/32)]>>t%32&1}keyDown(t){return this._down[Math.floor(t/32)]>>t%32&1}keyState(t){return this._state[Math.floor(t/32)]>>t%32&1}mousePos(){return this._pos}mouseDeltaPos(){return this._dpos}mouseWheel(){return this._pwheel}get VK_LBUTTON(){return 1}get VK_RBUTTON(){return 2}get VK_MBUTTON(){return 4}get VK_XBUTTON1(){return 5}get VK_XBUTTON2(){return 6}get VK_BACK(){return 8}get VK_TAB(){return 9}get VK_ESCAPE(){return 27}get VK_SPACE(){return 32}get VK_PAGEUP(){return 33}get VK_PAGEDOWN(){return 34}get VK_END(){return 35}get VK_HOME(){return 36}get VK_LEFT(){return 37}get VK_UP(){return 38}get VK_RIGHT(){return 39}get VK_DOWN(){return 40}get VK_0(){return 48}get VK_1(){return 49}get VK_2(){return 50}get VK_3(){return 51}get VK_4(){return 52}get VK_5(){return 53}get VK_6(){return 54}get VK_7(){return 55}get VK_8(){return 56}get VK_9(){return 57}get VK_A(){return 65}get VK_B(){return 66}get VK_C(){return 67}get VK_D(){return 68}get VK_E(){return 69}get VK_F(){return 70}get VK_G(){return 71}get VK_H(){return 72}get VK_I(){return 73}get VK_J(){return 74}get VK_K(){return 75}get VK_L(){return 76}get VK_M(){return 77}get VK_N(){return 78}get VK_O(){return 79}get VK_P(){return 80}get VK_Q(){return 81}get VK_R(){return 82}get VK_S(){return 83}get VK_T(){return 84}get VK_U(){return 85}get VK_V(){return 86}get VK_W(){return 87}get VK_X(){return 88}get VK_Y(){return 89}get VK_Z(){return 90}get VK_N0(){return 96}get VK_N1(){return 97}get VK_N2(){return 98}get VK_N3(){return 99}get VK_N4(){return 100}get VK_N5(){return 101}get VK_N6(){return 102}get VK_N7(){return 103}get VK_N8(){return 104}get VK_N9(){return 105}get VK_F1(){return 112}get VK_F2(){return 113}get VK_F3(){return 114}get VK_F4(){return 115}get VK_F5(){return 116}get VK_F6(){return 117}get VK_F7(){return 118}get VK_F8(){return 119}get VK_F9(){return 120}get VK_F10(){return 121}get VK_F11(){return 122}get VK_F12(){return 123}get VK_F13(){return 124}get VK_F14(){return 125}get VK_F15(){return 126}get VK_F16(){return 127}get VK_F17(){return 128}get VK_F18(){return 129}get VK_F19(){return 130}get VK_F20(){return 131}get VK_F21(){return 132}get VK_F22(){return 133}get VK_F23(){return 134}get VK_F24(){return 135}}(qe)),qe.regSystem(new class{constructor(t){this[Ct]="Screen",t.regEvent("onStartFrame",this),this.curWidth=1,this.curHeight=1,this.newWidth=1,this.newHeight=1,this.onscreen=!1,this.pr=window.devicePixelRatio||1}onStartFrame(t){performance.mark("screens"),this.newWidth=t.dom.clientWidth*this.pr,this.newHeight=t.dom.clientHeight*this.pr,this.onscreen=!1,this.curWidth!==this.newWidth&&(this.curWidth=this.newWidth,this.onscreen=!0),this.curHeight!==this.newHeight&&(this.curHeight=this.newHeight,this.onscreen=!0),this.onscreen&&t.fireEvent("onScreen"),performance.mark("screene"),performance.measure("screen","screens","screene")}get width(){return this.curWidth}get height(){return this.curHeight}get widthNPR(){return this.curWidth/this.pr}get heightNPR(){return this.curHeight/this.pr}}(qe)),qe.regSystem(new class{constructor(t){this[Vt]="Render",t.regEvent("onStart",this),t.regEvent("onScreen",this),t.regEvent("onRender",this),t.regEvent("onModify",this),this.camera=null,this.envMesh=null,this.batches=new At,this.bid=0,console.log(this.batches)}onStart(t){t.gl.clearColor(.7,.65,.6,1)}onScreen(t){Kt=t.getSystem("Screen"),t.gl.viewport(0,0,Kt.width,Kt.height),t.gldom.width=Kt.width,t.gldom.height=Kt.height}onRender(t){if(performance.mark("rnds"),t.gl.clear(t.gl.COLOR_BUFFER_BIT|t.gl.DEPTH_BUFFER_BIT),this.camera){this.envMesh&&((Nt=t.getRes("material",this.envMesh.material)).use(t),t.getRes("geometry",this.envMesh.geometry).use(t,Nt.shader));for(const e of t.getComp(O))e.disable||(Ot=e.owner.getCompOne(yt),(Nt=t.getRes("material",e.material)).use(t),Nt.shader.setUniform(t,"PM",this.camera.pmat),Nt.shader.setUniform(t,"WM",this.camera.wmat),Nt.shader.setUniform(t,"OM",Ot.wmat),t.getRes("geometry",e.geometry).use(t,Nt.shader))}performance.mark("rnde"),performance.measure("render","rnds","rnde")}onModify(t){for(const e of t.getNewComp(Q))this.camera=e,Kt=t.getSystem("Screen"),this.camera.aspect=Kt.width/Kt.height,this.envMesh=e.owner.getCompOne(O);for(const e of t.getNewComp(O))(Nt=t.getRes("material",e.material)).batch&&(Pt=t.getRes("geometry",e.geometry),(Ut=this.batches.get(e.material,e.geometry))||(Ut=new Mt(t,Pt,Nt,null,this.bid),this.bid++,this.batches.set(e.material,e.geometry,Ut)))}setMainCamera(t){this.camera=t}}(qe)),qe.regSystem(new class{constructor(t){this[kt]="Rotation",t.regEvent("onUpdate",this)}onUpdate(t){for(const e of t.getComp(ht))e.disable||(It=e.owner.getCompOne(yt),Ft.fromAxisAngle(e.axis,e.angle),It.orientation.premul(Ft))}}(qe)),qe.regSystem(new class{constructor(t){this[Wt]="Movement",t.regEvent("onStart",this),t.regEvent("onUpdate",this),this.limearSpeed=new it}onStart(t){this.time=t.getSystem("Time")}onUpdate(t){for(const e of t.getComp(nt))e.disable||(Dt=e.owner.getCompOne(yt),e.linear&&null===e.owner.owner&&Dt.position.addScaledVec(this.limearSpeed,this.time.deltaTime),Dt.position.addScaledVec(e.direction,this.time.deltaTime*e.speed))}}(qe)),qe.regSystem(new class{constructor(t){this[Bt]="OrbitControl",t.regEvent("onStart",this),t.regEvent("onScreen",this),t.regEvent("onLateUpdate",this),this.count=0,this.screen=null}onStart(t){this.screen=t.getSystem("Screen"),this.input=t.getSystem("Input")}onScreen(t){for(const e of t.getComp(ft))e.disable||((Ht=e.owner.getCompOne(Q)).aspect=this.screen.width/this.screen.height,Ht.pmat.perspective(Ht.fov,Ht.aspect,Ht.near,Ht.far))}onLateUpdate(t){Gt=this.input;for(const e of t.getComp(ft))e.disable||(Xt=e.owner.getCompOne(yt),Ht=e.owner.getCompOne(Q),Gt.keyState(Gt.VK_LBUTTON)?(e.pfrozen||(e.polar-=Gt.mouseDeltaPos().y*e.speed),e.afrozen||(e.azimuthal-=Gt.mouseDeltaPos().x*e.speed),Ht.wmat.orbit(e.polar,e.azimuthal,e.distance,Xt.position)):Gt.mouseWheel()?(e.dfrozen||(e.distance-=Gt.mouseWheel()*e.speed*100),Ht.wmat.orbit(e.polar,e.azimuthal,e.distance,Xt.position)):e.nupd&&(e.nupd=!1,Ht.wmat.orbit(e.polar,e.azimuthal,e.distance,Xt.position),Ht.aspect=this.screen.width/this.screen.height,Ht.pmat.perspective(Ht.fov,Ht.aspect,Ht.near,Ht.far)))}}(qe)),qe.regSystem(new class{constructor(t){this[Yt]="Transform",t.regEvent("onTransform",this),t.regEvent("onModify",this)}onTransform(t){performance.mark("trfs");for(const e of t.getEntity())0===e.depth&&this.calcTransform(e);performance.mark("trfe"),performance.measure("transform","trfs","trfe")}onModify(t){for(const e of t.getNewComp(yt))this.calcTransform(e.owner)}calcTransform(t){(qt=t.getCompOne(yt))&&(qt.lmat.fromTRS(qt.position,qt.orientation,qt.scale),qt.wmat.copy(qt.lmat),t.owner&&(jt=t.owner.getCompOne(yt),qt.wmat.mul(jt.wmat)));for(const e of t.child)this.calcTransform(e)}}(qe)),qe.regSystem(new class{constructor(t){this[Jt]="Trigger",t.regEvent("onStart",this),t.regEvent("onPHYUpdate",this)}onStart(){this.tree=new ee(se-re,ie-re,se+re,ie+re,0,ne)}onPHYUpdate(t){performance.mark("trs"),this.tree.clear();for(const e of t.getComp(ct))e.inner.length=0,e.owner.getCompOne(yt).worldPosition(e.pos).add(e.offset),this.tree.adds(e,e.pos.x,e.pos.z,e.radius);for(const e of t.getComp(lt))e.inner.length=0,e.owner.getCompOne(yt).worldPosition(e.pos).add(e.offset),this.tree.adda(e,e.pos.x,e.pos.z,e.size);this.tree.test(),performance.mark("tre"),performance.measure("trigger","trs","tre")}}(qe)),qe.regSystem(new class{constructor(t){this[fe]="Game",t.regEvent("onStart",this),t.regEvent("onUpdate",this),t.regEvent("onLateUpdate",this),this.state=0,this.count=0,this.airplane=null,this.transform=null,this.speed=500,this.xmove=0,this.uibg=document.getElementById("app-ui-bg"),this.uimul=document.getElementById("app-ui-mul"),this.uiscore=document.getElementById("app-ui-score"),this.uiresult=document.getElementById("app-ui-result"),this.mul=1,this.score=0,this.scoredt=0,console.log(t)}onStart(t){this.time=t.getSystem("Time"),this.input=t.getSystem("Input"),this.screen=t.getSystem("Screen"),this.movement=t.getSystem("Movement"),[this.airplane]=t.getEntitiesByName("airplane"),[this.camera]=t.getEntitiesByName("player"),[this.g1]=t.getEntitiesByName("ground1"),[this.g2]=t.getEntitiesByName("ground2"),[this.g3]=t.getEntitiesByName("ground3"),[this.g4]=t.getEntitiesByName("ground4"),this.barrier=new Array(Ce),this.time.timeScale=0,setTimeout(()=>{const e=document.getElementById("app-ui-start");e.innerHTML="START",e.addEventListener("click",()=>{this.uibg.style.display="none",this.time.timeScale=1,this.state=1,this.start(t)}),e.addEventListener("touchstart",()=>{this.uibg.style.display="none",this.time.timeScale=1,this.state=1,this.start(t)})},1e3)}onUpdate(t){if(0!==this.state)for(this.input.keyState(this.input.VK_SPACE)?(this.mul=2,this.speed=0,this.uimul.innerHTML="x2"):(this.mul=1,this.speed=500,this.uimul.innerHTML=null),this.score+=this.time.deltaTime*this.mul*10,this.scoredt+=this.time.deltaTime,this.scoredt>=Le&&(this.scoredt=0,this.uiscore.innerText="".concat(Math.ceil(this.score))),1===this.state?this.movement.limearSpeed.z=-this.speed:this.movement.limearSpeed.z=0,(Ee=this.g1.getCompOne(yt))&&Ee.position.z<-510&&(Ee.position.z+=4e3),(Ee=this.g2.getCompOne(yt))&&Ee.position.z<-510&&(Ee.position.z+=4e3),(Ee=this.g3.getCompOne(yt))&&Ee.position.z<-510&&(Ee.position.z+=4e3),(Ee=this.g4.getCompOne(yt))&&Ee.position.z<-510&&(Ee.position.z+=4e3),this.state&&this.move(),_e=0;_e<Ce;_e++)this.barrier[_e]&&(Ee=this.barrier[_e].getCompOne(yt))&&Ee.position.z<-20&&(t.delEntity(this.barrier[_e]),(xe=Math.random())>.99?we(t,this.barrier,_e,{x:440*(Math.random()-.5),y:0,z:3e3+1e3*Math.random()}):xe>.9?he(t,this.barrier,_e,{x:440*(Math.random()-.5),y:0,z:3e3+1e3*Math.random()}):xe>.8?ae(t,this.barrier,_e,{x:440*(Math.random()-.5),y:0,z:3e3+1e3*Math.random()}):xe>.7?le(t,this.barrier,_e,{x:440*(Math.random()-.5),y:0,z:3e3+1e3*Math.random()}):xe>.6?me(t,this.barrier,_e,{x:440*(Math.random()-.5),y:0,z:3e3+1e3*Math.random()}):xe>.5?ce(t,this.barrier,_e,{x:440*(Math.random()-.5),y:0,z:3e3+1e3*Math.random()}):xe>.48?ue(t,this.barrier,_e,{x:440*(Math.random()-.5),y:0,z:3e3+1e3*Math.random()}):xe>.46?de(t,this.barrier,_e,{x:440*(Math.random()-.5),y:0,z:3e3+1e3*Math.random()}):xe>.44?pe(t,this.barrier,_e,{x:440*(Math.random()-.5),y:0,z:3e3+1e3*Math.random()}):xe>.42?ge(t,this.barrier,_e,{x:440*(Math.random()-.5),y:0,z:3e3+1e3*Math.random()}):xe>.4?ye(t,this.barrier,_e,{x:440*(Math.random()-.5),y:0,z:3e3+1e3*Math.random()}):oe(t,this.barrier,_e,{x:440*(Math.random()-.5),y:6,z:3e3+1e3*Math.random()}))}onLateUpdate(t){(Ee=this.airplane.getCompOne(ct))&&Ee.inner.length>0&&this.state&&(this.time.timeScale=0,this.state=0,setTimeout(()=>{this.uiresult.innerHTML="".concat(Math.ceil(this.score)),this.uibg.style.display="block",this.clear(t)},1e3))}move(){(Ee=this.airplane.getCompOne(yt))&&(xe=0,this.input.keyState(this.input.VK_LEFT)&&(xe+=.5),this.input.keyState(this.input.VK_RIGHT)&&(xe-=.5),this.input.keyState(this.input.VK_LBUTTON)&&(this.input.mousePos().x>.5*this.screen.widthNPR?xe-=.5:xe+=.5),xe>0?(this.xmove+=.05,this.xmove>Se&&(this.xmove=Se)):xe<0?(this.xmove-=.05,this.xmove<-Se&&(this.xmove=-Se)):this.xmove>0?(this.xmove-=.05,this.xmove<0&&(this.xmove=0)):this.xmove<0&&(this.xmove+=.05,this.xmove>0&&(this.xmove=0)),Ee.orientation.fromAxisAngle(be,this.xmove),Ee.position.x-=2*this.xmove,Ee.position.x<-212&&(Ee.position.x=-212),Ee.position.x>216&&(Ee.position.x=216)),(Ee=this.camera.getCompOne(yt))&&(Ee.position.x-=2*this.xmove,Ee.position.x<-212&&(Ee.position.x=-212),Ee.position.x>216&&(Ee.position.x=216)),(Ee=this.camera.getCompOne(ft))&&(Ee.nupd=!0)}clear(t){for(_e=0;_e<Ce;_e++)this.barrier[_e]&&t.delEntity(this.barrier[_e])}start(t){this.score=0,this.uiscore.innerText="0",this.xmove=0,this.createBarrier(t)}createBarrier(t){for(_e=0;_e<Ce;_e++)ze.x=440*(Math.random()-.5),ze.y=0,ze.z=3e3+2e3*Math.random(),_e<50?oe(t,this.barrier,_e,ze):_e<62?he(t,this.barrier,_e,ze):_e<74?ae(t,this.barrier,_e,ze):_e<86?le(t,this.barrier,_e,ze):_e<98?me(t,this.barrier,_e,ze):_e<110?ce(t,this.barrier,_e,ze):_e<113?ue(t,this.barrier,_e,ze):_e<116?de(t,this.barrier,_e,ze):_e<119?pe(t,this.barrier,_e,ze):_e<122?ge(t,this.barrier,_e,ze):_e<125?ye(t,this.barrier,_e,ze):we(t,this.barrier,_e,ze)}}(qe)),qe.loadRes("SceneLoader","./res/scene.json").then(()=>{qe.start()})}]);
//# sourceMappingURL=app.js.map