!function(t){var e={};function s(i){if(e[i])return e[i].exports;var r=e[i]={i:i,l:!1,exports:{}};return t[i].call(r.exports,r,r.exports,s),r.l=!0,r.exports}s.m=t,s.c=e,s.d=function(t,e,i){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)s.d(i,r,function(e){return t[e]}.bind(null,r));return i},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="D:\\$WEB\\prototype\\dist",s(s.s=0)}([function(t,e,s){"use strict";s.r(e);const i=Symbol("gl"),r=Symbol("dom"),n=Symbol("gldom"),h=Symbol("uidom"),o=Symbol("raf"),a=Symbol("res"),l=Symbol("tags"),c=Symbol("comp"),u=Symbol("loop"),m=Symbol("event"),d=Symbol("state"),p=Symbol("owner"),g=Symbol("child"),f=Symbol("depth"),y=Symbol("entity"),w=Symbol("system"),b=Symbol("transform"),x=Symbol.for("name"),_=Symbol("new"),E=Symbol("del"),T=Symbol("modify"),S=Symbol("loader"),v=1<<31,z=1<<30,R=1<<29,C=1<<28;let k=null;const M=new Set;class U{constructor(t){this.core=t}load(t){return fetch(t).then(t=>t.text().then(t=>JSON.parse(t)))}parse(t){return Promise.resolve(t)}conf(t){return Promise.resolve(t)}}class A{constructor(t,e){this[d]=v,this[p]=t,e&&(this[d]|=z|R)}get owner(){return this[p]}get enable(){return!!(this[d]&z)}get disable(){return!(this[d]&z)}get hasEnable(){return!(!(this[d]&~z)||this[d]&~R)}get hasDisable(){return!(this[d]&~z||!(this[d]&~R))}get hasNeedsUpdate(){return!!(this[d]&~C)}set needsUpdate(t){t?this[d]|=C:this[d]&=~C}}class V{constructor(t,e){this[d]=v,this[p]=t,this[x]=null,this[l]=new Set,this[c]=new Map,this[g]=new Set,this[f]=t?t[f]+1:0,this[b]=null,e&&(this[d]|=z|R),null!==t&&t[g].add(this)}get owner(){return this[p]}get enable(){return!!(this[d]&z)}get child(){return this[g]}get depth(){return this[f]}get name(){return this[x]}set name(t){this[x]=t}addTag(t){this[l].add(t)}delTag(t){this[l].delete(t)}hasTag(t){return this[l].has(t)}getComp(t){return void 0===(k=this[c].get(t))&&(k=M),k}getCompOne(t){return void 0!==(k=this[c].get(t))&&([k]=k),void 0!==k?k:null}}let K=null,L=null;const D=Symbol.for("name");class F extends A{constructor(t,e,s){super(t,e),this.iid=-1,this.geometry=s.geometry,this.material=s.material,this.skeleton=void 0!==s.skeleton?s.skeleton:null}}F[D]="Mesh";let P=0,N=0,O=0,B=0,I=0,X=0,W=0,H=0,G=0,Y=0;const j=new Float32Array(16);class Q extends Float32Array{constructor(){super(16),this[0]=1,this[5]=1,this[10]=1,this[15]=1}copy(t){for(Y=0;Y<16;Y++)this[Y]=t[Y];return this}identity(){for(Y=0;Y<16;Y++)this[Y]=Y%5==0?1:0;return this}perspective(t,e,s,i){return this.identity(),this[15]=0,this[14]=-2*i*s/(i-s),this[11]=1,this[10]=(i+s)/(i-s),this[5]=1/Math.tan(.5*t),this[0]=this[5]/e,this}orbit(t,e,s,i){const r=Math.cos(e),n=Math.sin(e),h=Math.cos(t),o=Math.sin(t);return this.identity(),this[0]=r,this[4]=0,this[8]=n,this[1]=n*o,this[5]=h,this[9]=-r*o,this[2]=-n*h,this[6]=o,this[10]=r*h,this[12]=s*(this[2]*this[0]+this[6]*this[4]+this[10]*this[8]),this[13]=s*(this[2]*this[1]+this[6]*this[5]+this[10]*this[9]),this[14]=s*(this[2]*this[2]+this[6]*this[6]+this[10]*this[10]),this[12]-=i.x*this[0]+i.y*this[4]+i.z*this[8],this[13]-=i.x*this[1]+i.y*this[5]+i.z*this[9],this[14]-=i.x*this[2]+i.y*this[6]+i.z*this[10],this}mul(t){for(j[0]=this[0]*t[0]+this[1]*t[4]+this[2]*t[8]+this[3]*t[12],j[1]=this[0]*t[1]+this[1]*t[5]+this[2]*t[9]+this[3]*t[13],j[2]=this[0]*t[2]+this[1]*t[6]+this[2]*t[10]+this[3]*t[14],j[3]=this[0]*t[3]+this[1]*t[7]+this[2]*t[11]+this[3]*t[15],j[4]=this[4]*t[0]+this[5]*t[4]+this[6]*t[8]+this[7]*t[12],j[5]=this[4]*t[1]+this[5]*t[5]+this[6]*t[9]+this[7]*t[13],j[6]=this[4]*t[2]+this[5]*t[6]+this[6]*t[10]+this[7]*t[14],j[7]=this[4]*t[3]+this[5]*t[7]+this[6]*t[11]+this[7]*t[15],j[8]=this[8]*t[0]+this[9]*t[4]+this[10]*t[8]+this[11]*t[12],j[9]=this[8]*t[1]+this[9]*t[5]+this[10]*t[9]+this[11]*t[13],j[10]=this[8]*t[2]+this[9]*t[6]+this[10]*t[10]+this[11]*t[14],j[11]=this[8]*t[3]+this[9]*t[7]+this[10]*t[11]+this[11]*t[15],j[12]=this[12]*t[0]+this[13]*t[4]+this[14]*t[8]+this[15]*t[12],j[13]=this[12]*t[1]+this[13]*t[5]+this[14]*t[9]+this[15]*t[13],j[14]=this[12]*t[2]+this[13]*t[6]+this[14]*t[10]+this[15]*t[14],j[15]=this[12]*t[3]+this[13]*t[7]+this[14]*t[11]+this[15]*t[15],Y=0;Y<16;Y++)this[Y]=j[Y];return this}premul(t){for(j[0]=t[0]*this[0]+t[1]*this[4]+t[2]*this[8]+t[3]*this[12],j[1]=t[0]*this[1]+t[1]*this[5]+t[2]*this[9]+t[3]*this[13],j[2]=t[0]*this[2]+t[1]*this[6]+t[2]*this[10]+t[3]*this[14],j[3]=t[0]*this[3]+t[1]*this[7]+t[2]*this[11]+t[3]*this[15],j[4]=t[4]*this[0]+t[5]*this[4]+t[6]*this[8]+t[7]*this[12],j[5]=t[4]*this[1]+t[5]*this[5]+t[6]*this[9]+t[7]*this[13],j[6]=t[4]*this[2]+t[5]*this[6]+t[6]*this[10]+t[7]*this[14],j[7]=t[4]*this[3]+t[5]*this[7]+t[6]*this[11]+t[7]*this[15],j[8]=t[8]*this[0]+t[9]*this[4]+t[10]*this[8]+t[11]*this[12],j[9]=t[8]*this[1]+t[9]*this[5]+t[10]*this[9]+t[11]*this[13],j[10]=t[8]*this[2]+t[9]*this[6]+t[10]*this[10]+t[11]*this[14],j[11]=t[8]*this[3]+t[9]*this[7]+t[10]*this[11]+t[11]*this[15],j[12]=t[12]*this[0]+t[13]*this[4]+t[14]*this[8]+t[15]*this[12],j[13]=t[12]*this[1]+t[13]*this[5]+t[14]*this[9]+t[15]*this[13],j[14]=t[12]*this[2]+t[13]*this[6]+t[14]*this[10]+t[15]*this[14],j[15]=t[12]*this[3]+t[13]*this[7]+t[14]*this[11]+t[15]*this[15],Y=0;Y<16;Y++)this[Y]=j[Y];return this}fromTRS(t,e,s){return this[3]=0,this[7]=0,this[11]=0,this[15]=1,P=2*e.x*e.x,N=2*e.y*e.y,O=2*e.z*e.z,B=2*e.x*e.y,I=2*e.x*e.z,X=2*e.x*e.w,W=2*e.y*e.z,H=2*e.y*e.w,G=2*e.z*e.w,this[0]=s.x*(1-N-O),this[1]=s.x*(B+G),this[2]=s.x*(I-H),this[4]=s.y*(B-G),this[5]=s.y*(1-P-O),this[6]=s.y*(W+X),this[8]=s.z*(I+H),this[9]=s.z*(W-X),this[10]=s.z*(1-P-N),this[12]=t.x,this[13]=t.y,this[14]=t.z,this}fromTRSC(t,e,s){return this[3]=0,this[7]=0,this[11]=0,this[15]=1,P=2*e.x*e.x,N=2*e.y*e.y,O=2*e.z*e.z,B=2*-e.x*-e.y,I=2*-e.x*-e.z,X=2*-e.x*-e.w,W=2*-e.y*-e.z,H=2*-e.y*-e.w,G=2*-e.z*-e.w,this[0]=(1-N-O)/s.x,this[1]=(B+G)/s.x,this[2]=(I-H)/s.x,this[4]=(B-G)/s.y,this[5]=(1-P-O)/s.y,this[6]=(W+X)/s.y,this[8]=(I+H)/s.z,this[9]=(W-X)/s.z,this[10]=(1-P-N)/s.z,this[12]=-t.x*this[0]-t.y*this[4]-t.z*this[8],this[13]=-t.x*this[1]-t.y*this[5]-t.z*this[9],this[14]=-t.x*this[2]-t.y*this[6]-t.z*this[10],this}}const q=Symbol.for("name");class J extends A{constructor(t,e,s){super(t,e),this.aspect=s.aspect||1,this.fov=s.fov||.7,this.near=s.near||1,this.far=s.far||1e3,this.pmat=new Q,this.wmat=new Q}}J[q]="Camera";let Z=0,$=0,tt=0,et=0,st=0;class it{constructor(t=0,e=0,s=0){this.x=t,this.y=e,this.z=s}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}set(t,e,s){return this.x=t,this.y=e,this.z=s,this}normalize(){return Z=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z),this.x/=Z,this.y/=Z,this.z/=Z,this}abs(){return this.x=Math.abs(this.x),this.y=Math.abs(this.y),this.z=Math.abs(this.z),this}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this}mins(t){return this.x=Math.min(this.x,t),this.y=Math.min(this.y,t),this.z=Math.min(this.z,t),this}maxs(t){return this.x=Math.max(this.x,t),this.y=Math.max(this.y,t),this.z=Math.max(this.z,t),this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}addScaledVec(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this}applyQuat(t){return $=t.w*this.x+t.y*this.z-t.z*this.y,tt=t.w*this.y+t.z*this.x-t.x*this.z,et=t.w*this.z+t.x*this.y-t.y*this.x,st=-t.x*this.x-t.y*this.y-t.z*this.z,this.x=$*t.w-st*t.x-tt*t.z+et*t.y,this.y=tt*t.w-st*t.y-et*t.x+$*t.z,this.z=et*t.w-st*t.z-$*t.y+tt*t.x,this}mulNumber(t){return this.x*=t,this.y*=t,this.z*=t,this}get length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}}const rt=Symbol.for("name");class nt extends A{constructor(t,e,s){super(t,e),this.speed=void 0!==s.speed?s.speed:0,this.linear=void 0===s.linear||s.linear,this.direction=new it(0,0,-1),void 0!==s.direction&&this.direction.copy(s.direction)}}nt[rt]="Movement";const ht=Symbol.for("name");class ot extends A{constructor(t,e,s){super(t,e),this.axis=new it,this.angle=s.angle||0,s.axis&&this.axis.copy(s.axis)}}ot[ht]="Rotation";const at=Symbol.for("name");class lt extends A{constructor(t,e,s){super(t,e),this.pos=new it,this.next=null,this.inner=[],this.mask=void 0!==s.mask?s.mask:4294967295,this.offset=new it,void 0!==s.offset&&this.offset.copy(s.offset),this.size=new it,void 0!==s.size&&this.size.copy(s.size)}}lt[at]="ATrigger";const ct=Symbol.for("name");class ut extends A{constructor(t,e,s){super(t,e),this.pos=new it,this.next=null,this.inner=[],this.mask=void 0!==s.mask?s.mask:4294967295,this.offset=new it,void 0!==s.offset&&this.offset.copy(s.offset),this.radius=void 0!==s.radius?s.radius:0}}ut[ct]="STrigger";const mt=Symbol.for("name");class dt extends A{constructor(t,e,s){super(t,e),this.skeleton=void 0!==s.skeleton?s.skeleton:null,this.animation=void 0!==s.animation?s.animation:null,this.loop=!0,this.stop=!1,this.time=0,this.key=new it}}dt[mt]="Animator";let pt=null;class gt{constructor(t=0,e=0,s=0,i=1){this.x=t,this.y=e,this.z=s,this.w=i}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this}set(t,e,s,i){return this.x=t,this.y=e,this.z=s,this.w=i,this}mul(t){const e=this.x,s=this.y,i=this.z,r=this.w;return this.x=r*t.x+e*t.w+s*t.z-i*t.y,this.y=r*t.y-e*t.z+s*t.w+i*t.x,this.z=r*t.z+e*t.y-s*t.x+i*t.w,this.w=r*t.w-e*t.x-s*t.y-i*t.z,this}premul(t){const e=this.x,s=this.y,i=this.z,r=this.w;return this.x=t.w*e+t.x*r+t.y*i-t.z*s,this.y=t.w*s-t.x*i+t.y*r+t.z*e,this.z=t.w*i+t.x*s-t.y*e+t.z*r,this.w=t.w*r-t.x*e-t.y*s-t.z*i,this}fromAxisAngle(t,e){return pt=Math.sin(.5*e),this.x=t.x*pt,this.y=t.y*pt,this.z=t.z*pt,this.w=Math.cos(.5*e),this}}const ft=Symbol.for("name");class yt extends A{constructor(t,e,s){super(t,e),this.position=new it,this.orientation=new gt,this.scale=new it(1,1,1),s.scale&&this.scale.copy(s.scale),s.position&&this.position.copy(s.position),s.orientation&&this.orientation.copy(s.orientation),this.lmat=new Q,this.wmat=new Q}worldPosition(t){return t.x=this.wmat[12],t.y=this.wmat[13],t.z=this.wmat[14],t}}yt[ft]="Transform";const wt=Symbol.for("name");class bt extends A{constructor(t,e,s){super(t,e),this.polar=s.polar||0,this.azimuthal=s.azimuthal||0,this.distance=s.distance||0,this.forward=new it,this.speed=s.speed||.004,this.nupd=!0,this.afrozen=s.afrozen||!1,this.pfrozen=s.pfrozen||!1,this.dfrozen=s.dfrozen||!1}}bt[wt]="OrbitControl";const xt=Symbol.for("name");const _t=Symbol.for("name");let Et=null,Tt=null;const St=Symbol.for("name");const vt=Symbol.for("name");let zt=null,Rt=null,Ct=null,kt=null,Mt=null;const Ut=Symbol.for("name");let At=null;const Vt=new gt;const Kt=Symbol.for("name");let Lt=null;const Dt=Symbol.for("name");let Ft=null,Pt=null,Nt=null;const Ot=Symbol.for("name");let Bt=null,It=null;const Xt=Symbol.for("name"),Wt=new it;function Ht(t,e){return Wt.copy(t.pos).sub(e.pos),Wt.length-t.radius-e.radius<=0}function Gt(t,e){return Wt.copy(e.pos).sub(t.pos).abs().sub(t.size).maxs(0),Wt.length-e.radius<=0}function Yt(t,e){return Wt.copy(e.pos).sub(t.pos).abs().sub(t.size).sub(e.size),Wt.x<=0&&Wt.y<=0&&Wt.z<=0}class jt{constructor(t,e,s,i,r,n){this.child=null,this.inner=!1,this.xl=t,this.yl=e,this.xh=s,this.yh=i,this.c1=null,this.c2=null,this.bs=null,this.es=null,this.ba=null,this.ea=null,this.tx=.5*(t+s),this.ty=.5*(e+i),r<n&&(this.child=new Array(4),this.child[0]=new jt(t,e,this.tx,this.ty,r+1,n),this.child[1]=new jt(this.tx,e,s,this.ty,r+1,n),this.child[2]=new jt(t,this.ty,this.tx,i,r+1,n),this.child[3]=new jt(this.tx,this.ty,s,i,r+1,n))}clear(){this.bs=null,this.es=null,this.ba=null,this.ea=null,this.child&&this.inner&&(this.child[0].clear(),this.child[1].clear(),this.child[2].clear(),this.child[3].clear()),this.inner=!1}adds(t,e,s,i){this.tx=.5*(this.xl+this.xh),this.ty=.5*(this.yl+this.yh),this.child?e+i<this.tx&&s+i<this.ty?(this.inner=!0,this.child[0].adds(t,e,s,i)):e-i>this.tx&&s+i<this.ty?(this.inner=!0,this.child[1].adds(t,e,s,i)):e+i<this.tx&&s-i>this.ty?(this.inner=!0,this.child[2].adds(t,e,s,i)):e-i>this.tx&&s-i>this.ty?(this.inner=!0,this.child[3].adds(t,e,s,i)):(null===this.es?this.bs=t:this.es.next=t,this.es=t,t.next=null):(null===this.es?this.bs=t:this.es.next=t,this.es=t,t.next=null)}adda(t,e,s,i){this.tx=.5*(this.xl+this.xh),this.ty=.5*(this.yl+this.yh),this.child?e+i.x<this.tx&&s+i.z<this.ty?(this.inner=!0,this.child[0].adda(t,e,s,i)):e-i.x>this.tx&&s+i.z<this.ty?(this.inner=!0,this.child[1].adda(t,e,s,i)):e+i.x<this.tx&&s-i.z>this.ty?(this.inner=!0,this.child[2].adda(t,e,s,i)):e-i.x>this.tx&&s-i.z>this.ty?(this.inner=!0,this.child[3].adda(t,e,s,i)):(null===this.ea?this.ba=t:this.ea.next=t,this.ea=t,t.next=null):(null===this.ea?this.ba=t:this.ea.next=t,this.ea=t,t.next=null)}test(){for(this.c1=this.bs;null!==this.c1;this.c1=this.c1.next){for(this.c2=this.c1.next;null!==this.c2;this.c2=this.c2.next)Ht(this.c1,this.c2)&&(this.c1.inner.push(this.c2),this.c2.inner.push(this.c1));for(this.c2=this.ba;null!==this.c2;this.c2=this.c2.next)Gt(this.c2,this.c1)&&(this.c1.inner.push(this.c2),this.c2.inner.push(this.c1));this.inner&&this.child&&(this.child[0].tests(this.c1),this.child[1].tests(this.c1),this.child[2].tests(this.c1),this.child[3].tests(this.c1))}for(this.c1=this.ba;null!==this.c1;this.c1=this.c1.next){for(this.c2=this.c1.next;null!==this.c2;this.c2=this.c2.next)Yt(this.c1,this.c2)&&(this.c1.inner.push(this.c2),this.c2.inner.push(this.c1));this.inner&&this.child&&(this.child[0].testa(this.c1),this.child[1].testa(this.c1),this.child[2].testa(this.c1),this.child[3].testa(this.c1))}this.inner&&this.child&&(this.child[0].test(),this.child[1].test(),this.child[2].test(),this.child[3].test())}tests(t){for(this.c1=this.bs;null!==this.c1;this.c1=this.c1.next)Ht(this.c1,t)&&(this.c1.inner.push(t),t.inner.push(this.c1));for(this.c1=this.ba;null!==this.c1;this.c1=this.c1.next)Gt(this.c1,t)&&(this.c1.inner.push(t),t.inner.push(this.c1));this.inner&&this.child&&(this.child[0].tests(t),this.child[1].tests(t),this.child[2].tests(t),this.child[3].tests(t))}testa(t){for(this.c1=this.ba;null!==this.c1;this.c1=this.c1.next)Yt(this.c1,t)&&(this.c1.inner.push(t),t.inner.push(this.c1));for(this.c1=this.bs;null!==this.c1;this.c1=this.c1.next)Gt(t,this.c1)&&(this.c1.inner.push(t),t.inner.push(this.c1));this.inner&&this.child&&(this.child[0].testa(t),this.child[1].testa(t),this.child[2].testa(t),this.child[3].testa(t))}}const Qt=0,qt=700,Jt=1024,Zt=5;const $t=Symbol.for("name");let te=0,ee=null,se=null,ie=0,re=null,ne=null;const he=Symbol.for("name");let oe=0,ae=0,le=null;const ce=new it(0,0,1),ue=128;class me{constructor(t=0,e=0){this.x=t,this.y=e}}class de{constructor(t=0,e=0,s=0,i=0){this.x=t,this.y=e,this.z=s,this.w=i}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this}}class pe{constructor(t=null,e=0){this.texture=t,this.layer=e}copy(t){this.texture=t.texture,this.layer=t.layer}}class ge{constructor(){this.program=null,this.uniform={},this.attribute={}}use(t){t.gl.useProgram(this.program)}setUniform(t,e,s){switch(s.constructor){case Number:t.gl.uniform2f(this.uniform[e],s);break;case me:t.gl.uniform2f(this.uniform[e],s.x,s.y);break;case it:t.gl.uniform3f(this.uniform[e],s.x,s.y,s.z);break;case de:case gt:t.gl.uniform4f(this.uniform[e],s.x,s.y,s.z,s.w);break;case pe:t.gl.uniform1i(this.uniform[e],s.layer),s.texture.use(t,s.layer);break;case Q:t.gl.uniformMatrix4fv(this.uniform[e],!1,s);break;default:throw new Error("Type of value not found")}}}const fe=Symbol.for("name");class ye extends U{parse(t){if("string"!=typeof t.name||""===t.name)throw new Error("Shader not named");const e=this.core.gl,s=e.createShader(e.VERTEX_SHADER),i=e.createShader(e.FRAGMENT_SHADER),r=new ge;if(r.program=e.createProgram(),e.shaderSource(s,t.vs),e.compileShader(s),e.shaderSource(i,t.fs),e.compileShader(i),!e.getShaderParameter(s,e.COMPILE_STATUS))throw new Error(e.getShaderInfoLog(s));if(!e.getShaderParameter(i,e.COMPILE_STATUS))throw new Error(e.getShaderInfoLog(i));if(e.attachShader(r.program,s),e.attachShader(r.program,i),e.linkProgram(r.program),!e.getProgramParameter(r.program,e.LINK_STATUS))throw new Error(e.getProgramInfoLog(r.program));e.deleteShader(s),e.deleteShader(i);for(let t=0;t<e.getProgramParameter(r.program,e.ACTIVE_UNIFORMS);t++){const s=e.getActiveUniform(r.program,t).name;s.includes("gl_")||(r.uniform[s]=e.getUniformLocation(r.program,s))}for(let t=0;t<e.getProgramParameter(r.program,e.ACTIVE_ATTRIBUTES);t++){const s=e.getActiveAttrib(r.program,t).name;s.includes("gl_")||(r.attribute[s]=e.getAttribLocation(r.program,s))}return this.core.addRes("shader",t.name,r),Promise.resolve(r)}}ye.prototype[fe]="RawShaderLoader";let we=null;class be{constructor(){this.shader=null,this.depthtest=!0,this.depthwrite=!0,this.cullFace=0,this.blend=0,this.uniform={}}use(t){switch(we=t.gl,this.shader.use(t),this.depthtest?we.enable(we.DEPTH_TEST):we.disable(we.DEPTH_TEST),we.depthMask(this.depthwrite),this.cullFace){case 0:we.disable(we.CULL_FACE);break;case 1:we.enable(we.CULL_FACE),we.cullFace(we.BACK);break;case 2:we.enable(we.CULL_FACE),we.cullFace(we.FRONT);break;case 3:we.enable(we.CULL_FACE),we.cullFace(we.FRONT_AND_BACK);break;default:we.disable(we.CULL_FACE)}switch(this.blend){case 0:we.disable(we.BLEND);break;case 1:we.enable(we.BLEND);break;default:we.disable(we.BLEND)}for(const e in this.uniform)this.shader.setUniform(t,e,this.uniform[e])}}const xe=Symbol.for("name");class _e extends U{parse(t){if("string"!=typeof t.name||""===t.name)throw new Error("Material not named");const e=new be;e.shader=t.shader,e.depthtest=void 0===t.depthtest||t.depthtest,e.depthwrite=void 0===t.depthwrite||t.depthwrite,e.cullFace=void 0!==t.cullFace?t.cullFace:0,e.blend=void 0!==t.blend?t.blend:0;for(const s in t.uniform)switch(t.uniform[s].type){case"Float":e.uniform[s]=t.uniform[s].value;break;case"Vec2":e.uniform[s]=new me,e.uniform[s].copy(t.uniform[s].value);break;case"Vec3":e.uniform[s]=new it,e.uniform[s].copy(t.uniform[s].value);break;case"Vec4":e.uniform[s]=new de,e.uniform[s].copy(t.uniform[s].value);break;case"Texture":e.uniform[s]=new pe,e.uniform[s].copy(t.uniform[s].value);break;default:throw new Error("Uniform type not found")}return this.core.addRes("material",t.name,e),Promise.resolve(e)}conf(t){t.shader=this.core.getRes("shader",t.shader);for(const e in t.uniform)t.uniform[e]instanceof pe&&(t.uniform[e].texture=this.core.getRes("texture",t.uniform[e].texture));return Promise.resolve(t)}}_e.prototype[xe]="MaterialLoader";const Ee=Symbol.for("name");class Te extends U{load(t){return new Promise((e,s)=>{const i=new Image,r=t.substring(t.lastIndexOf("/")+1,t.lastIndexOf("."));i.onload=(()=>{e(i),this.core.addRes("image",r,i)}),i.onerror=(()=>{s(i)}),i.src=t})}}Te.prototype[Ee]="ImageLoader";let Se=null;class ve{constructor(){this.image=null,this.tex=null,this.type=3553}use(t,e){(Se=t.gl).activeTexture(Se.TEXTURE0+e),Se.bindTexture(this.type,this.tex)}}const ze=Symbol.for("name");class Re extends U{parse(t){if("string"!=typeof t.name||""===t.name)throw new Error("Texture not named");const e=this.core.gl,s=new ve;return s.image=t.image,s.type=e.TEXTURE_2D,s.tex=e.createTexture(),this.core.addRes("texture",t.name,s),Promise.resolve(s)}conf(t){const e=this.core.gl;return t.image=this.core.getRes("image",t.image),e.bindTexture(e.TEXTURE_2D,t.tex),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t.image),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR_MIPMAP_LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT),e.texParameterf(e.TEXTURE_2D,e.TEXTURE_MAX_ANISOTROPY_EXT,8),e.generateMipmap(e.TEXTURE_2D),e.bindTexture(e.TEXTURE_2D,null),Promise.resolve(t)}}Re.prototype[ze]="Texture2DLoader";let Ce=null;class ke{constructor(){this.attribute={},this.length=0,this.vbo=null,this.ebo=null}use(t,e){(Ce=t.gl).bindBuffer(Ce.ARRAY_BUFFER,this.vbo);for(const t in this.attribute)void 0!==e.attribute[t]&&(Ce.enableVertexAttribArray(e.attribute[t]),Ce.vertexAttribPointer(e.attribute[t],this.attribute[t].size,this.attribute[t].type,!1,this.attribute[t].stride,this.attribute[t].offset));Ce.bindBuffer(Ce.ELEMENT_ARRAY_BUFFER,this.ebo),Ce.drawElements(Ce.TRIANGLES,this.length,Ce.UNSIGNED_SHORT,0);for(const t in this.attribute)void 0!==e.attribute[t]&&Ce.disableVertexAttribArray(e.attribute[t])}}const Me=Symbol.for("name");class Ue extends U{parse(t){if("string"!=typeof t.name||""===t.name)throw new Error("Geometry not named");const e=this.core.gl,s=new ke;for(const e in t.attribute)s.attribute[e]=t.attribute[e];return s.vbo=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,s.vbo),e.bufferData(e.ARRAY_BUFFER,new Float32Array(t.vbo),e.STATIC_DRAW),s.ebo=e.createBuffer(),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,s.ebo),e.bufferData(e.ELEMENT_ARRAY_BUFFER,new Uint16Array(t.ebo),e.STATIC_DRAW),s.length=t.ebo.length,this.core.addRes("geometry",t.name,s),Promise.resolve(s)}}Ue.prototype[Me]="GeometryLoader";let Ae=null;const Ve=new it;class Ke{constructor(){this.bones=[],this.bakeMap=null,this.bakeTex=null,this.bakeData=null,this.bakeLayer=0}getLRByKey(t,e){for(Ae of this.bones)Ae.loc.set(0,0,0),Ae.rot.set(0,0,0,1);for(const s of e.samplers[0].out)(Ae=this.bones[s.bone]).lloc.copy(e.channels[s.loc][t]),Ae.lrot.copy(e.channels[s.rot][t])}calcLR(){for(Ae of this.bones)-1===Ae.parent?(Ae.rot.copy(Ae.lrot),Ae.loc.copy(Ae.lloc),Ae.sloc.copy(Ae.head).add(Ae.offset),Ae.hloc.copy(Ae.head).applyQuat(Ae.rot).add(Ae.offset)):(Ae.rot.copy(Ae.lrot).premul(this.bones[Ae.parent].rot),Ve.copy(this.bones[Ae.parent].sloc).applyQuat(Ae.rot),Ae.loc.copy(Ae.lloc).applyQuat(this.bones[Ae.parent].rot).sub(Ve).add(this.bones[Ae.parent].hloc),Ve.copy(Ae.offset).applyQuat(this.bones[Ae.parent].rot),Ae.sloc.copy(Ae.head).add(Ae.offset).add(this.bones[Ae.parent].sloc),Ae.hloc.copy(Ae.head).applyQuat(Ae.rot).add(this.bones[Ae.parent].hloc).add(Ve))}}const Le=Symbol.for("name");let De=null,Fe=null,Pe=null;class Ne extends U{parse(t){if("string"!=typeof t.name||""===t.name)throw new Error("Material not named");const e=new Ke;for(let s=0;s<t.bones.length;s++)De=Object.create(null),Fe=t.bones[s],De.parent=Fe[0],De.offset=new it(Fe[1],Fe[2],Fe[3]),De.head=new it(Fe[4],Fe[5],Fe[6]),De.loc=new it,De.rot=new gt,De.lloc=new it,De.lrot=new gt,De.hloc=new it,De.sloc=new it,e.bones[s]=De;return e.bakeMap=new Map,e.bakeData=new Float32Array(4194304),Pe=this.core.gl,e.bakeTex=Pe.createTexture(),Pe.bindTexture(Pe.TEXTURE_2D,e.bakeTex),Pe.texImage2D(Pe.TEXTURE_2D,0,Pe.RGBA,1024,1024,0,Pe.RGBA,Pe.FLOAT,e.bakeData),Pe.texParameteri(Pe.TEXTURE_2D,Pe.TEXTURE_MAG_FILTER,Pe.NEAREST),Pe.texParameteri(Pe.TEXTURE_2D,Pe.TEXTURE_MIN_FILTER,Pe.NEAREST),Pe.bindTexture(Pe.TEXTURE_2D,null),this.exampleAnimation(e),this.core.addRes("skeleton",t.name,e),Promise.resolve(e)}exampleAnimation(t){t.bakeMap.set("test",{end:59,layer:0});for(let e=0;e<4;e++){for(let s=0;s<60;s++)t.bakeData[8*s+1+1024*e]=Math.abs(.3-.01*s);t.bakeData[481+1024*e]=.3}for(let e=0;e<523264;e++)t.bakeData[8*e+4]=0,t.bakeData[8*e+5]=0,t.bakeData[8*e+6]=Math.sin(Math.abs(.08-e%16*.01)),t.bakeData[8*e+7]=Math.cos(Math.abs(.08-e%16*.01));(Pe=this.core.gl).bindTexture(Pe.TEXTURE_2D,t.bakeTex),Pe.texSubImage2D(Pe.TEXTURE_2D,0,0,0,1024,1024,Pe.RGBA,Pe.FLOAT,t.bakeData),Pe.bindTexture(Pe.TEXTURE_2D,null)}}Ne.prototype[Le]="SkeletonLoader";class Oe{constructor(){this.channels=[],this.samplers=[]}}const Be=Symbol.for("name");let Ie=0,Xe=null,We=null;class He extends U{parse(t){if("string"!=typeof t.name||""===t.name)throw new Error("Material not named");const e=new Oe;for(const s of t.channels){switch(We=[],s.type){case"time":for(Ie=0;Ie<s.data.length;Ie++)We.push(s.data[Ie]);break;case"loc":for(Ie=0;Ie<s.data.length;Ie+=3)We.push(new it(s.data[Ie],s.data[Ie+1],s.data[Ie+2]));break;case"rot":for(Ie=0;Ie<s.data.length;Ie+=4)We.push(new gt(-s.data[Ie],-s.data[Ie+1],-s.data[Ie+2],s.data[Ie+3]))}e.channels.push(We)}for(const s of t.samplers){(We=Object.create(null)).time=s.time,We.out=[];for(const t of s.out)(Xe=Object.create(null)).bone=t.bone,Xe.loc=void 0!==t.loc?t.loc:-1,Xe.rot=void 0!==t.rot?t.rot:-1,We.out.push(Xe);e.samplers.push(We)}return this.core.addRes("animation",t.name,e),Promise.resolve(e)}}He.prototype[Be]="AnimationLoader";const Ge=Symbol.for("name");class Ye extends U{parse(t){const e=[],s=[];for(const i of t.res){const t=this.core.getLoader(i.loader);s.push(t),"string"==typeof i.conf?e.push(t.load(i.conf).then(e=>t.parse(e))):e.push(t.parse(i.conf))}return Promise.all(e).then(t=>{const e=[];for(let i=0;i<t.length;i++)e.push(s[i].conf(t[i]));return Promise.all(e)}).then(()=>{const e=[];let s=null;for(const i of t.ent){s=void 0!==i.owner&&null!==i.owner?e[i.owner]:null;const t=this.core.newEntity(s,i.enable||!0);if(e.push(t),i.name&&(t.name=i.name),i.tags)for(const e of i.tags)t.addTag(e);if(i.comp)for(const e of i.comp){const s=this.core.getCompClassByName(e.type);void 0===e.enable&&(e.enable=!0),this.core.newComp(s,t,e.enable,e.conf)}}})}}Ye.prototype[Ge]="SceneLoader";const je=new class{constructor(t,e){if(this[r]=document.getElementById(t),this[n]=document.getElementById("app-gl"),this[h]=document.getElementById("app-ui"),this[c]=new Map,this[y]={useEntity:new Set,delEntity:new Set},this[S]=new Map,this[w]=new Map,this[m]=new Map,this[a]=new Map,this[i]=this[n].getContext("webgl",e),null===this[i])throw new Error("Get 3d context is failed");L=this[i].getExtension("OES_texture_float"),L=this[i].getExtension("EXT_texture_filter_anisotropic");for(const t in L)this[i][t]=L[t];this[d]=!1,this[T]=!1,this[o]=0,this[u]=(()=>{performance.mark("frs"),this.fireEvent("onStartFrame"),this.fireEvent("onUpdate"),this.fireEvent("onTransform"),this.fireEvent("onPHYUpdate"),this.fireEvent("onLateUpdate"),this.fireEvent("onRender"),this[T]&&(this[_](),this.fireEvent("onModify"),this[E](),this[T]=!1),this[o]=requestAnimationFrame(this[u]),performance.mark("fre"),performance.measure("frame","frs","fre"),performance.clearMarks(),performance.clearMeasures()})}start(){this[o]=requestAnimationFrame(this[u]),this[d]=!0,this.fireEvent("onStart")}stop(){cancelAnimationFrame(this[o]),this[o]=0,this[d]=!1}addRes(t,e,s){this[a].has(t)||this[a].set(t,{});const i=this[a].get(t);if(void 0!==i[e])throw new Error("Resource with this name already used");i[e]=s}getRes(t,e){if(!this[a].has(t))throw new Error("Resource type not found");if(void 0===(K=this[a].get(t)[e]))throw new Error("Resource not found");return K}loadRes(t,e){if(!this[S].has(t))throw new Error("Loader not found");const s=this[S].get(t);return s.load(e).then(t=>s.parse(t).then(t=>s.conf(t)))}parseRes(t,e){if(!this[S].has(t))throw new Error("Loader not found");const s=this[S].get(t);return s.parse(e).then(t=>s.conf(t))}regLoader(t){if(void 0===t[x])throw new Error("Loader not named");if(this[S].has(t))throw new Error("Loader already used");this[S].set(t[x],t)}getLoader(t){if(!this[S].has(t))throw new Error("Loader not found");return this[S].get(t)}regSystem(t){if(void 0===t[x])throw new Error("System not named");if(this[w].has(t[x]))throw new Error("System already used");this[w].set(t[x],t)}getSystem(t){return this[w].get(t)}regEvent(t,e){this[m].has(t)||this[m].set(t,[]),this[m].get(t).push(e)}fireEvent(t){const e=this[m].get(t);if(void 0!==e)for(const s of e)s[t](this)}newEntity(t,e){const s=new V(t,e);return this[y].useEntity.add(s),this[T]=!0,s}delEntity(t){this[y].delEntity.add(t),this[T]=!0}enableEntity(t,e){e?t[d]|=R:t[d]&=~R;for(const s of t[c])this.enableComp(s,e);for(const s of t[g])this.enableEntity(s,e)}getEntity(){return this[y].useEntity}getEntitiesByName(t,e=[]){e.length=0;for(const s of this[y].useEntity)s[x]===t&&e.push(s);return e}newComp(t,e,s,i){const r=this[c].get(t);if(void 0===r)throw new Error("Component class not registered");const n=new t(e,s,i);return r.newComp.add(n),this[T]=!0,n}delComp(t){this[c].get(t.constructor).delComp.add(t),this[T]=!0}enableComp(t,e){e?t[d]|=R:t[d]&=~R,this[c].get(t.constructor).modComp.add(t),this[T]=!0}getComp(t){return this[c].get(t).useComp}getNewComp(t){return this[c].get(t).newComp}getDelComp(t){return this[c].get(t).delComp}getModComp(t){return this[c].get(t).modComp}regComp(t){if(void 0===t[x])throw new Error("Component class not named");if(this[c].has(t))throw new Error("Component class already used");this[c].set(t,{newComp:new Set,useComp:new Set,delComp:new Set,modComp:new Set})}getCompClassByName(t){for(const e of this[c].keys())if(e[x]===t)return e;throw new Error("Component class not found")}get gl(){return this[i]}get dom(){return this[r]}get gldom(){return this[n]}get uidom(){return this[h]}[_](){for(const t of this[c].values())for(const e of t.newComp)t.useComp.add(e),e.owner[c].has(e.constructor)||e.owner[c].set(e.constructor,new Set),e.owner[c].get(e.constructor).add(e);for(const t of this[y].delEntity){for(const e of t[c].keys())for(const s of t[c].get(e))this.delComp(s);for(const e of t[g])this.delEntity(e)}}[E](){for(const t of this[y].delEntity)this[y].useEntity.delete(t);this[y].delEntity.clear();for(const t of this[c].values()){for(const e of t.modComp)e[d]&e[p][d]&R?e[d]|=z:e[d]&=~z,e[d]&=~C;for(const e of t.delComp)t.useComp.delete(e),e[p][c].get(e.constructor).delete(e);t.newComp.clear(),t.delComp.clear(),t.modComp.clear()}}}("app",{alpha:!1});je.regLoader(new ye(je)),je.regLoader(new _e(je)),je.regLoader(new Te(je)),je.regLoader(new Re(je)),je.regLoader(new Ue(je)),je.regLoader(new Ne(je)),je.regLoader(new He(je)),je.regLoader(new Ye(je)),je.regComp(F),je.regComp(J),je.regComp(nt),je.regComp(ot),je.regComp(lt),je.regComp(ut),je.regComp(dt),je.regComp(yt),je.regComp(bt),je.regSystem(new class{constructor(t){this[xt]="Time",t.regEvent("onStartFrame",this),this._time=performance.now(),this._currentTime=0,this._deltaTime=0,this._timeScale=1}onStartFrame(){this._deltaTime=Math.max(performance.now()-this._time,1e-5)*this._timeScale*.001,this._time=performance.now(),this._currentTime+=this._deltaTime}get time(){return this._currentTime}get deltaTime(){return this._deltaTime}get timeScale(){return this._timeScale}set timeScale(t){this._timeScale=t}}(je)),je.regSystem(new class{constructor(t){this[_t]="Input",t.regEvent("onStartFrame",this),this._up=new Uint32Array(8),this._down=new Uint32Array(8),this._state=new Uint32Array(8),this._pos={x:0,y:0},this._dpos={x:0,y:0},this._aup=new Uint32Array(8),this._adown=new Uint32Array(8),this._astate=new Uint32Array(8),this._apos={x:0,y:0},this._awheel=0,this._pwheel=0,this._dposflag=!0;const e=t.dom;e.setAttribute("tabindex",1),e.addEventListener("keyup",t=>{this.kUp(t)}),e.addEventListener("keydown",t=>{this.kDown(t)}),e.addEventListener("mouseup",t=>{this.mUp(t)}),e.addEventListener("mousedown",t=>{this.mDown(t)}),e.addEventListener("mousemove",t=>{this.mMove(t)}),e.addEventListener("mousewheel",t=>{this.mWheel(t)}),e.addEventListener("touchend",t=>{this.tEnd(t)}),e.addEventListener("touchstart",t=>{this.tStart(t)}),e.addEventListener("touchmove",t=>{this.tMove(t)}),e.addEventListener("contextmenu",t=>{t.preventDefault()})}onStartFrame(){for(let t=0;t<8;t++)this._up[t]=this._aup[t],this._down[t]=this._adown[t],this._state[t]=this._astate[t],this._aup[t]=0,this._adown[t]=0;this._dpos.x=this._dposflag?this._apos.x-this._pos.x:0,this._dpos.y=this._dposflag?this._apos.y-this._pos.y:0,this._pos.x=this._apos.x,this._pos.y=this._apos.y,this._pwheel=this._awheel,this._awheel=0,this._dposflag=!0}asyncDown(t){Et=1<<t%32,Tt=Math.floor(t/32),this._adown[Tt]|=Et&~this._astate[Tt],this._astate[Tt]|=Et}asyncUp(t){Et=1<<t%32,Tt=Math.floor(t/32),this._aup[Tt]|=Et,this._astate[Tt]&=~Et}kUp(t){this.asyncUp(t.keyCode)}kDown(t){this.asyncDown(t.keyCode),116!==t.keyCode&&t.preventDefault()}mUp(t){switch(t.button){case 0:t.keyCode=1;break;case 1:t.keyCode=4;break;case 2:t.keyCode=2;break;default:t.keyCode=0}this.asyncUp(t.keyCode)}mDown(t){switch(t.button){case 0:t.keyCode=1;break;case 1:t.keyCode=4;break;case 2:t.keyCode=2;break;default:t.keyCode=0}this.asyncDown(t.keyCode)}mMove(t){this._apos.x=t.clientX,this._apos.y=t.clientY}mWheel(t){this._awheel+=t.wheelDelta/120}tStart(t){this._apos.x=t.changedTouches[0].clientX,this._apos.y=t.changedTouches[0].clientY,this.asyncDown(1),this._dposflag=!1,t.preventDefault()}tEnd(t){this._apos.x=t.changedTouches[0].clientX,this._apos.y=t.changedTouches[0].clientY,this.asyncUp(1)}tMove(t){this._apos.x=t.changedTouches[0].clientX,this._apos.y=t.changedTouches[0].clientY}keyUp(t){return this._up[Math.floor(t/32)]>>t%32&1}keyDown(t){return this._down[Math.floor(t/32)]>>t%32&1}keyState(t){return this._state[Math.floor(t/32)]>>t%32&1}mousePos(){return this._pos}mouseDeltaPos(){return this._dpos}mouseWheel(){return this._pwheel}get VK_LBUTTON(){return 1}get VK_RBUTTON(){return 2}get VK_MBUTTON(){return 4}get VK_XBUTTON1(){return 5}get VK_XBUTTON2(){return 6}get VK_BACK(){return 8}get VK_TAB(){return 9}get VK_ESCAPE(){return 27}get VK_SPACE(){return 32}get VK_PAGEUP(){return 33}get VK_PAGEDOWN(){return 34}get VK_END(){return 35}get VK_HOME(){return 36}get VK_LEFT(){return 37}get VK_UP(){return 38}get VK_RIGHT(){return 39}get VK_DOWN(){return 40}get VK_0(){return 48}get VK_1(){return 49}get VK_2(){return 50}get VK_3(){return 51}get VK_4(){return 52}get VK_5(){return 53}get VK_6(){return 54}get VK_7(){return 55}get VK_8(){return 56}get VK_9(){return 57}get VK_A(){return 65}get VK_B(){return 66}get VK_C(){return 67}get VK_D(){return 68}get VK_E(){return 69}get VK_F(){return 70}get VK_G(){return 71}get VK_H(){return 72}get VK_I(){return 73}get VK_J(){return 74}get VK_K(){return 75}get VK_L(){return 76}get VK_M(){return 77}get VK_N(){return 78}get VK_O(){return 79}get VK_P(){return 80}get VK_Q(){return 81}get VK_R(){return 82}get VK_S(){return 83}get VK_T(){return 84}get VK_U(){return 85}get VK_V(){return 86}get VK_W(){return 87}get VK_X(){return 88}get VK_Y(){return 89}get VK_Z(){return 90}get VK_N0(){return 96}get VK_N1(){return 97}get VK_N2(){return 98}get VK_N3(){return 99}get VK_N4(){return 100}get VK_N5(){return 101}get VK_N6(){return 102}get VK_N7(){return 103}get VK_N8(){return 104}get VK_N9(){return 105}get VK_F1(){return 112}get VK_F2(){return 113}get VK_F3(){return 114}get VK_F4(){return 115}get VK_F5(){return 116}get VK_F6(){return 117}get VK_F7(){return 118}get VK_F8(){return 119}get VK_F9(){return 120}get VK_F10(){return 121}get VK_F11(){return 122}get VK_F12(){return 123}get VK_F13(){return 124}get VK_F14(){return 125}get VK_F15(){return 126}get VK_F16(){return 127}get VK_F17(){return 128}get VK_F18(){return 129}get VK_F19(){return 130}get VK_F20(){return 131}get VK_F21(){return 132}get VK_F22(){return 133}get VK_F23(){return 134}get VK_F24(){return 135}}(je)),je.regSystem(new class{constructor(t){this[St]="Screen",t.regEvent("onStartFrame",this),this.curWidth=1,this.curHeight=1,this.newWidth=1,this.newHeight=1,this.onscreen=!1,this.pr=window.devicePixelRatio||1}onStartFrame(t){this.newWidth=t.dom.clientWidth*this.pr,this.newHeight=t.dom.clientHeight*this.pr,this.onscreen=!1,this.curWidth!==this.newWidth&&(this.curWidth=this.newWidth,this.onscreen=!0),this.curHeight!==this.newHeight&&(this.curHeight=this.newHeight,this.onscreen=!0),this.onscreen&&t.fireEvent("onScreen")}get width(){return this.curWidth}get height(){return this.curHeight}get widthNPR(){return this.curWidth/this.pr}get heightNPR(){return this.curHeight/this.pr}}(je)),je.regSystem(new class{constructor(t){this[vt]="Render",t.regEvent("onStart",this),t.regEvent("onScreen",this),t.regEvent("onRender",this),t.regEvent("onModify",this),this.camera=null,this.envMesh=null}onStart(t){t.gl.clearColor(.7,.65,.6,1)}onScreen(t){zt=t.getSystem("Screen"),t.gl.viewport(0,0,zt.width,zt.height),t.gldom.width=zt.width,t.gldom.height=zt.height}onRender(t){if(performance.mark("rnds"),t.gl.clear(t.gl.COLOR_BUFFER_BIT|t.gl.DEPTH_BUFFER_BIT),this.camera){this.envMesh&&((Rt=t.getRes("material",this.envMesh.material)).use(t),t.getRes("geometry",this.envMesh.geometry).use(t,Rt.shader));for(const e of t.getComp(F))e.disable||(Ct=e.owner.getCompOne(yt),(Rt=t.getRes("material",e.material)).use(t),Rt.shader.setUniform(t,"PM",this.camera.pmat),Rt.shader.setUniform(t,"WM",this.camera.wmat),Rt.shader.setUniform(t,"OM",Ct.wmat),e.skeleton&&(kt=e.owner.getCompOne(dt))&&(Mt=t.getRes("skeleton",kt.skeleton),Rt.shader.setUniform(t,"key",kt.key),t.gl.uniform1i(Rt.shader.uniform.bones,8),t.gl.activeTexture(t.gl.TEXTURE0+8),t.gl.bindTexture(t.gl.TEXTURE_2D,Mt.bakeTex)),t.getRes("geometry",e.geometry).use(t,Rt.shader))}performance.mark("rnde"),performance.measure("render","rnds","rnde")}onModify(t){for(const e of t.getNewComp(J))this.camera=e,zt=t.getSystem("Screen"),this.camera.aspect=zt.width/zt.height,this.envMesh=e.owner.getCompOne(F)}setMainCamera(t){this.camera=t}}(je)),je.regSystem(new class{constructor(t){this[Ut]="Rotation",t.regEvent("onUpdate",this)}onUpdate(t){for(const e of t.getComp(ot))e.disable||(At=e.owner.getCompOne(yt),Vt.fromAxisAngle(e.axis,e.angle),At.orientation.premul(Vt))}}(je)),je.regSystem(new class{constructor(t){this[Kt]="Movement",t.regEvent("onStart",this),t.regEvent("onUpdate",this),this.limearSpeed=new it}onStart(t){this.time=t.getSystem("Time")}onUpdate(t){for(const e of t.getComp(nt))e.disable||(Lt=e.owner.getCompOne(yt),e.linear&&Lt.position.addScaledVec(this.limearSpeed,this.time.deltaTime),Lt.position.addScaledVec(e.direction,this.time.deltaTime*e.speed))}}(je)),je.regSystem(new class{constructor(t){this[Dt]="OrbitControl",t.regEvent("onStart",this),t.regEvent("onScreen",this),t.regEvent("onLateUpdate",this),this.count=0,this.screen=null}onStart(t){this.screen=t.getSystem("Screen"),this.input=t.getSystem("Input")}onScreen(t){for(const e of t.getComp(bt))e.disable||((Pt=e.owner.getCompOne(J)).aspect=this.screen.width/this.screen.height,Pt.pmat.perspective(Pt.fov,Pt.aspect,Pt.near,Pt.far))}onLateUpdate(t){Ft=this.input;for(const e of t.getComp(bt))e.disable||(Nt=e.owner.getCompOne(yt),Pt=e.owner.getCompOne(J),Ft.keyState(Ft.VK_LBUTTON)?(e.pfrozen||(e.polar-=Ft.mouseDeltaPos().y*e.speed),e.afrozen||(e.azimuthal-=Ft.mouseDeltaPos().x*e.speed),Pt.wmat.orbit(e.polar,e.azimuthal,e.distance,Nt.position)):Ft.mouseWheel()?(e.dfrozen||(e.distance-=Ft.mouseWheel()*e.speed*100),Pt.wmat.orbit(e.polar,e.azimuthal,e.distance,Nt.position)):e.nupd&&(e.nupd=!1,Pt.wmat.orbit(e.polar,e.azimuthal,e.distance,Nt.position),Pt.aspect=this.screen.width/this.screen.height,Pt.pmat.perspective(Pt.fov,Pt.aspect,Pt.near,Pt.far)))}}(je)),je.regSystem(new class{constructor(t){this[Ot]="Transform",t.regEvent("onTransform",this),t.regEvent("onModify",this)}onTransform(t){performance.mark("trfs");for(const e of t.getEntity())0===e.depth&&this.calcTransform(e);performance.mark("trfe"),performance.measure("transform","trfs","trfe")}onModify(t){for(const e of t.getNewComp(yt))this.calcTransform(e.owner)}calcTransform(t){(It=t.getCompOne(yt))&&(It.lmat.fromTRS(It.position,It.orientation,It.scale),It.wmat.copy(It.lmat),t.owner&&(Bt=t.owner.getCompOne(yt),It.wmat.mul(Bt.wmat)));for(const e of t.child)this.calcTransform(e)}}(je)),je.regSystem(new class{constructor(t){this[Xt]="Trigger",t.regEvent("onStart",this),t.regEvent("onPHYUpdate",this)}onStart(){this.tree=new jt(Qt-Jt,qt-Jt,Qt+Jt,qt+Jt,0,Zt)}onPHYUpdate(t){performance.mark("trs"),this.tree.clear();for(const e of t.getComp(ut))e.inner.length=0,e.owner.getCompOne(yt).worldPosition(e.pos).add(e.offset),this.tree.adds(e,e.pos.x,e.pos.z,e.radius);for(const e of t.getComp(lt))e.inner.length=0,e.owner.getCompOne(yt).worldPosition(e.pos).add(e.offset),this.tree.adda(e,e.pos.x,e.pos.z,e.size);this.tree.test(),performance.mark("tre"),performance.measure("trigger","trs","tre")}}(je)),je.regSystem(new class{constructor(t){this[$t]="Animation",t.regEvent("onStart",this),t.regEvent("onUpdate",this)}onStart(t){this.time=t.getSystem("Time")}onUpdate(t){performance.mark("ans");for(const e of t.getComp(dt))if(!e.disable)if(re=t.getRes("skeleton",e.skeleton),void 0!==(ne=re.bakeMap.get(e.animation))){for(ne=re.bakeMap.get(e.animation),e.time+=this.time.deltaTime;e.time>ne.end/30;)e.time-=ne.end/30;e.key.x=ne.layer,e.key.y=Math.floor(30*e.time),e.key.z=30*e.time%1}else{ie=re.bakeMap.size*re.bones.length,re.bakeMap.set(e.animation,{end:66,layer:ie}),ne=t.getRes("animation",e.animation);for(let t=0;t<67;t++){te=t<66?t:0,re.getLRByKey(te,ne),re.calcLR();for(let e=0;e<re.bones.length;e++)se=re.bones[e],re.bakeData[1024*(ie+e)*4+8*t+0]=se.loc.x,re.bakeData[1024*(ie+e)*4+8*t+1]=se.loc.y,re.bakeData[1024*(ie+e)*4+8*t+2]=se.loc.z,re.bakeData[1024*(ie+e)*4+8*t+3]=0,re.bakeData[1024*(ie+e)*4+8*t+4]=se.rot.x,re.bakeData[1024*(ie+e)*4+8*t+5]=se.rot.y,re.bakeData[1024*(ie+e)*4+8*t+6]=se.rot.z,re.bakeData[1024*(ie+e)*4+8*t+7]=se.rot.w}(ee=t.gl).bindTexture(ee.TEXTURE_2D,re.bakeTex),ee.texSubImage2D(ee.TEXTURE_2D,0,0,0,1024,1024,ee.RGBA,ee.FLOAT,re.bakeData),ee.bindTexture(ee.TEXTURE_2D,null)}performance.mark("ane"),performance.measure("animation","ans","ane")}}(je)),je.regSystem(new class{constructor(t){this[he]="Game",t.regEvent("onStart",this),t.regEvent("onUpdate",this),t.regEvent("onLateUpdate",this),this.count=0,this.airplane=null,this.transform=null,this.speed=400,this.state=0,console.log(t)}onStart(t){this.time=t.getSystem("Time"),this.input=t.getSystem("Input"),this.screen=t.getSystem("Screen"),this.movement=t.getSystem("Movement"),[this.airplane]=t.getEntitiesByName("airplane"),[this.camera]=t.getEntitiesByName("player"),[this.g1]=t.getEntitiesByName("ground1"),[this.g2]=t.getEntitiesByName("ground2"),this.barrier=new Array(ue),this.time.timeScale=0,setTimeout(()=>{const e=document.getElementById("app-ui-start");e.innerHTML="START",e.addEventListener("click",()=>{t.uidom.style.display="none",this.time.timeScale=1,this.state=1,this.start(t)}),e.addEventListener("touchstart",()=>{t.uidom.style.display="none",this.time.timeScale=1,this.state=1,this.start(t)})},1e3)}onUpdate(t){for(console.log(this.state),1===this.state?this.movement.limearSpeed.z=-this.speed:this.movement.limearSpeed.z=0,(le=this.g1.getCompOne(yt))&&le.position.z<-510&&(le.position.z+=2e3),(le=this.g2.getCompOne(yt))&&le.position.z<-510&&(le.position.z+=2e3),this.state&&((le=this.airplane.getCompOne(yt))&&(oe=2*-(this.input.mousePos().x/this.screen.widthNPR-.5),le.orientation.fromAxisAngle(ce,oe),le.position.x-=2*oe),(le=this.camera.getCompOne(yt))&&(le.position.x-=2*oe),(le=this.camera.getCompOne(bt))&&(le.nupd=!0)),ae=0;ae<ue;ae++)this.barrier[ae]&&(le=this.barrier[ae].getCompOne(yt))&&le.position.z<-20&&(t.delEntity(this.barrier[ae]),this.barrier[ae]=t.newEntity(null,!0),oe=4+Math.random(),t.newComp(yt,this.barrier[ae],!0,{position:{x:400*(Math.random()-.5),y:2,z:1e3+700*Math.random()},scale:{x:oe,y:oe,z:oe}}),t.newComp(F,this.barrier[ae],!0,{geometry:"box",material:"texturedLambert"}),t.newComp(nt,this.barrier[ae],!0,{direction:{x:0,y:0,z:1},speed:1}),t.newComp(lt,this.barrier[ae],!0,{size:{x:oe,y:oe,z:oe}}))}onLateUpdate(t){(le=this.airplane.getCompOne(ut))&&le.inner.length>0&&this.state&&(this.time.timeScale=0,this.state=0,setTimeout(()=>{t.uidom.style.display="block",this.clear(t)},1e3))}clear(t){for(ae=0;ae<ue;ae++)this.barrier[ae]&&t.delEntity(this.barrier[ae])}start(t){for(ae=0;ae<ue;ae++)this.barrier[ae]=t.newEntity(null,!0),oe=4+Math.random(),t.newComp(yt,this.barrier[ae],!0,{position:{x:400*(Math.random()-.5),y:2,z:1e3+700*Math.random()},scale:{x:oe,y:oe,z:oe}}),t.newComp(F,this.barrier[ae],!0,{geometry:"box",material:"texturedLambert"}),t.newComp(nt,this.barrier[ae],!0,{direction:{x:0,y:0,z:1},speed:1}),t.newComp(lt,this.barrier[ae],!0,{size:{x:oe,y:oe,z:oe}})}}(je)),je.loadRes("SceneLoader","./res/scene0.json").then(()=>{je.start()})}]);
//# sourceMappingURL=app.js.map