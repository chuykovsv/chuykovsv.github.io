!function(t){var e={};function i(s){if(e[s])return e[s].exports;var r=e[s]={i:s,l:!1,exports:{}};return t[s].call(r.exports,r,r.exports,i),r.l=!0,r.exports}i.m=t,i.c=e,i.d=function(t,e,s){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)i.d(s,r,function(e){return t[e]}.bind(null,r));return s},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="D:\\$WEB\\prototype\\dist",i(i.s=0)}([function(t,e,i){"use strict";i.r(e);const s=Symbol("gl"),r=Symbol("ext"),n=Symbol("dom"),o=Symbol("gldom"),h=Symbol("uidom"),a=Symbol("raf"),l=Symbol("res"),m=Symbol("tags"),c=Symbol("comp"),u=Symbol("loop"),d=Symbol("event"),p=Symbol("state"),g=Symbol("owner"),y=Symbol("child"),f=Symbol("depth"),w=Symbol("entity"),_=Symbol("system"),x=Symbol("transform"),b=Symbol.for("name"),E=Symbol("new"),C=Symbol("del"),L=Symbol("modify"),S=Symbol("loader"),v=1<<31,A=1<<30,z=1<<29,T=1<<28;let R=null;const M=new Set;class V{constructor(t){this.core=t}load(t){return fetch(t).then(t=>t.text().then(t=>JSON.parse(t)))}parse(t){return Promise.resolve(t)}conf(t){return Promise.resolve(t)}}class U{constructor(t,e){this[p]=v,this[g]=t,e&&(this[p]|=A|z)}get owner(){return this[g]}get enable(){return!!(this[p]&A)}get disable(){return!(this[p]&A)}get hasEnable(){return!(!(this[p]&~A)||this[p]&~z)}get hasDisable(){return!(this[p]&~A||!(this[p]&~z))}get hasNeedsUpdate(){return!!(this[p]&~T)}set needsUpdate(t){t?this[p]|=T:this[p]&=~T}}class O{constructor(t,e){this[p]=v,this[g]=t,this[b]=null,this[m]=new Set,this[c]=new Map,this[y]=new Set,this[f]=t?t[f]+1:0,this[x]=null,e&&(this[p]|=A|z),null!==t&&t[y].add(this)}get owner(){return this[g]}get enable(){return!!(this[p]&A)}get child(){return this[y]}get depth(){return this[f]}get name(){return this[b]}set name(t){this[b]=t}addTag(t){this[m].add(t)}delTag(t){this[m].delete(t)}hasTag(t){return this[m].has(t)}getComp(t){return void 0===(R=this[c].get(t))&&(R=M),R}getCompOne(t){return void 0!==(R=this[c].get(t))&&([R]=R),void 0!==R?R:null}}let N=null;const P=Symbol.for("name");class K extends U{constructor(t,e,i){super(t,e),this.iid=-1,this.geometry=i.geometry,this.material=i.material,this.skeleton=void 0!==i.skeleton?i.skeleton:null}}K[P]="Mesh";let F=0,k=0,I=0,D=0,B=0,W=0,G=0,H=0,Y=0,X=0;const j=new Float32Array(16);class q extends Float32Array{constructor(){super(16),this[0]=1,this[5]=1,this[10]=1,this[15]=1}copy(t){for(X=0;X<16;X++)this[X]=t[X];return this}identity(){for(X=0;X<16;X++)this[X]=X%5==0?1:0;return this}perspective(t,e,i,s){return this.identity(),this[15]=0,this[14]=-2*s*i/(s-i),this[11]=1,this[10]=(s+i)/(s-i),this[5]=1/Math.tan(.5*t),this[0]=this[5]/e,this}orbit(t,e,i,s){const r=Math.cos(e),n=Math.sin(e),o=Math.cos(t),h=Math.sin(t);return this.identity(),this[0]=r,this[4]=0,this[8]=n,this[1]=n*h,this[5]=o,this[9]=-r*h,this[2]=-n*o,this[6]=h,this[10]=r*o,this[12]=i*(this[2]*this[0]+this[6]*this[4]+this[10]*this[8]),this[13]=i*(this[2]*this[1]+this[6]*this[5]+this[10]*this[9]),this[14]=i*(this[2]*this[2]+this[6]*this[6]+this[10]*this[10]),this[12]-=s.x*this[0]+s.y*this[4]+s.z*this[8],this[13]-=s.x*this[1]+s.y*this[5]+s.z*this[9],this[14]-=s.x*this[2]+s.y*this[6]+s.z*this[10],this}mul(t){for(j[0]=this[0]*t[0]+this[1]*t[4]+this[2]*t[8]+this[3]*t[12],j[1]=this[0]*t[1]+this[1]*t[5]+this[2]*t[9]+this[3]*t[13],j[2]=this[0]*t[2]+this[1]*t[6]+this[2]*t[10]+this[3]*t[14],j[3]=this[0]*t[3]+this[1]*t[7]+this[2]*t[11]+this[3]*t[15],j[4]=this[4]*t[0]+this[5]*t[4]+this[6]*t[8]+this[7]*t[12],j[5]=this[4]*t[1]+this[5]*t[5]+this[6]*t[9]+this[7]*t[13],j[6]=this[4]*t[2]+this[5]*t[6]+this[6]*t[10]+this[7]*t[14],j[7]=this[4]*t[3]+this[5]*t[7]+this[6]*t[11]+this[7]*t[15],j[8]=this[8]*t[0]+this[9]*t[4]+this[10]*t[8]+this[11]*t[12],j[9]=this[8]*t[1]+this[9]*t[5]+this[10]*t[9]+this[11]*t[13],j[10]=this[8]*t[2]+this[9]*t[6]+this[10]*t[10]+this[11]*t[14],j[11]=this[8]*t[3]+this[9]*t[7]+this[10]*t[11]+this[11]*t[15],j[12]=this[12]*t[0]+this[13]*t[4]+this[14]*t[8]+this[15]*t[12],j[13]=this[12]*t[1]+this[13]*t[5]+this[14]*t[9]+this[15]*t[13],j[14]=this[12]*t[2]+this[13]*t[6]+this[14]*t[10]+this[15]*t[14],j[15]=this[12]*t[3]+this[13]*t[7]+this[14]*t[11]+this[15]*t[15],X=0;X<16;X++)this[X]=j[X];return this}premul(t){for(j[0]=t[0]*this[0]+t[1]*this[4]+t[2]*this[8]+t[3]*this[12],j[1]=t[0]*this[1]+t[1]*this[5]+t[2]*this[9]+t[3]*this[13],j[2]=t[0]*this[2]+t[1]*this[6]+t[2]*this[10]+t[3]*this[14],j[3]=t[0]*this[3]+t[1]*this[7]+t[2]*this[11]+t[3]*this[15],j[4]=t[4]*this[0]+t[5]*this[4]+t[6]*this[8]+t[7]*this[12],j[5]=t[4]*this[1]+t[5]*this[5]+t[6]*this[9]+t[7]*this[13],j[6]=t[4]*this[2]+t[5]*this[6]+t[6]*this[10]+t[7]*this[14],j[7]=t[4]*this[3]+t[5]*this[7]+t[6]*this[11]+t[7]*this[15],j[8]=t[8]*this[0]+t[9]*this[4]+t[10]*this[8]+t[11]*this[12],j[9]=t[8]*this[1]+t[9]*this[5]+t[10]*this[9]+t[11]*this[13],j[10]=t[8]*this[2]+t[9]*this[6]+t[10]*this[10]+t[11]*this[14],j[11]=t[8]*this[3]+t[9]*this[7]+t[10]*this[11]+t[11]*this[15],j[12]=t[12]*this[0]+t[13]*this[4]+t[14]*this[8]+t[15]*this[12],j[13]=t[12]*this[1]+t[13]*this[5]+t[14]*this[9]+t[15]*this[13],j[14]=t[12]*this[2]+t[13]*this[6]+t[14]*this[10]+t[15]*this[14],j[15]=t[12]*this[3]+t[13]*this[7]+t[14]*this[11]+t[15]*this[15],X=0;X<16;X++)this[X]=j[X];return this}fromTRS(t,e,i){return this[3]=0,this[7]=0,this[11]=0,this[15]=1,F=2*e.x*e.x,k=2*e.y*e.y,I=2*e.z*e.z,D=2*e.x*e.y,B=2*e.x*e.z,W=2*e.x*e.w,G=2*e.y*e.z,H=2*e.y*e.w,Y=2*e.z*e.w,this[0]=i.x*(1-k-I),this[1]=i.x*(D+Y),this[2]=i.x*(B-H),this[4]=i.y*(D-Y),this[5]=i.y*(1-F-I),this[6]=i.y*(G+W),this[8]=i.z*(B+H),this[9]=i.z*(G-W),this[10]=i.z*(1-F-k),this[12]=t.x,this[13]=t.y,this[14]=t.z,this}fromTRSC(t,e,i){return this[3]=0,this[7]=0,this[11]=0,this[15]=1,F=2*e.x*e.x,k=2*e.y*e.y,I=2*e.z*e.z,D=2*-e.x*-e.y,B=2*-e.x*-e.z,W=2*-e.x*-e.w,G=2*-e.y*-e.z,H=2*-e.y*-e.w,Y=2*-e.z*-e.w,this[0]=(1-k-I)/i.x,this[1]=(D+Y)/i.x,this[2]=(B-H)/i.x,this[4]=(D-Y)/i.y,this[5]=(1-F-I)/i.y,this[6]=(G+W)/i.y,this[8]=(B+H)/i.z,this[9]=(G-W)/i.z,this[10]=(1-F-k)/i.z,this[12]=-t.x*this[0]-t.y*this[4]-t.z*this[8],this[13]=-t.x*this[1]-t.y*this[5]-t.z*this[9],this[14]=-t.x*this[2]-t.y*this[6]-t.z*this[10],this}}const J=Symbol.for("name");class Q extends U{constructor(t,e,i){super(t,e),this.aspect=i.aspect||1,this.fov=i.fov||.7,this.near=i.near||1,this.far=i.far||1e3,this.pmat=new q,this.wmat=new q}}Q[J]="Camera";let Z=0,$=0,tt=0,et=0,it=0;class st{constructor(t=0,e=0,i=0){this.x=t,this.y=e,this.z=i}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}set(t,e,i){return this.x=t,this.y=e,this.z=i,this}normalize(){return Z=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z),this.x/=Z,this.y/=Z,this.z/=Z,this}abs(){return this.x=Math.abs(this.x),this.y=Math.abs(this.y),this.z=Math.abs(this.z),this}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this}mins(t){return this.x=Math.min(this.x,t),this.y=Math.min(this.y,t),this.z=Math.min(this.z,t),this}maxs(t){return this.x=Math.max(this.x,t),this.y=Math.max(this.y,t),this.z=Math.max(this.z,t),this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}addScaledVec(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this}applyQuat(t){return $=t.w*this.x+t.y*this.z-t.z*this.y,tt=t.w*this.y+t.z*this.x-t.x*this.z,et=t.w*this.z+t.x*this.y-t.y*this.x,it=-t.x*this.x-t.y*this.y-t.z*this.z,this.x=$*t.w-it*t.x-tt*t.z+et*t.y,this.y=tt*t.w-it*t.y-et*t.x+$*t.z,this.z=et*t.w-it*t.z-$*t.y+tt*t.x,this}mulNumber(t){return this.x*=t,this.y*=t,this.z*=t,this}get length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}}const rt=Symbol.for("name");class nt extends U{constructor(t,e,i){super(t,e),this.speed=void 0!==i.speed?i.speed:0,this.linear=void 0===i.linear||i.linear,this.direction=new st(0,0,-1),void 0!==i.direction&&this.direction.copy(i.direction)}}nt[rt]="Movement";const ot=Symbol.for("name");class ht extends U{constructor(t,e,i){super(t,e),this.axis=new st,this.angle=i.angle||0,i.axis&&this.axis.copy(i.axis)}}ht[ot]="Rotation";const at=Symbol.for("name");class lt extends U{constructor(t,e,i){super(t,e),this.pos=new st,this.next=null,this.inner=[],this.mask=void 0!==i.mask?i.mask:4294967295,this.offset=new st,void 0!==i.offset&&this.offset.copy(i.offset),this.size=new st,void 0!==i.size&&this.size.copy(i.size)}}lt[at]="ATrigger";const mt=Symbol.for("name");class ct extends U{constructor(t,e,i){super(t,e),this.pos=new st,this.next=null,this.inner=[],this.mask=void 0!==i.mask?i.mask:4294967295,this.offset=new st,void 0!==i.offset&&this.offset.copy(i.offset),this.radius=void 0!==i.radius?i.radius:0}}ct[mt]="STrigger";class ut extends U{constructor(t,e,i){super(t,e),this.skeleton=void 0!==i.skeleton?i.skeleton:null,this.animation=void 0!==i.animation?i.animation:null,this.loop=!0,this.stop=!1,this.time=0,this.key=new st}}ut[Symbol.for("name")]="Animator";let dt=null;class pt{constructor(t=0,e=0,i=0,s=1){this.x=t,this.y=e,this.z=i,this.w=s}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this}set(t,e,i,s){return this.x=t,this.y=e,this.z=i,this.w=s,this}mul(t){const e=this.x,i=this.y,s=this.z,r=this.w;return this.x=r*t.x+e*t.w+i*t.z-s*t.y,this.y=r*t.y-e*t.z+i*t.w+s*t.x,this.z=r*t.z+e*t.y-i*t.x+s*t.w,this.w=r*t.w-e*t.x-i*t.y-s*t.z,this}premul(t){const e=this.x,i=this.y,s=this.z,r=this.w;return this.x=t.w*e+t.x*r+t.y*s-t.z*i,this.y=t.w*i-t.x*s+t.y*r+t.z*e,this.z=t.w*s+t.x*i-t.y*e+t.z*r,this.w=t.w*r-t.x*e-t.y*i-t.z*s,this}fromAxisAngle(t,e){return dt=Math.sin(.5*e),this.x=t.x*dt,this.y=t.y*dt,this.z=t.z*dt,this.w=Math.cos(.5*e),this}}const gt=Symbol.for("name");class yt extends U{constructor(t,e,i){super(t,e),this.position=new st,this.orientation=new pt,this.scale=new st(1,1,1),i.scale&&this.scale.copy(i.scale),i.position&&this.position.copy(i.position),i.orientation&&this.orientation.copy(i.orientation),this.lmat=new q,this.wmat=new q}worldPosition(t){return t.x=this.wmat[12],t.y=this.wmat[13],t.z=this.wmat[14],t}}yt[gt]="Transform";const ft=Symbol.for("name");class wt extends U{constructor(t,e,i){super(t,e),this.polar=i.polar||0,this.azimuthal=i.azimuthal||0,this.distance=i.distance||0,this.forward=new st,this.speed=i.speed||.004,this.nupd=!0,this.afrozen=i.afrozen||!1,this.pfrozen=i.pfrozen||!1,this.dfrozen=i.dfrozen||!1}}wt[ft]="OrbitControl";const _t=Symbol.for("name");const xt=Symbol.for("name");let bt=null,Et=null;const Ct=Symbol.for("name");const Lt=Symbol("k1"),St=Symbol("in"),vt=Symbol("it1"),At=Symbol("it2");let zt=null;class Tt{constructor(){this[St]=new Map,this[vt]=null,this[At]=null}start(){this[vt]=null,this[At]=null}next(t){for(this[vt]||(this[vt]=this[St][Symbol.iterator]());;){if(!this[At]){if((zt=this[vt].next()).done)return this[vt]=null,this[At]=null,null;this[Lt]=zt.value[0],this[At]=zt.value[1][Symbol.iterator]()}if(!(zt=this[At].next()).done)return t.k1=this[Lt],t.k2=zt.value[0],t.value=zt.value[1],t;this[At]=null}}set(t,e,i){this[St].has(t)?zt=this[St].get(t):(zt=new Map,this[St].set(t,zt)),zt.set(e,i)}get(t,e){if(zt=this[St].get(t))return zt.get(e)}has(t,e){return!!(zt=this[St].get(t))&&zt.has(e)}delete(t,e){return!!(zt=this[St].get(t))&&zt.delete(e)}}const Rt=64;class Mt{constructor(t,e,i,s,r){this.mat=e,this.geo=i,this.ibo=s,this.offset=r*Rt,this.size=0,this.vao=t.ext.vao.createVertexArrayOES();const n=t.gl,o=this.mat.shader;t.ext.vao.bindVertexArrayOES(this.vao),n.bindBuffer(n.ARRAY_BUFFER,this.geo.vbo);for(const t in this.geo.attribute)void 0!==o.attribute[t]&&(n.enableVertexAttribArray(o.attribute[t]),n.vertexAttribPointer(o.attribute[t],this.geo.attribute[t].size,this.geo.attribute[t].type,!1,this.geo.attribute[t].stride,this.geo.attribute[t].offset));n.bindBuffer(n.ARRAY_BUFFER,this.ibo);let h=n.getAttribLocation(o.program,"ex");n.enableVertexAttribArray(h),n.vertexAttribPointer(h,3,n.FLOAT,!1,48,48*this.offset),t.ext.inst.vertexAttribDivisorANGLE(h,1),h=n.getAttribLocation(o.program,"ey"),n.enableVertexAttribArray(h),n.vertexAttribPointer(h,3,n.FLOAT,!1,48,48*this.offset+12),t.ext.inst.vertexAttribDivisorANGLE(h,1),h=n.getAttribLocation(o.program,"ez"),n.enableVertexAttribArray(h),n.vertexAttribPointer(h,3,n.FLOAT,!1,48,48*this.offset+24),t.ext.inst.vertexAttribDivisorANGLE(h,1),h=n.getAttribLocation(o.program,"et"),n.enableVertexAttribArray(h),n.vertexAttribPointer(h,3,n.FLOAT,!1,48,48*this.offset+36),t.ext.inst.vertexAttribDivisorANGLE(h,1),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,this.geo.ebo),t.ext.vao.bindVertexArrayOES(null)}add(){if(this.size++,this.size>Rt)throw new Error("BATCH_SIZE ERROR");return this.offset+this.size-1}draw(t,e){this.mat.use(t),this.mat.shader.setUniform(t,"PM",e.pmat),this.mat.shader.setUniform(t,"WM",e.wmat),t.ext.vao.bindVertexArrayOES(this.vao),t.ext.inst.drawElementsInstancedANGLE(t.gl.TRIANGLES,this.geo.length,t.gl.UNSIGNED_SHORT,0,this.size),t.ext.vao.bindVertexArrayOES(null)}}const Vt=Symbol.for("name"),Ut=4096;let Ot=null,Nt=null,Pt=null,Kt=null,Ft=null,kt=null;const It={};const Dt=Symbol.for("name");let Bt=null;const Wt=new pt;const Gt=Symbol.for("name");let Ht=null;const Yt=Symbol.for("name");let Xt=null,jt=null,qt=null;const Jt=Symbol.for("name");let Qt=null,Zt=null;const $t=Symbol.for("name"),te=new st;function ee(t,e){return te.copy(t.pos).sub(e.pos),te.length-t.radius-e.radius<=0}function ie(t,e){return te.copy(e.pos).sub(t.pos).abs().sub(t.size).maxs(0),te.length-e.radius<=0}function se(t,e){return te.copy(e.pos).sub(t.pos).abs().sub(t.size).sub(e.size),te.x<=0&&te.y<=0&&te.z<=0}class re{constructor(t,e,i,s,r,n){this.child=null,this.inner=!1,this.xl=t,this.yl=e,this.xh=i,this.yh=s,this.c1=null,this.c2=null,this.bs=null,this.es=null,this.ba=null,this.ea=null,this.tx=.5*(t+i),this.ty=.5*(e+s),r<n&&(this.child=new Array(4),this.child[0]=new re(t,e,this.tx,this.ty,r+1,n),this.child[1]=new re(this.tx,e,i,this.ty,r+1,n),this.child[2]=new re(t,this.ty,this.tx,s,r+1,n),this.child[3]=new re(this.tx,this.ty,i,s,r+1,n))}clear(){this.bs=null,this.es=null,this.ba=null,this.ea=null,this.child&&this.inner&&(this.child[0].clear(),this.child[1].clear(),this.child[2].clear(),this.child[3].clear()),this.inner=!1}adds(t,e,i,s){this.tx=.5*(this.xl+this.xh),this.ty=.5*(this.yl+this.yh),this.child?e+s<this.tx&&i+s<this.ty?(this.inner=!0,this.child[0].adds(t,e,i,s)):e-s>this.tx&&i+s<this.ty?(this.inner=!0,this.child[1].adds(t,e,i,s)):e+s<this.tx&&i-s>this.ty?(this.inner=!0,this.child[2].adds(t,e,i,s)):e-s>this.tx&&i-s>this.ty?(this.inner=!0,this.child[3].adds(t,e,i,s)):(null===this.es?this.bs=t:this.es.next=t,this.es=t,t.next=null):(null===this.es?this.bs=t:this.es.next=t,this.es=t,t.next=null)}adda(t,e,i,s){this.tx=.5*(this.xl+this.xh),this.ty=.5*(this.yl+this.yh),this.child?e+s.x<this.tx&&i+s.z<this.ty?(this.inner=!0,this.child[0].adda(t,e,i,s)):e-s.x>this.tx&&i+s.z<this.ty?(this.inner=!0,this.child[1].adda(t,e,i,s)):e+s.x<this.tx&&i-s.z>this.ty?(this.inner=!0,this.child[2].adda(t,e,i,s)):e-s.x>this.tx&&i-s.z>this.ty?(this.inner=!0,this.child[3].adda(t,e,i,s)):(null===this.ea?this.ba=t:this.ea.next=t,this.ea=t,t.next=null):(null===this.ea?this.ba=t:this.ea.next=t,this.ea=t,t.next=null)}test(){for(this.c1=this.bs;null!==this.c1;this.c1=this.c1.next){for(this.c2=this.c1.next;null!==this.c2;this.c2=this.c2.next)ee(this.c1,this.c2)&&(this.c1.inner.push(this.c2),this.c2.inner.push(this.c1));for(this.c2=this.ba;null!==this.c2;this.c2=this.c2.next)ie(this.c2,this.c1)&&(this.c1.inner.push(this.c2),this.c2.inner.push(this.c1));this.inner&&this.child&&(this.child[0].tests(this.c1),this.child[1].tests(this.c1),this.child[2].tests(this.c1),this.child[3].tests(this.c1))}for(this.c1=this.ba;null!==this.c1;this.c1=this.c1.next){for(this.c2=this.c1.next;null!==this.c2;this.c2=this.c2.next)se(this.c1,this.c2)&&(this.c1.inner.push(this.c2),this.c2.inner.push(this.c1));this.inner&&this.child&&(this.child[0].testa(this.c1),this.child[1].testa(this.c1),this.child[2].testa(this.c1),this.child[3].testa(this.c1))}this.inner&&this.child&&(this.child[0].test(),this.child[1].test(),this.child[2].test(),this.child[3].test())}tests(t){for(this.c1=this.bs;null!==this.c1;this.c1=this.c1.next)ee(this.c1,t)&&(this.c1.inner.push(t),t.inner.push(this.c1));for(this.c1=this.ba;null!==this.c1;this.c1=this.c1.next)ie(this.c1,t)&&(this.c1.inner.push(t),t.inner.push(this.c1));this.inner&&this.child&&(this.child[0].tests(t),this.child[1].tests(t),this.child[2].tests(t),this.child[3].tests(t))}testa(t){for(this.c1=this.ba;null!==this.c1;this.c1=this.c1.next)se(this.c1,t)&&(this.c1.inner.push(t),t.inner.push(this.c1));for(this.c1=this.bs;null!==this.c1;this.c1=this.c1.next)ie(t,this.c1)&&(this.c1.inner.push(t),t.inner.push(this.c1));this.inner&&this.child&&(this.child[0].testa(t),this.child[1].testa(t),this.child[2].testa(t),this.child[3].testa(t))}}const ne=0,oe=700,he=1024,ae=5;let le=null,me=null,ce=null;const ue=new st;function de(t,e,i){(ce=t[e].getCompOne(yt)).position.copy(i),ce.position.y=6,(me=t[e].getCompOne(nt)).speed=20*Math.random()*i.x/Math.abs(i.x)}function pe(t,e,i){(ce=t[e].getCompOne(yt)).position.copy(i)}function ge(t,e,i){for(le of(ue.copy(i),ue.x=0,(ce=t[e].getCompOne(yt)).position.copy(ue),ue.copy(i),ue.x-=28,ue.y=5,ue.z=0,t[e].child))me=le.getCompOne(nt),(ce=le.getCompOne(yt)).position.copy(ue),ue.x+=28,me.speed=i.x<0?30:-30}function ye(t,e,i,s){e[i]=t.newEntity(null,!0),t.newComp(yt,e[i],!0,{position:s}).position.y=6,t.newComp(K,e[i],!0,{geometry:"SPHERE_GOLD",material:"gold_mat"}),t.newComp(K,e[i],!0,{geometry:"SPHERE_SILVER",material:"silver_mat"}),t.newComp(K,e[i],!0,{geometry:"SPHERE_LIGHT",material:"light_mat"}),t.newComp(nt,e[i],!0,{direction:{x:-1,y:0,z:0},speed:20*Math.random()*s.x/Math.abs(s.x)}),t.newComp(ct,e[i],!0,{radius:1})}function fe(t,e,i,s){e[i]=t.newEntity(null,!0),t.newComp(yt,e[i],!0,{position:s}),t.newComp(K,e[i],!0,{geometry:"PILLAR1_GOLD",material:"gold_mat"}),t.newComp(K,e[i],!0,{geometry:"PILLAR1_SILVER",material:"silver_mat"}),t.newComp(K,e[i],!0,{geometry:"PILLAR1_WALL_W",material:"wall_w_mat"}),t.newComp(K,e[i],!0,{geometry:"PILLAR1_WALL_WG",material:"wall_wg_mat"}),t.newComp(nt,e[i],!0,{direction:{x:0,y:0,z:1},speed:0}),t.newComp(lt,e[i],!0,{size:{x:4,y:8,z:4}})}function we(t,e,i,s){e[i]=t.newEntity(null,!0),t.newComp(yt,e[i],!0,{position:s}),t.newComp(K,e[i],!0,{geometry:"PILLAR2_SILVER",material:"silver_mat"}),t.newComp(K,e[i],!0,{geometry:"PILLAR2_WALL_W",material:"wall_w_mat"}),t.newComp(K,e[i],!0,{geometry:"PILLAR2_WALL_WG",material:"wall_wg_mat"}),t.newComp(nt,e[i],!0,{direction:{x:0,y:0,z:1},speed:0}),t.newComp(lt,e[i],!0,{size:{x:4,y:8,z:4}})}function _e(t,e,i,s){e[i]=t.newEntity(null,!0),t.newComp(yt,e[i],!0,{position:s}),t.newComp(K,e[i],!0,{geometry:"PILLAR3_SILVER",material:"silver_mat"}),t.newComp(K,e[i],!0,{geometry:"PILLAR3_WALL_W",material:"wall_w_mat"}),t.newComp(nt,e[i],!0,{direction:{x:0,y:0,z:1},speed:0}),t.newComp(lt,e[i],!0,{size:{x:4,y:8,z:4}})}function xe(t,e,i,s){e[i]=t.newEntity(null,!0),t.newComp(yt,e[i],!0,{position:s}),t.newComp(K,e[i],!0,{geometry:"PILLAR4_GOLD",material:"gold_mat"}),t.newComp(K,e[i],!0,{geometry:"PILLAR4_SILVER",material:"silver_mat"}),t.newComp(K,e[i],!0,{geometry:"PILLAR4_WALL_W",material:"wall_w_mat"}),t.newComp(K,e[i],!0,{geometry:"PILLAR4_WALL_WG",material:"wall_wg_mat"}),t.newComp(nt,e[i],!0,{direction:{x:0,y:0,z:1},speed:0}),t.newComp(lt,e[i],!0,{size:{x:4,y:8,z:4}})}function be(t,e,i,s){e[i]=t.newEntity(null,!0),t.newComp(yt,e[i],!0,{position:s}),t.newComp(K,e[i],!0,{geometry:"PILLAR5_GOLD",material:"gold_mat"}),t.newComp(K,e[i],!0,{geometry:"PILLAR5_SILVER",material:"silver_mat"}),t.newComp(K,e[i],!0,{geometry:"PILLAR5_WALL_W",material:"wall_w_mat"}),t.newComp(K,e[i],!0,{geometry:"PILLAR5_WALL_WG",material:"wall_wg_mat"}),t.newComp(nt,e[i],!0,{direction:{x:0,y:0,z:1},speed:0}),t.newComp(lt,e[i],!0,{size:{x:4,y:8,z:4}})}function Ee(t,e,i,s){e[i]=t.newEntity(null,!0),t.newComp(yt,e[i],!0,{position:s}),t.newComp(K,e[i],!0,{geometry:"COLUMN1_GOLD",material:"gold_mat"}),t.newComp(K,e[i],!0,{geometry:"COLUMN1_WALL_S",material:"wall_s_mat"}),t.newComp(K,e[i],!0,{geometry:"COLUMN1_WALL_W",material:"wall_w_mat"}),t.newComp(K,e[i],!0,{geometry:"COLUMN1_WALL_WG",material:"wall_wg_mat"}),t.newComp(nt,e[i],!0,{direction:{x:0,y:0,z:1},speed:0}),t.newComp(lt,e[i],!0,{size:{x:7,y:8,z:7}})}function Ce(t,e,i,s){e[i]=t.newEntity(null,!0),t.newComp(yt,e[i],!0,{position:s}),t.newComp(K,e[i],!0,{geometry:"COLUMN2_GOLD",material:"gold_mat"}),t.newComp(K,e[i],!0,{geometry:"COLUMN2_SILVER",material:"silver_mat"}),t.newComp(K,e[i],!0,{geometry:"COLUMN2_WALL_S",material:"wall_s_mat"}),t.newComp(K,e[i],!0,{geometry:"COLUMN2_WALL_W",material:"wall_w_mat"}),t.newComp(K,e[i],!0,{geometry:"COLUMN2_WALL_WG",material:"wall_wg_mat"}),t.newComp(nt,e[i],!0,{direction:{x:0,y:0,z:1},speed:0}),t.newComp(lt,e[i],!0,{size:{x:7,y:8,z:7}})}function Le(t,e,i,s){e[i]=t.newEntity(null,!0),t.newComp(yt,e[i],!0,{position:s}),t.newComp(K,e[i],!0,{geometry:"COLUMN3_GOLD",material:"gold_mat"}),t.newComp(K,e[i],!0,{geometry:"COLUMN3_SILVER",material:"silver_mat"}),t.newComp(K,e[i],!0,{geometry:"COLUMN3_WALL_S",material:"wall_s_mat"}),t.newComp(K,e[i],!0,{geometry:"COLUMN3_WALL_W",material:"wall_w_mat"}),t.newComp(K,e[i],!0,{geometry:"COLUMN3_WALL_WG",material:"wall_wg_mat"}),t.newComp(nt,e[i],!0,{direction:{x:0,y:0,z:1},speed:0}),t.newComp(lt,e[i],!0,{size:{x:7,y:8,z:7}})}function Se(t,e,i,s){e[i]=t.newEntity(null,!0),t.newComp(yt,e[i],!0,{position:s}),t.newComp(K,e[i],!0,{geometry:"TUNNEL1_GOLD",material:"gold_mat"}),t.newComp(K,e[i],!0,{geometry:"TUNNEL1_WALL_S",material:"wall_s_mat"}),t.newComp(K,e[i],!0,{geometry:"TUNNEL1_WALL_WG",material:"wall_wg_mat"}),t.newComp(nt,e[i],!0,{direction:{x:0,y:0,z:1},speed:0}),t.newComp(lt,e[i],!0,{size:{x:8,y:8,z:67}})}function ve(t,e,i,s){e[i]=t.newEntity(null,!0),t.newComp(yt,e[i],!0,{position:s}),t.newComp(K,e[i],!0,{geometry:"TUNNEL2_GOLD",material:"gold_mat"}),t.newComp(K,e[i],!0,{geometry:"TUNNEL2_WALL_S",material:"wall_s_mat"}),t.newComp(K,e[i],!0,{geometry:"TUNNEL2_WALL_W",material:"wall_w_mat"}),t.newComp(K,e[i],!0,{geometry:"TUNNEL2_WALL_WG",material:"wall_wg_mat"}),t.newComp(nt,e[i],!0,{direction:{x:0,y:0,z:1},speed:0}),t.newComp(lt,e[i],!0,{size:{x:8,y:8,z:67}})}function Ae(t,e,i,s){const r=s.x;s.x=0,e[i]=t.newEntity(null,!0),t.newComp(yt,e[i],!0,{position:s}),t.newComp(K,e[i],!0,{geometry:"GATE_GOLD",material:"gold_mat"}),t.newComp(K,e[i],!0,{geometry:"GATE_LIGHT",material:"light_mat"}),t.newComp(K,e[i],!0,{geometry:"GATE_WALL_S",material:"wall_s_mat"}),t.newComp(K,e[i],!0,{geometry:"GATE_WALL_SG",material:"wall_sg_mat"}),t.newComp(K,e[i],!0,{geometry:"GATE_WALL_W",material:"wall_w_mat"}),t.newComp(K,e[i],!0,{geometry:"GATE_WALL_WG",material:"wall_wg_mat"}),t.newComp(nt,e[i],!0,{direction:{x:0,y:0,z:1},speed:0}),t.newComp(lt,e[i],!0,{size:{x:20,y:20,z:20},offset:{x:220,y:0,z:0}}),t.newComp(lt,e[i],!0,{size:{x:20,y:20,z:20},offset:{x:-220,y:0,z:0}}),s.x=r-28,s.y=5,s.z=0;let n=t.newEntity(e[i],!0);t.newComp(yt,n,!0,{position:s,scale:{x:.7,y:.7,z:.7}}),t.newComp(K,n,!0,{geometry:"PYRAMID_GOLD",material:"gold_mat"}),t.newComp(K,n,!0,{geometry:"PYRAMID_SILVER",material:"silver_mat"}),t.newComp(nt,n,!0,{direction:{x:1,y:0,z:0},speed:r<0?30:-30}),t.newComp(ct,n,!0,{radius:7}),s.x+=28,n=t.newEntity(e[i],!0),t.newComp(yt,n,!0,{position:s}),t.newComp(K,n,!0,{geometry:"PYRAMID_GOLD",material:"gold_mat"}),t.newComp(K,n,!0,{geometry:"PYRAMID_SILVER",material:"silver_mat"}),t.newComp(nt,n,!0,{direction:{x:1,y:0,z:0},speed:r<0?30:-30}),t.newComp(ct,n,!0,{radius:10}),s.x+=28,n=t.newEntity(e[i],!0),t.newComp(yt,n,!0,{position:s,scale:{x:.7,y:.7,z:.7}}),t.newComp(K,n,!0,{geometry:"PYRAMID_GOLD",material:"gold_mat"}),t.newComp(K,n,!0,{geometry:"PYRAMID_SILVER",material:"silver_mat"}),t.newComp(nt,n,!0,{direction:{x:1,y:0,z:0},speed:r<0?30:-30}),t.newComp(ct,n,!0,{radius:7})}const ze=Symbol.for("name");let Te=0,Re=0,Me=null;const Ve=new st(0,0,1),Ue=128,Oe=.5,Ne=.25,Pe=new st;class Ke{constructor(t=0,e=0){this.x=t,this.y=e}}class Fe{constructor(t=0,e=0,i=0,s=0){this.x=t,this.y=e,this.z=i,this.w=s}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this}}class ke{constructor(t=null,e=0){this.texture=t,this.layer=e}copy(t){this.texture=t.texture,this.layer=t.layer}}class Ie{constructor(){this.program=null,this.uniform={},this.attribute={}}use(t){t.gl.useProgram(this.program)}setUniform(t,e,i){switch(i.constructor){case Number:t.gl.uniform2f(this.uniform[e],i);break;case Ke:t.gl.uniform2f(this.uniform[e],i.x,i.y);break;case st:t.gl.uniform3f(this.uniform[e],i.x,i.y,i.z);break;case Fe:case pt:t.gl.uniform4f(this.uniform[e],i.x,i.y,i.z,i.w);break;case ke:t.gl.uniform1i(this.uniform[e],i.layer),i.texture.use(t,i.layer);break;case q:t.gl.uniformMatrix4fv(this.uniform[e],!1,i);break;default:throw new Error("Type of value not found")}}}const De=Symbol.for("name");class Be extends V{parse(t){if("string"!=typeof t.name||""===t.name)throw new Error("Shader not named");const e=this.core.gl,i=e.createShader(e.VERTEX_SHADER),s=e.createShader(e.FRAGMENT_SHADER),r=new Ie;if(r.program=e.createProgram(),e.shaderSource(i,t.vs),e.compileShader(i),e.shaderSource(s,t.fs),e.compileShader(s),!e.getShaderParameter(i,e.COMPILE_STATUS))throw new Error(e.getShaderInfoLog(i));if(!e.getShaderParameter(s,e.COMPILE_STATUS))throw new Error(e.getShaderInfoLog(s));if(e.attachShader(r.program,i),e.attachShader(r.program,s),e.linkProgram(r.program),!e.getProgramParameter(r.program,e.LINK_STATUS))throw new Error(e.getProgramInfoLog(r.program));e.deleteShader(i),e.deleteShader(s);for(let t=0;t<e.getProgramParameter(r.program,e.ACTIVE_UNIFORMS);t++){const i=e.getActiveUniform(r.program,t).name;i.includes("gl_")||(r.uniform[i]=e.getUniformLocation(r.program,i))}for(let t=0;t<e.getProgramParameter(r.program,e.ACTIVE_ATTRIBUTES);t++){const i=e.getActiveAttrib(r.program,t).name;i.includes("gl_")||(r.attribute[i]=e.getAttribLocation(r.program,i))}return this.core.addRes("shader",t.name,r),Promise.resolve(r)}}Be.prototype[De]="RawShaderLoader";let We=null;class Ge{constructor(){this.shader=null,this.depthtest=!0,this.depthwrite=!0,this.cullFace=0,this.blend=0,this.uniform={},this.batch=!1}use(t){switch(We=t.gl,this.shader.use(t),this.depthtest?We.enable(We.DEPTH_TEST):We.disable(We.DEPTH_TEST),We.depthMask(this.depthwrite),this.cullFace){case 0:We.disable(We.CULL_FACE);break;case 1:We.enable(We.CULL_FACE),We.cullFace(We.BACK);break;case 2:We.enable(We.CULL_FACE),We.cullFace(We.FRONT);break;case 3:We.enable(We.CULL_FACE),We.cullFace(We.FRONT_AND_BACK);break;default:We.disable(We.CULL_FACE)}switch(this.blend){case 0:We.disable(We.BLEND);break;case 1:We.enable(We.BLEND);break;default:We.disable(We.BLEND)}for(const e in this.uniform)this.shader.setUniform(t,e,this.uniform[e])}}const He=Symbol.for("name");class Ye extends V{parse(t){if("string"!=typeof t.name||""===t.name)throw new Error("Material not named");const e=new Ge;e.shader=t.shader,e.depthtest=void 0===t.depthtest||t.depthtest,e.depthwrite=void 0===t.depthwrite||t.depthwrite,e.cullFace=void 0!==t.cullFace?t.cullFace:0,e.blend=void 0!==t.blend?t.blend:0,e.batch=void 0!==t.batch&&t.batch;for(const i in t.uniform)switch(t.uniform[i].type){case"Float":e.uniform[i]=t.uniform[i].value;break;case"Vec2":e.uniform[i]=new Ke,e.uniform[i].copy(t.uniform[i].value);break;case"Vec3":e.uniform[i]=new st,e.uniform[i].copy(t.uniform[i].value);break;case"Vec4":e.uniform[i]=new Fe,e.uniform[i].copy(t.uniform[i].value);break;case"Texture":e.uniform[i]=new ke,e.uniform[i].copy(t.uniform[i].value);break;default:throw new Error("Uniform type not found")}return this.core.addRes("material",t.name,e),Promise.resolve(e)}conf(t){t.shader=this.core.getRes("shader",t.shader);for(const e in t.uniform)t.uniform[e]instanceof ke&&(t.uniform[e].texture=this.core.getRes("texture",t.uniform[e].texture));return Promise.resolve(t)}}Ye.prototype[He]="MaterialLoader";const Xe=Symbol.for("name");class je extends V{load(t){return new Promise((e,i)=>{const s=new Image,r=t.substring(t.lastIndexOf("/")+1,t.lastIndexOf("."));s.onload=(()=>{e(s),this.core.addRes("image",r,s)}),s.onerror=(()=>{i(s)}),s.src=t})}}je.prototype[Xe]="ImageLoader";let qe=null;class Je{constructor(){this.image=null,this.tex=null,this.type=3553}use(t,e){(qe=t.gl).activeTexture(qe.TEXTURE0+e),qe.bindTexture(this.type,this.tex)}}const Qe=Symbol.for("name");class Ze extends V{parse(t){if("string"!=typeof t.name||""===t.name)throw new Error("Texture not named");const e=this.core.gl,i=new Je;return i.image=t.image,i.type=e.TEXTURE_2D,i.tex=e.createTexture(),this.core.addRes("texture",t.name,i),Promise.resolve(i)}conf(t){const e=this.core.gl;return t.image=this.core.getRes("image",t.image),e.bindTexture(e.TEXTURE_2D,t.tex),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t.image),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR_MIPMAP_LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT),e.generateMipmap(e.TEXTURE_2D),e.bindTexture(e.TEXTURE_2D,null),Promise.resolve(t)}}Ze.prototype[Qe]="Texture2DLoader";let $e=null;class ti{constructor(){this.attribute={},this.length=0,this.vbo=null,this.ebo=null}use(t,e){($e=t.gl).bindBuffer($e.ARRAY_BUFFER,this.vbo);for(const t in this.attribute)void 0!==e.attribute[t]&&($e.enableVertexAttribArray(e.attribute[t]),$e.vertexAttribPointer(e.attribute[t],this.attribute[t].size,this.attribute[t].type,!1,this.attribute[t].stride,this.attribute[t].offset));$e.bindBuffer($e.ELEMENT_ARRAY_BUFFER,this.ebo),$e.drawElements($e.TRIANGLES,this.length,$e.UNSIGNED_SHORT,0);for(const t in this.attribute)void 0!==e.attribute[t]&&$e.disableVertexAttribArray(e.attribute[t])}}const ei=Symbol.for("name");class ii extends V{parse(t){if("string"!=typeof t.name||""===t.name)throw new Error("Geometry not named");const e=this.core.gl,i=new ti;for(const e in t.attribute)i.attribute[e]=t.attribute[e];return i.vbo=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,i.vbo),e.bufferData(e.ARRAY_BUFFER,new Float32Array(t.vbo),e.STATIC_DRAW),i.ebo=e.createBuffer(),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,i.ebo),e.bufferData(e.ELEMENT_ARRAY_BUFFER,new Uint16Array(t.ebo),e.STATIC_DRAW),i.length=t.ebo.length,this.core.addRes("geometry",t.name,i),Promise.resolve(i)}}ii.prototype[ei]="GeometryLoader";const si=Symbol.for("name");class ri extends V{parse(t){const e=[],i=[];for(const s of t.res){const t=this.core.getLoader(s.loader);i.push(t),"string"==typeof s.conf?e.push(t.load(s.conf).then(e=>t.parse(e))):e.push(t.parse(s.conf))}return Promise.all(e).then(t=>{const e=[];for(let s=0;s<t.length;s++)e.push(i[s].conf(t[s]));return Promise.all(e)}).then(()=>{const e=[];let i=null;for(const s of t.ent){i=void 0!==s.owner&&null!==s.owner?e[s.owner]:null;const t=this.core.newEntity(i,s.enable||!0);if(e.push(t),s.name&&(t.name=s.name),s.tags)for(const e of s.tags)t.addTag(e);if(s.comp)for(const e of s.comp){const i=this.core.getCompClassByName(e.type);void 0===e.enable&&(e.enable=!0),this.core.newComp(i,t,e.enable,e.conf)}}})}}ri.prototype[si]="SceneLoader";const ni=new class{constructor(t,e){if(this[n]=document.getElementById(t),this[o]=document.getElementById("app-gl"),this[h]=document.getElementById("app-ui"),this[c]=new Map,this[w]={useEntity:new Set,delEntity:new Set},this[S]=new Map,this[_]=new Map,this[d]=new Map,this[l]=new Map,this[s]=this[o].getContext("webgl",e),null===this[s])throw new Error("Get 3d context is failed");if(this[r]={sd:this[s].getExtension("OES_standard_derivatives"),vao:this[s].getExtension("OES_vertex_array_object"),inst:this[s].getExtension("ANGLE_instanced_arrays")},null===this[r].tf)throw new Error("Extension OES_texture_float not supported");if(null===this[r].sd)throw new Error("Extension OES_standard_derivatives not supported");if(null===this[r].tfa)throw new Error("Extension EXT_texture_filter_anisotropic not supported");if(null===this[r].vao)throw new Error("Extension OES_vertex_array_object not supported");if(null===this[r].inst)throw new Error("Extension ANGLE_instanced_arrays not supported");for(const t in this[r].tfa)this[s][t]=this[r].tfa[t];this[p]=!1,this[L]=!1,this[a]=0,this[u]=(()=>{performance.mark("frs"),this.fireEvent("onStartFrame"),this.fireEvent("onUpdate"),this.fireEvent("onTransform"),this.fireEvent("onPHYUpdate"),this.fireEvent("onLateUpdate"),this.fireEvent("onRender"),this[L]&&(this[E](),this.fireEvent("onModify"),this[C](),this[L]=!1),this[a]=requestAnimationFrame(this[u]),performance.mark("fre"),performance.measure("frame","frs","fre"),performance.clearMarks(),performance.clearMeasures()})}start(){this[a]=requestAnimationFrame(this[u]),this[p]=!0,this.fireEvent("onStart")}stop(){cancelAnimationFrame(this[a]),this[a]=0,this[p]=!1}addRes(t,e,i){this[l].has(t)||this[l].set(t,{});const s=this[l].get(t);if(void 0!==s[e])throw new Error("Resource with this name already used");s[e]=i}getRes(t,e){if(!this[l].has(t))throw new Error("Resource type not found");if(void 0===(N=this[l].get(t)[e]))throw new Error("Resource not found");return N}loadRes(t,e){if(!this[S].has(t))throw new Error("Loader not found");const i=this[S].get(t);return i.load(e).then(t=>i.parse(t).then(t=>i.conf(t)))}parseRes(t,e){if(!this[S].has(t))throw new Error("Loader not found");const i=this[S].get(t);return i.parse(e).then(t=>i.conf(t))}regLoader(t){if(void 0===t[b])throw new Error("Loader not named");if(this[S].has(t))throw new Error("Loader already used");this[S].set(t[b],t)}getLoader(t){if(!this[S].has(t))throw new Error("Loader not found");return this[S].get(t)}regSystem(t){if(void 0===t[b])throw new Error("System not named");if(this[_].has(t[b]))throw new Error("System already used");this[_].set(t[b],t)}getSystem(t){return this[_].get(t)}regEvent(t,e){this[d].has(t)||this[d].set(t,[]),this[d].get(t).push(e)}fireEvent(t){const e=this[d].get(t);if(void 0!==e)for(const i of e)i[t](this)}newEntity(t,e){const i=new O(t,e);return this[w].useEntity.add(i),this[L]=!0,i}delEntity(t){this[w].delEntity.add(t),this[L]=!0}enableEntity(t,e){e?t[p]|=z:t[p]&=~z;for(const i of t[c])this.enableComp(i,e);for(const i of t[y])this.enableEntity(i,e)}getEntity(){return this[w].useEntity}getEntitiesByName(t,e=[]){e.length=0;for(const i of this[w].useEntity)i[b]===t&&e.push(i);return e}newComp(t,e,i,s){const r=this[c].get(t);if(void 0===r)throw new Error("Component class not registered");const n=new t(e,i,s);return r.newComp.add(n),this[L]=!0,n}delComp(t){this[c].get(t.constructor).delComp.add(t),this[L]=!0}enableComp(t,e){e?t[p]|=z:t[p]&=~z,this[c].get(t.constructor).modComp.add(t),this[L]=!0}getComp(t){return this[c].get(t).useComp}getNewComp(t){return this[c].get(t).newComp}getDelComp(t){return this[c].get(t).delComp}getModComp(t){return this[c].get(t).modComp}regComp(t){if(void 0===t[b])throw new Error("Component class not named");if(this[c].has(t))throw new Error("Component class already used");this[c].set(t,{newComp:new Set,useComp:new Set,delComp:new Set,modComp:new Set})}getCompClassByName(t){for(const e of this[c].keys())if(e[b]===t)return e;throw new Error("Component class not found")}get gl(){return this[s]}get ext(){return this[r]}get dom(){return this[n]}get gldom(){return this[o]}get uidom(){return this[h]}[E](){for(const t of this[c].values())for(const e of t.newComp)t.useComp.add(e),e.owner[c].has(e.constructor)||e.owner[c].set(e.constructor,new Set),e.owner[c].get(e.constructor).add(e);for(const t of this[w].delEntity){for(const e of t[c].keys())for(const i of t[c].get(e))this.delComp(i);for(const e of t[y])this.delEntity(e)}}[C](){for(const t of this[w].delEntity)this[w].useEntity.delete(t);this[w].delEntity.clear();for(const t of this[c].values()){for(const e of t.modComp)e[p]&e[g][p]&z?e[p]|=A:e[p]&=~A,e[p]&=~T;for(const e of t.delComp)t.useComp.delete(e),e[g][c].get(e.constructor).delete(e);t.newComp.clear(),t.delComp.clear(),t.modComp.clear()}}}("app",{alpha:!1});ni.regLoader(new Be(ni)),ni.regLoader(new Ye(ni)),ni.regLoader(new je(ni)),ni.regLoader(new Ze(ni)),ni.regLoader(new ii(ni)),ni.regLoader(new ri(ni)),ni.regComp(K),ni.regComp(Q),ni.regComp(nt),ni.regComp(ht),ni.regComp(lt),ni.regComp(ct),ni.regComp(ut),ni.regComp(yt),ni.regComp(wt),ni.regSystem(new class{constructor(t){this[_t]="Time",t.regEvent("onStartFrame",this),this._time=performance.now(),this._currentTime=0,this._deltaTime=0,this._timeScale=1}onStartFrame(){this._deltaTime=Math.max(performance.now()-this._time,1e-5)*this._timeScale*.001,this._time=performance.now(),this._currentTime+=this._deltaTime}get time(){return this._currentTime}get deltaTime(){return this._deltaTime}get timeScale(){return this._timeScale}set timeScale(t){this._timeScale=t}}(ni)),ni.regSystem(new class{constructor(t){this[xt]="Input",t.regEvent("onStartFrame",this),this._up=new Uint32Array(8),this._down=new Uint32Array(8),this._state=new Uint32Array(8),this._pos={x:0,y:0},this._dpos={x:0,y:0},this._aup=new Uint32Array(8),this._adown=new Uint32Array(8),this._astate=new Uint32Array(8),this._apos={x:0,y:0},this._awheel=0,this._pwheel=0,this._dposflag=!0;const e=t.dom;e.setAttribute("tabindex",1),e.addEventListener("keyup",t=>{this.kUp(t)}),e.addEventListener("keydown",t=>{this.kDown(t)}),e.addEventListener("mouseup",t=>{this.mUp(t)}),e.addEventListener("mousedown",t=>{this.mDown(t)}),e.addEventListener("mousemove",t=>{this.mMove(t)}),e.addEventListener("mousewheel",t=>{this.mWheel(t)}),e.addEventListener("touchend",t=>{this.tEnd(t)}),e.addEventListener("touchstart",t=>{this.tStart(t)}),e.addEventListener("touchmove",t=>{this.tMove(t)}),e.addEventListener("contextmenu",t=>{t.preventDefault()})}onStartFrame(){for(let t=0;t<8;t++)this._up[t]=this._aup[t],this._down[t]=this._adown[t],this._state[t]=this._astate[t],this._aup[t]=0,this._adown[t]=0;this._dpos.x=this._dposflag?this._apos.x-this._pos.x:0,this._dpos.y=this._dposflag?this._apos.y-this._pos.y:0,this._pos.x=this._apos.x,this._pos.y=this._apos.y,this._pwheel=this._awheel,this._awheel=0,this._dposflag=!0}asyncDown(t){bt=1<<t%32,Et=Math.floor(t/32),this._adown[Et]|=bt&~this._astate[Et],this._astate[Et]|=bt}asyncUp(t){bt=1<<t%32,Et=Math.floor(t/32),this._aup[Et]|=bt,this._astate[Et]&=~bt}kUp(t){this.asyncUp(t.keyCode)}kDown(t){this.asyncDown(t.keyCode),116!==t.keyCode&&t.preventDefault()}mUp(t){switch(t.button){case 0:t.keyCode=1;break;case 1:t.keyCode=4;break;case 2:t.keyCode=2;break;default:t.keyCode=0}this.asyncUp(t.keyCode)}mDown(t){switch(t.button){case 0:t.keyCode=1;break;case 1:t.keyCode=4;break;case 2:t.keyCode=2;break;default:t.keyCode=0}this.asyncDown(t.keyCode)}mMove(t){this._apos.x=t.clientX,this._apos.y=t.clientY}mWheel(t){this._awheel+=t.wheelDelta/120}tStart(t){this._apos.x=t.changedTouches[0].clientX,this._apos.y=t.changedTouches[0].clientY,this.asyncDown(1),this._dposflag=!1,t.preventDefault()}tEnd(t){this._apos.x=t.changedTouches[0].clientX,this._apos.y=t.changedTouches[0].clientY,this.asyncUp(1)}tMove(t){this._apos.x=t.changedTouches[0].clientX,this._apos.y=t.changedTouches[0].clientY}keyUp(t){return this._up[Math.floor(t/32)]>>t%32&1}keyDown(t){return this._down[Math.floor(t/32)]>>t%32&1}keyState(t){return this._state[Math.floor(t/32)]>>t%32&1}mousePos(){return this._pos}mouseDeltaPos(){return this._dpos}mouseWheel(){return this._pwheel}get VK_LBUTTON(){return 1}get VK_RBUTTON(){return 2}get VK_MBUTTON(){return 4}get VK_XBUTTON1(){return 5}get VK_XBUTTON2(){return 6}get VK_BACK(){return 8}get VK_TAB(){return 9}get VK_ESCAPE(){return 27}get VK_SPACE(){return 32}get VK_PAGEUP(){return 33}get VK_PAGEDOWN(){return 34}get VK_END(){return 35}get VK_HOME(){return 36}get VK_LEFT(){return 37}get VK_UP(){return 38}get VK_RIGHT(){return 39}get VK_DOWN(){return 40}get VK_0(){return 48}get VK_1(){return 49}get VK_2(){return 50}get VK_3(){return 51}get VK_4(){return 52}get VK_5(){return 53}get VK_6(){return 54}get VK_7(){return 55}get VK_8(){return 56}get VK_9(){return 57}get VK_A(){return 65}get VK_B(){return 66}get VK_C(){return 67}get VK_D(){return 68}get VK_E(){return 69}get VK_F(){return 70}get VK_G(){return 71}get VK_H(){return 72}get VK_I(){return 73}get VK_J(){return 74}get VK_K(){return 75}get VK_L(){return 76}get VK_M(){return 77}get VK_N(){return 78}get VK_O(){return 79}get VK_P(){return 80}get VK_Q(){return 81}get VK_R(){return 82}get VK_S(){return 83}get VK_T(){return 84}get VK_U(){return 85}get VK_V(){return 86}get VK_W(){return 87}get VK_X(){return 88}get VK_Y(){return 89}get VK_Z(){return 90}get VK_N0(){return 96}get VK_N1(){return 97}get VK_N2(){return 98}get VK_N3(){return 99}get VK_N4(){return 100}get VK_N5(){return 101}get VK_N6(){return 102}get VK_N7(){return 103}get VK_N8(){return 104}get VK_N9(){return 105}get VK_F1(){return 112}get VK_F2(){return 113}get VK_F3(){return 114}get VK_F4(){return 115}get VK_F5(){return 116}get VK_F6(){return 117}get VK_F7(){return 118}get VK_F8(){return 119}get VK_F9(){return 120}get VK_F10(){return 121}get VK_F11(){return 122}get VK_F12(){return 123}get VK_F13(){return 124}get VK_F14(){return 125}get VK_F15(){return 126}get VK_F16(){return 127}get VK_F17(){return 128}get VK_F18(){return 129}get VK_F19(){return 130}get VK_F20(){return 131}get VK_F21(){return 132}get VK_F22(){return 133}get VK_F23(){return 134}get VK_F24(){return 135}}(ni)),ni.regSystem(new class{constructor(t){this[Ct]="Screen",t.regEvent("onStartFrame",this),this.curWidth=1,this.curHeight=1,this.newWidth=1,this.newHeight=1,this.onscreen=!1,this.pr=window.devicePixelRatio||1}onStartFrame(t){performance.mark("screens"),this.newWidth=t.dom.clientWidth*this.pr,this.newHeight=t.dom.clientHeight*this.pr,this.onscreen=!1,this.curWidth!==this.newWidth&&(this.curWidth=this.newWidth,this.onscreen=!0),this.curHeight!==this.newHeight&&(this.curHeight=this.newHeight,this.onscreen=!0),this.onscreen&&t.fireEvent("onScreen"),performance.mark("screene"),performance.measure("screen","screens","screene")}get width(){return this.curWidth}get height(){return this.curHeight}get widthNPR(){return this.curWidth/this.pr}get heightNPR(){return this.curHeight/this.pr}}(ni)),ni.regSystem(new class{constructor(t){this[Vt]="Render",t.regEvent("onStart",this),t.regEvent("onScreen",this),t.regEvent("onRender",this),t.regEvent("onModify",this),this.camera=null,this.envMesh=null,this.batches=new Tt,this.bid=0,this.ibo=null,this.ibuf=new Float32Array(12*Ut);for(let t=0;t<this.ibuf.length;t++)t%12==0&&(this.ibuf[t]=1),t%12==4&&(this.ibuf[t]=1),t%12==8&&(this.ibuf[t]=1);console.log(this.batches)}onStart(t){(Ot=t.gl).clearColor(.7,.65,.6,1),this.ibo=Ot.createBuffer(),Ot.bindBuffer(Ot.ARRAY_BUFFER,this.ibo),Ot.bufferData(Ot.ARRAY_BUFFER,48*Ut,Ot.STREAM_DRAW)}onScreen(t){Pt=t.getSystem("Screen"),t.gl.viewport(0,0,Pt.width,Pt.height),t.gldom.width=Pt.width,t.gldom.height=Pt.height}onRender(t){if(performance.mark("rnds"),t.gl.clear(t.gl.COLOR_BUFFER_BIT|t.gl.DEPTH_BUFFER_BIT),this.camera){this.envMesh&&((Kt=t.getRes("material",this.envMesh.material)).use(t),t.getRes("geometry",this.envMesh.geometry).use(t,Kt.shader));for(const e of t.getComp(K))e.disable||(kt=e.owner.getCompOne(yt),-1===e.iid?((Kt=t.getRes("material",e.material)).use(t),Kt.shader.setUniform(t,"PM",this.camera.pmat),Kt.shader.setUniform(t,"WM",this.camera.wmat),Kt.shader.setUniform(t,"OM",kt.wmat),t.getRes("geometry",e.geometry).use(t,Kt.shader)):(this.ibuf[12*e.iid+0]=kt.wmat[0],this.ibuf[12*e.iid+1]=kt.wmat[1],this.ibuf[12*e.iid+2]=kt.wmat[2],this.ibuf[12*e.iid+3]=kt.wmat[4],this.ibuf[12*e.iid+4]=kt.wmat[5],this.ibuf[12*e.iid+5]=kt.wmat[6],this.ibuf[12*e.iid+6]=kt.wmat[8],this.ibuf[12*e.iid+7]=kt.wmat[9],this.ibuf[12*e.iid+8]=kt.wmat[10],this.ibuf[12*e.iid+9]=kt.wmat[12],this.ibuf[12*e.iid+10]=kt.wmat[13],this.ibuf[12*e.iid+11]=kt.wmat[14]));for((Ot=t.gl).bindBuffer(Ot.ARRAY_BUFFER,this.ibo),Ot.bufferSubData(Ot.ARRAY_BUFFER,0,this.ibuf),this.batches.start();this.batches.next(It);)It.value.draw(t,this.camera)}performance.mark("rnde"),performance.measure("render","rnds","rnde")}onModify(t){for(const e of t.getNewComp(Q))this.camera=e,Pt=t.getSystem("Screen"),this.camera.aspect=Pt.width/Pt.height,this.envMesh=e.owner.getCompOne(K);for(const e of t.getNewComp(K))(Kt=t.getRes("material",e.material)).batch&&(Ft=t.getRes("geometry",e.geometry),(Nt=this.batches.get(e.material,e.geometry))||(Nt=new Mt(t,Kt,Ft,this.ibo,this.bid),this.bid++,this.batches.set(e.material,e.geometry,Nt)),e.iid=Nt.add())}setMainCamera(t){this.camera=t}}(ni)),ni.regSystem(new class{constructor(t){this[Dt]="Rotation",t.regEvent("onUpdate",this)}onUpdate(t){for(const e of t.getComp(ht))e.disable||(Bt=e.owner.getCompOne(yt),Wt.fromAxisAngle(e.axis,e.angle),Bt.orientation.premul(Wt))}}(ni)),ni.regSystem(new class{constructor(t){this[Gt]="Movement",t.regEvent("onStart",this),t.regEvent("onUpdate",this),this.limearSpeed=new st}onStart(t){this.time=t.getSystem("Time")}onUpdate(t){for(const e of t.getComp(nt))e.disable||(Ht=e.owner.getCompOne(yt),e.linear&&null===e.owner.owner&&Ht.position.addScaledVec(this.limearSpeed,this.time.deltaTime),Ht.position.addScaledVec(e.direction,this.time.deltaTime*e.speed))}}(ni)),ni.regSystem(new class{constructor(t){this[Yt]="OrbitControl",t.regEvent("onStart",this),t.regEvent("onScreen",this),t.regEvent("onLateUpdate",this),this.count=0,this.screen=null}onStart(t){this.screen=t.getSystem("Screen"),this.input=t.getSystem("Input")}onScreen(t){for(const e of t.getComp(wt))e.disable||((jt=e.owner.getCompOne(Q)).aspect=this.screen.width/this.screen.height,jt.pmat.perspective(jt.fov,jt.aspect,jt.near,jt.far))}onLateUpdate(t){Xt=this.input;for(const e of t.getComp(wt))e.disable||(qt=e.owner.getCompOne(yt),jt=e.owner.getCompOne(Q),Xt.keyState(Xt.VK_LBUTTON)?(e.pfrozen||(e.polar-=Xt.mouseDeltaPos().y*e.speed),e.afrozen||(e.azimuthal-=Xt.mouseDeltaPos().x*e.speed),jt.wmat.orbit(e.polar,e.azimuthal,e.distance,qt.position)):Xt.mouseWheel()?(e.dfrozen||(e.distance-=Xt.mouseWheel()*e.speed*100),jt.wmat.orbit(e.polar,e.azimuthal,e.distance,qt.position)):e.nupd&&(e.nupd=!1,jt.wmat.orbit(e.polar,e.azimuthal,e.distance,qt.position),jt.aspect=this.screen.width/this.screen.height,jt.pmat.perspective(jt.fov,jt.aspect,jt.near,jt.far)))}}(ni)),ni.regSystem(new class{constructor(t){this[Jt]="Transform",t.regEvent("onTransform",this),t.regEvent("onModify",this)}onTransform(t){performance.mark("trfs");for(const e of t.getEntity())0===e.depth&&this.calcTransform(e);performance.mark("trfe"),performance.measure("transform","trfs","trfe")}onModify(t){for(const e of t.getNewComp(yt))this.calcTransform(e.owner)}calcTransform(t){(Zt=t.getCompOne(yt))&&(Zt.lmat.fromTRS(Zt.position,Zt.orientation,Zt.scale),Zt.wmat.copy(Zt.lmat),t.owner&&(Qt=t.owner.getCompOne(yt),Zt.wmat.mul(Qt.wmat)));for(const e of t.child)this.calcTransform(e)}}(ni)),ni.regSystem(new class{constructor(t){this[$t]="Trigger",t.regEvent("onStart",this),t.regEvent("onPHYUpdate",this)}onStart(){this.tree=new re(ne-he,oe-he,ne+he,oe+he,0,ae)}onPHYUpdate(t){performance.mark("trs"),this.tree.clear();for(const e of t.getComp(ct))e.inner.length=0,e.owner.getCompOne(yt).worldPosition(e.pos).add(e.offset),this.tree.adds(e,e.pos.x,e.pos.z,e.radius);for(const e of t.getComp(lt))e.inner.length=0,e.owner.getCompOne(yt).worldPosition(e.pos).add(e.offset),this.tree.adda(e,e.pos.x,e.pos.z,e.size);this.tree.test(),performance.mark("tre"),performance.measure("trigger","trs","tre")}}(ni)),ni.regSystem(new class{constructor(t){this[ze]="Game",t.regEvent("onStart",this),t.regEvent("onUpdate",this),t.regEvent("onLateUpdate",this),this.state=0,this.count=0,this.airplane=null,this.transform=null,this.speed=500,this.xmove=0,this.uibg=document.getElementById("app-ui-bg"),this.uimul=document.getElementById("app-ui-mul"),this.uiscore=document.getElementById("app-ui-score"),this.uiresult=document.getElementById("app-ui-result"),this.mul=1,this.score=0,this.scoredt=0,console.log(t)}onStart(t){this.time=t.getSystem("Time"),this.input=t.getSystem("Input"),this.screen=t.getSystem("Screen"),this.movement=t.getSystem("Movement"),[this.airplane]=t.getEntitiesByName("airplane"),[this.camera]=t.getEntitiesByName("player"),[this.g1]=t.getEntitiesByName("ground1"),[this.g2]=t.getEntitiesByName("ground2"),[this.g3]=t.getEntitiesByName("ground3"),[this.g4]=t.getEntitiesByName("ground4"),this.barrier=new Array(Ue),this.createBarrier(t),this.time.timeScale=0,setTimeout(()=>{const e=document.getElementById("app-ui-start");e.innerHTML="START",e.addEventListener("click",()=>{this.uibg.style.display="none",this.time.timeScale=1,this.state=1,this.start(t)}),e.addEventListener("touchstart",()=>{this.uibg.style.display="none",this.time.timeScale=1,this.state=1,this.start(t)})},1e3)}onUpdate(){0!==this.state&&(this.input.keyState(this.input.VK_SPACE)?(this.mul=2,this.speed=0,this.uimul.innerHTML="x2"):(this.mul=1,this.speed=500,this.uimul.innerHTML=null),this.score+=this.time.deltaTime*this.mul*10,this.scoredt+=this.time.deltaTime,this.scoredt>=Ne&&(this.scoredt=0,this.uiscore.innerText="".concat(Math.ceil(this.score))),this.state&&(this.move(),this.updateBarrier()))}onLateUpdate(){this.state&&(Me=this.airplane.getCompOne(ct))&&Me.inner.length>0&&this.state&&(this.time.timeScale=0,this.state=0,setTimeout(()=>{this.uiresult.innerHTML="".concat(Math.ceil(this.score)),this.uibg.style.display="block"},1e3))}move(){1===this.state?this.movement.limearSpeed.z=-this.speed:this.movement.limearSpeed.z=0,(Me=this.g1.getCompOne(yt))&&Me.position.z<-510&&(Me.position.z+=4e3),(Me=this.g2.getCompOne(yt))&&Me.position.z<-510&&(Me.position.z+=4e3),(Me=this.g3.getCompOne(yt))&&Me.position.z<-510&&(Me.position.z+=4e3),(Me=this.g4.getCompOne(yt))&&Me.position.z<-510&&(Me.position.z+=4e3),(Me=this.airplane.getCompOne(yt))&&(Re=0,this.input.keyState(this.input.VK_LEFT)&&(Re+=.5),this.input.keyState(this.input.VK_RIGHT)&&(Re-=.5),this.input.keyState(this.input.VK_LBUTTON)&&(this.input.mousePos().x>.5*this.screen.widthNPR?Re-=.5:Re+=.5),Re>0?(this.xmove+=.05,this.xmove>Oe&&(this.xmove=Oe)):Re<0?(this.xmove-=.05,this.xmove<-Oe&&(this.xmove=-Oe)):this.xmove>0?(this.xmove-=.05,this.xmove<0&&(this.xmove=0)):this.xmove<0&&(this.xmove+=.05,this.xmove>0&&(this.xmove=0)),Me.orientation.fromAxisAngle(Ve,this.xmove),Me.position.x-=2*this.xmove,Me.position.x<-212&&(Me.position.x=-212),Me.position.x>216&&(Me.position.x=216)),(Me=this.camera.getCompOne(yt))&&(Me.position.x-=2*this.xmove,Me.position.x<-212&&(Me.position.x=-212),Me.position.x>216&&(Me.position.x=216)),(Me=this.camera.getCompOne(wt))&&(Me.nupd=!0)}start(){this.score=0,this.uiscore.innerText="0",this.xmove=0,this.startMoveBarrier()}createBarrier(t){for(Te=0;Te<Ue;Te++)Pe.x=440*(Math.random()-.5),Pe.y=0,Pe.z=3e3+2e3*Math.random(),Te<50?ye(t,this.barrier,Te,Pe):Te<62?fe(t,this.barrier,Te,Pe):Te<74?we(t,this.barrier,Te,Pe):Te<86?_e(t,this.barrier,Te,Pe):Te<98?xe(t,this.barrier,Te,Pe):Te<110?be(t,this.barrier,Te,Pe):Te<113?Ee(t,this.barrier,Te,Pe):Te<116?Ce(t,this.barrier,Te,Pe):Te<119?Le(t,this.barrier,Te,Pe):Te<122?Se(t,this.barrier,Te,Pe):Te<125?ve(t,this.barrier,Te,Pe):Ae(t,this.barrier,Te,Pe)}updateBarrier(){for(Te=0;Te<Ue;Te++)this.barrier[Te]&&(Me=this.barrier[Te].getCompOne(yt))&&Me.position.z<-20&&(Pe.x=440*(Math.random()-.5),Pe.y=0,Pe.z=3e3+2e3*Math.random(),Te<50?de(this.barrier,Te,Pe):Te<125?pe(this.barrier,Te,Pe):ge(this.barrier,Te,Pe))}startMoveBarrier(){for(Te=0;Te<Ue;Te++)this.barrier[Te]&&(Me=this.barrier[Te].getCompOne(yt))&&(Pe.x=440*(Math.random()-.5),Pe.y=0,Pe.z=3e3+2e3*Math.random(),Te<50?de(this.barrier,Te,Pe):Te<125?pe(this.barrier,Te,Pe):ge(this.barrier,Te,Pe))}}(ni)),ni.loadRes("SceneLoader","./res/scene.json").then(()=>{ni.start()})}]);
//# sourceMappingURL=app.js.map